import { __decorate } from "tslib";
import { Component, Input, ContentChildren, ViewChild, HostBinding, EventEmitter, Output } from '@angular/core';
import { ListItemComponent } from './list-item.component';
import { CheckboxComponent } from '../checkbox/checkbox.component';
var ListComponent = /** @class */ (function () {
    function ListComponent() {
        this._selectedItem = null;
        this.selectedItemChange = new EventEmitter();
        this.selectHeader = null;
        this.updateEvent = new EventEmitter();
    }
    Object.defineProperty(ListComponent.prototype, "selectedItem", {
        get: function () {
            return this._selectedItem;
        },
        set: function (value) {
            if (value !== this._selectedItem) {
                this._selectedItem = value;
                this.selectOne(value);
                this.selectedItemChange.emit(value);
            }
        },
        enumerable: true,
        configurable: true
    });
    ListComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.childItemsComponent.changes.subscribe({
            next: function (elements) {
                _this.childItemsComponent.forEach(function (element) {
                    element.updateEvent.subscribe(function (event) {
                        if (!_this.multiSelect) {
                            _this.selectOne(element);
                            _this.updateEvent.emit(element);
                        }
                        else {
                            _this.selectMore(element);
                            _this.updateEvent.next(_this.childItemsComponent.filter(function (i) { return i.selected; }));
                        }
                    });
                    if (_this.multiSelect) {
                        //setTimeout used to avoid value changed after check error
                        setTimeout(function () {
                            element.multiSelect = true;
                        });
                    }
                });
            }
        });
        //setTimeout used to avoid value changed after check error
        setTimeout(function () {
            if (!_this.id) {
                _this.id = Math.random()
                    .toString(36)
                    .substring(2);
            }
        });
        this.childItemsComponent.forEach(function (element) {
            element.updateEvent.subscribe(function (event) {
                if (!_this.multiSelect) {
                    _this.selectOne(element);
                    _this.updateEvent.emit(element);
                }
                else {
                    _this.selectMore(element);
                    _this.updateEvent.next(_this.childItemsComponent.filter(function (i) { return i.selected; }));
                }
            });
            if (_this.multiSelect) {
                //setTimeout used to avoid value changed after check error
                setTimeout(function () {
                    element.multiSelect = true;
                });
            }
        });
        if (this.multiSelect) {
            this.selectMore(null);
        }
    };
    ListComponent.prototype.selectOne = function (selectItem) {
        var _this = this;
        if (!this.childItemsComponent) {
            return;
        }
        this.childItemsComponent.forEach(function (element) {
            element.selected = element === selectItem;
            if (element.selected) {
                _this.selectedItem = element;
            }
        });
    };
    ListComponent.prototype.selectMore = function (selectedItem) {
        var selectAll = true;
        var unselectAll = true;
        this.childItemsComponent.forEach(function (element) {
            if (element === selectedItem) {
                element.selected = !element.selected;
            }
            if (element.selected) {
                selectAll = true && selectAll;
                unselectAll = false;
            }
            else {
                selectAll = false;
                unselectAll = true && unselectAll;
            }
        });
        this.selectHeader = selectAll ? "checked" /* checked */ : unselectAll ? null : "indeterminate" /* indeterminate */;
    };
    ListComponent.prototype.headerChange = function (event) {
        this.childItemsComponent.forEach(function (element) {
            element.selected = event.checked === 'checked';
        });
        this.updateEvent.next(this.childItemsComponent.filter(function (i) { return i.selected; }));
    };
    ListComponent.prototype.sort = function (event) {
        var _this = this;
        //ignore clicks on checkbox
        if (event.target !== this.header.nativeElement) {
            return;
        }
        if (this.sortingOrder == null) {
            this.sortingOrder = false;
        }
        this.sortingOrder = !this.sortingOrder;
        var sort = function (a, b) {
            var aText = a.label;
            var bText = b.label;
            var pureOrder = aText > bText;
            return pureOrder === _this.sortingOrder ? 1 : -1;
        };
        var newArray = this.childItemsComponent.toArray().sort(sort);
        newArray.forEach(function (item, index) {
            item.order = index.toString();
        });
    };
    ListComponent.prototype.ngOnDestroy = function () {
        this.childItemsComponent.forEach(function (element) {
            element.updateEvent.unsubscribe();
        });
    };
    __decorate([
        ViewChild(CheckboxComponent)
    ], ListComponent.prototype, "input", void 0);
    __decorate([
        ViewChild('items')
    ], ListComponent.prototype, "items", void 0);
    __decorate([
        ViewChild('header')
    ], ListComponent.prototype, "header", void 0);
    __decorate([
        ViewChild('headerCheckbox')
    ], ListComponent.prototype, "headerCheckbox", void 0);
    __decorate([
        HostBinding('attr.id'),
        Input()
    ], ListComponent.prototype, "id", void 0);
    __decorate([
        Input()
    ], ListComponent.prototype, "disabled", void 0);
    __decorate([
        Input()
    ], ListComponent.prototype, "label", void 0);
    __decorate([
        Input()
    ], ListComponent.prototype, "multiSelect", void 0);
    __decorate([
        ContentChildren(ListItemComponent)
    ], ListComponent.prototype, "childItemsComponent", void 0);
    __decorate([
        Input()
    ], ListComponent.prototype, "selectedItem", null);
    __decorate([
        Output()
    ], ListComponent.prototype, "selectedItemChange", void 0);
    __decorate([
        Output()
    ], ListComponent.prototype, "updateEvent", void 0);
    ListComponent = __decorate([
        Component({
            selector: 'bmw-list',
            template: "<div class=\"wrapper\" [class.disabled]=\"disabled\">\n  <div\n    class=\"header bmw-table-headline-text\"\n    [class.selectable]=\"multiSelect\"\n    [class.disabled]=\"disabled\"\n    (click)=\"sort($event)\"\n    [class.descending]=\"sortingOrder\"\n    [class.non-sorted]=\"sortingOrder == null\"\n    *ngIf=\"label\"\n    #header\n  >\n    <div class=\"separator\" *ngIf=\"multiSelect\"></div>\n    <bmw-checkbox\n      *ngIf=\"multiSelect\"\n      (updateEvent)=\"headerChange($event)\"\n      [checked]=\"selectHeader\"\n      #headerCheckbox\n    ></bmw-checkbox>\n    {{ label }}\n  </div>\n  <div class=\"items\" [class.disabled]=\"disabled\" #items>\n    <ng-content select=\"bmw-list-item\"></ng-content>\n  </div>\n</div>\n",
            styles: [":host .wrapper{display:inline-block;min-width:186px;max-width:100%}:host .wrapper .header{padding:var(--list__header__padding);padding-right:calc(2 * var(--list__header__padding) + var(--list__icon__height));position:relative;background-color:var(--list__default__background-color);color:var(--list__default__color);text-overflow:ellipsis;white-space:nowrap;overflow:hidden;cursor:pointer}:host .wrapper .header ::ng-deep label{cursor:inherit}:host .wrapper .header ::ng-deep label div{height:var(--checkbox__default__height)}:host .wrapper .header.selectable{padding-left:var(--list__header__selectable__padding-left)}:host .wrapper .header.selectable ::ng-deep bmw-checkbox{position:absolute;top:calc((var(--list__header__line-height) - var(--checkbox__default__height))/ 2 + var(--list__header__padding));left:var(--list__header__padding)}:host .wrapper .header::after{position:absolute;top:var(--list__header__padding);right:var(--list__header__padding);content:' ';width:var(--list__icon__height);height:var(--list__icon__height);background-color:var(--list__default__color);background:url(\"data:image/svg+xml;utf8,<svg viewBox='0 0 20 18' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><style>polygon.ic_arrow_stepper_up { fill: rgb(68, 68, 68); }</style> <title>Stepper Up</title> <polygon class='ic_arrow_stepper_up' points='10 3 19 17.5 1 17.5'></polygon></svg>\") no-repeat!important}:host .wrapper .header.non-sorted::after{opacity:.5}:host .wrapper .header.descending::after{background:url(\"data:image/svg+xml;utf8,<svg viewBox='0 0 20 18' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><style>polygon.ic_arrow_stepper_down { fill: rgb(68, 68, 68); }</style> <title>Stepper Up</title><polygon class='ic_arrow_stepper_down' points='10 17.5 19 3 1 3'></polygon></svg>\") no-repeat!important}:host .wrapper .header .separator{position:absolute;top:0;left:0;height:100%;width:calc(var(--list__icon__height) + 2 * var(--list__header__padding));border-right:1px solid #a3a3a3}:host .wrapper .header:hover{background-color:var(--list__hover__background-color)}:host .wrapper .header.disabled{opacity:.5;pointer-events:none}:host .wrapper.disabled{cursor:no-drop}:host .wrapper .items{display:flex;flex-flow:column}:host .wrapper .items.small{flex:1 1 auto}:host .wrapper .items.disabled{opacity:.5;pointer-events:none}"]
        })
    ], ListComponent);
    return ListComponent;
}());
export { ListComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYm13LWRzL2NvbXBvbmVudHMvIiwic291cmNlcyI6WyJsaXN0L2xpc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFFTCxlQUFlLEVBRWYsU0FBUyxFQUdULFdBQVcsRUFDWCxZQUFZLEVBQ1osTUFBTSxFQUVQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTFELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBT25FO0lBQUE7UUF1Q1Usa0JBQWEsR0FBc0IsSUFBSSxDQUFDO1FBR2hELHVCQUFrQixHQUFHLElBQUksWUFBWSxFQUFxQixDQUFDO1FBRTNELGlCQUFZLEdBQWtCLElBQUksQ0FBQztRQUluQyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUEyQyxDQUFDO0lBNkg1RSxDQUFDO0lBbEpDLHNCQUFJLHVDQUFZO2FBQWhCO1lBQ0UsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQzVCLENBQUM7YUFFRCxVQUFpQixLQUF3QjtZQUN2QyxJQUFJLEtBQUssS0FBSyxJQUFJLENBQUMsYUFBYSxFQUFFO2dCQUNoQyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztnQkFDM0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNyQztRQUNILENBQUM7OztPQVJBO0lBcUJELHVDQUFlLEdBQWY7UUFBQSxpQkFzREM7UUFyREMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7WUFDekMsSUFBSSxFQUFFLFVBQUEsUUFBUTtnQkFDWixLQUFJLENBQUMsbUJBQW1CLENBQUMsT0FB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QUFTLENBQUM7UUFDdEIsS0FBSyxFQUFFOzZDQUNHO0lBR1g7UUFEQyxLQUFLLEVBQUU7bURBQ1U7SUFHbEI7UUFEQyxLQUFLLEVBQUU7Z0RBQ007SUFHZDtRQURDLEtBQUssRUFBRTtzREFDYTtJQUdyQjtRQURDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQzs4REFDZTtJQUdsRDtRQURDLEtBQUssRUFBRTtxREFHUDtJQWFEO1FBREMsTUFBTSxFQUFFOzZEQUNrRDtJQU0zRDtRQURDLE1BQU0sRUFBRTtzREFDaUU7SUFoRC9ELGFBQWE7UUFMekIsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLFVBQVU7WUFDcEIsOHVCQUFvQzs7U0FFckMsQ0FBQztPQUNXLGFBQWEsQ0E2S3pCO0lBQUQsb0JBQUM7Q0FBQSxBQTdLRCxJQTZLQztTQTdLWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBRdWVyeUxpc3QsXG4gIFZpZXdDaGlsZCxcbiAgRWxlbWVudFJlZixcbiAgT25EZXN0cm95LFxuICBIb3N0QmluZGluZyxcbiAgRXZlbnRFbWl0dGVyLFxuICBPdXRwdXQsXG4gIENvbnRlbnRDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IExpc3RJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi9saXN0LWl0ZW0uY29tcG9uZW50JztcbmltcG9ydCB7IENoZWNrYm94U3RhdGUgfSBmcm9tICcuLi9jaGVja2JveC9jaGVja2JveC5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ2hlY2tib3hDb21wb25lbnQgfSBmcm9tICcuLi9jaGVja2JveC9jaGVja2JveC5jb21wb25lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdibXctbGlzdCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9saXN0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbGlzdC5jb21wb25lbnQubGVzcyddXG59KVxuZXhwb3J0IGNsYXNzIExpc3RDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICBAVmlld0NoaWxkKENoZWNrYm94Q29tcG9uZW50KVxuICBpbnB1dDogQ2hlY2tib3hDb21wb25lbnQ7XG4gIEBWaWV3Q2hpbGQoJ2l0ZW1zJylcbiAgaXRlbXM6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ2hlYWRlcicpXG4gIGhlYWRlcjogRWxlbWVudFJlZjtcbiAgQFZpZXdDaGlsZCgnaGVhZGVyQ2hlY2tib3gnKVxuICBoZWFkZXJDaGVja2JveDogRWxlbWVudFJlZjtcblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuaWQnKVxuICBASW5wdXQoKVxuICBpZDogc3RyaW5nO1xuXG4gIEBJbnB1dCgpXG4gIGRpc2FibGVkOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpXG4gIGxhYmVsOiBzdHJpbmc7XG5cbiAgQElucHV0KClcbiAgbXVsdGlTZWxlY3Q6IGJvb2xlYW47XG5cbiAgQENvbnRlbnRDaGlsZHJlbihMaXN0SXRlbUNvbXBvbmVudClcbiAgY2hpbGRJdGVtc0NvbXBvbmVudDogUXVlcnlMaXN0PExpc3RJdGVtQ29tcG9uZW50PjtcblxuICBASW5wdXQoKVxuICBnZXQgc2VsZWN0ZWRJdGVtKCk6IExpc3RJdGVtQ29tcG9uZW50IHtcbiAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRJdGVtO1xuICB9XG5cbiAgc2V0IHNlbGVjdGVkSXRlbSh2YWx1ZTogTGlzdEl0ZW1Db21wb25lbnQpIHtcbiAgICBpZiAodmFsdWUgIT09IHRoaXMuX3NlbGVjdGVkSXRlbSkge1xuICAgICAgdGhpcy5fc2VsZWN0ZWRJdGVtID0gdmFsdWU7XG4gICAgICB0aGlzLnNlbGVjdE9uZSh2YWx1ZSk7XG4gICAgICB0aGlzLnNlbGVjdGVkSXRlbUNoYW5nZS5lbWl0KHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9zZWxlY3RlZEl0ZW06IExpc3RJdGVtQ29tcG9uZW50ID0gbnVsbDtcblxuICBAT3V0cHV0KClcbiAgc2VsZWN0ZWRJdGVtQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxMaXN0SXRlbUNvbXBvbmVudD4oKTtcblxuICBzZWxlY3RIZWFkZXI6IENoZWNrYm94U3RhdGUgPSBudWxsO1xuICBzb3J0aW5nT3JkZXI6IGJvb2xlYW47XG5cbiAgQE91dHB1dCgpXG4gIHVwZGF0ZUV2ZW50ID0gbmV3IEV2ZW50RW1pdHRlcjxMaXN0SXRlbUNvbXBvbmVudFtdIHwgTGlzdEl0ZW1Db21wb25lbnQ+KCk7XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuY2hpbGRJdGVtc0NvbXBvbmVudC5jaGFuZ2VzLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiBlbGVtZW50cyA9PiB7XG4gICAgICAgIHRoaXMuY2hpbGRJdGVtc0NvbXBvbmVudC5mb3JFYWNoKChlbGVtZW50OiBhbnkpID0+IHtcbiAgICAgICAgICBlbGVtZW50LnVwZGF0ZUV2ZW50LnN1YnNjcmliZSgoZXZlbnQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5tdWx0aVNlbGVjdCkge1xuICAgICAgICAgICAgICB0aGlzLnNlbGVjdE9uZShlbGVtZW50KTtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVFdmVudC5lbWl0KGVsZW1lbnQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5zZWxlY3RNb3JlKGVsZW1lbnQpO1xuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUV2ZW50Lm5leHQodGhpcy5jaGlsZEl0ZW1zQ29tcG9uZW50LmZpbHRlcihpID0+IGkuc2VsZWN0ZWQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGlmICh0aGlzLm11bHRpU2VsZWN0KSB7XG4gICAgICAgICAgICAvL3NldFRpbWVvdXQgdXNlZCB0byBhdm9pZCB2YWx1ZSBjaGFuZ2VkIGFmdGVyIGNoZWNrIGVycm9yXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgZWxlbWVudC5tdWx0aVNlbGVjdCA9IHRydWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy9zZXRUaW1lb3V0IHVzZWQgdG8gYXZvaWQgdmFsdWUgY2hhbmdlZCBhZnRlciBjaGVjayBlcnJvclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmlkKSB7XG4gICAgICAgIHRoaXMuaWQgPSBNYXRoLnJhbmRvbSgpXG4gICAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAgIC5zdWJzdHJpbmcoMik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmNoaWxkSXRlbXNDb21wb25lbnQuZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XG4gICAgICBlbGVtZW50LnVwZGF0ZUV2ZW50LnN1YnNjcmliZSgoZXZlbnQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLm11bHRpU2VsZWN0KSB7XG4gICAgICAgICAgdGhpcy5zZWxlY3RPbmUoZWxlbWVudCk7XG4gICAgICAgICAgdGhpcy51cGRhdGVFdmVudC5lbWl0KGVsZW1lbnQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuc2VsZWN0TW9yZShlbGVtZW50KTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUV2ZW50Lm5leHQodGhpcy5jaGlsZEl0ZW1zQ29tcG9uZW50LmZpbHRlcihpID0+IGkuc2VsZWN0ZWQpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGlmICh0aGlzLm11bHRpU2VsZWN0KSB7XG4gICAgICAgIC8vc2V0VGltZW91dCB1c2VkIHRvIGF2b2lkIHZhbHVlIGNoYW5nZWQgYWZ0ZXIgY2hlY2sgZXJyb3JcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgZWxlbWVudC5tdWx0aVNlbGVjdCA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmICh0aGlzLm11bHRpU2VsZWN0KSB7XG4gICAgICB0aGlzLnNlbGVjdE1vcmUobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgc2VsZWN0T25lKHNlbGVjdEl0ZW06IExpc3RJdGVtQ29tcG9uZW50KSB7XG4gICAgaWYgKCF0aGlzLmNoaWxkSXRlbXNDb21wb25lbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5jaGlsZEl0ZW1zQ29tcG9uZW50LmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICBlbGVtZW50LnNlbGVjdGVkID0gZWxlbWVudCA9PT0gc2VsZWN0SXRlbTtcbiAgICAgIGlmIChlbGVtZW50LnNlbGVjdGVkKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRJdGVtID0gZWxlbWVudDtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHNlbGVjdE1vcmUoc2VsZWN0ZWRJdGVtOiBMaXN0SXRlbUNvbXBvbmVudCkge1xuICAgIGxldCBzZWxlY3RBbGwgPSB0cnVlO1xuICAgIGxldCB1bnNlbGVjdEFsbCA9IHRydWU7XG4gICAgdGhpcy5jaGlsZEl0ZW1zQ29tcG9uZW50LmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICBpZiAoZWxlbWVudCA9PT0gc2VsZWN0ZWRJdGVtKSB7XG4gICAgICAgIGVsZW1lbnQuc2VsZWN0ZWQgPSAhZWxlbWVudC5zZWxlY3RlZDtcbiAgICAgIH1cbiAgICAgIGlmIChlbGVtZW50LnNlbGVjdGVkKSB7XG4gICAgICAgIHNlbGVjdEFsbCA9IHRydWUgJiYgc2VsZWN0QWxsO1xuICAgICAgICB1bnNlbGVjdEFsbCA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2VsZWN0QWxsID0gZmFsc2U7XG4gICAgICAgIHVuc2VsZWN0QWxsID0gdHJ1ZSAmJiB1bnNlbGVjdEFsbDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuc2VsZWN0SGVhZGVyID0gc2VsZWN0QWxsID8gQ2hlY2tib3hTdGF0ZS5jaGVja2VkIDogdW5zZWxlY3RBbGwgPyBudWxsIDogQ2hlY2tib3hTdGF0ZS5pbmRldGVybWluYXRlO1xuICB9XG5cbiAgaGVhZGVyQ2hhbmdlKGV2ZW50OiBDaGVja2JveENvbXBvbmVudCkge1xuICAgIHRoaXMuY2hpbGRJdGVtc0NvbXBvbmVudC5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgZWxlbWVudC5zZWxlY3RlZCA9IGV2ZW50LmNoZWNrZWQgPT09ICdjaGVja2VkJztcbiAgICB9KTtcbiAgICB0aGlzLnVwZGF0ZUV2ZW50Lm5leHQodGhpcy5jaGlsZEl0ZW1zQ29tcG9uZW50LmZpbHRlcihpID0+IGkuc2VsZWN0ZWQpKTtcbiAgfVxuXG4gIHNvcnQoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAvL2lnbm9yZSBjbGlja3Mgb24gY2hlY2tib3hcbiAgICBpZiAoZXZlbnQudGFyZ2V0ICE9PSB0aGlzLmhlYWRlci5uYXRpdmVFbGVtZW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc29ydGluZ09yZGVyID09IG51bGwpIHtcbiAgICAgIHRoaXMuc29ydGluZ09yZGVyID0gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuc29ydGluZ09yZGVyID0gIXRoaXMuc29ydGluZ09yZGVyO1xuXG4gICAgY29uc3Qgc29ydCA9IChhOiBMaXN0SXRlbUNvbXBvbmVudCwgYjogTGlzdEl0ZW1Db21wb25lbnQpID0+IHtcbiAgICAgIGNvbnN0IGFUZXh0ID0gYS5sYWJlbDtcbiAgICAgIGNvbnN0IGJUZXh0ID0gYi5sYWJlbDtcbiAgICAgIGNvbnN0IHB1cmVPcmRlciA9IGFUZXh0ID4gYlRleHQ7XG4gICAgICByZXR1cm4gcHVyZU9yZGVyID09PSB0aGlzLnNvcnRpbmdPcmRlciA/IDEgOiAtMTtcbiAgICB9O1xuICAgIGNvbnN0IG5ld0FycmF5ID0gdGhpcy5jaGlsZEl0ZW1zQ29tcG9uZW50LnRvQXJyYXkoKS5zb3J0KHNvcnQpO1xuXG4gICAgbmV3QXJyYXkuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICAgIGl0ZW0ub3JkZXIgPSBpbmRleC50b1N0cmluZygpO1xuICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5jaGlsZEl0ZW1zQ29tcG9uZW50LmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICBlbGVtZW50LnVwZGF0ZUV2ZW50LnVuc3Vic2NyaWJlKCk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==