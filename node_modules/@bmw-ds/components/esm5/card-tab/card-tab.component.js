import { __decorate } from "tslib";
import { Component, OnInit, ElementRef, ContentChildren, QueryList, AfterViewInit, EventEmitter } from '@angular/core';
import { CardTabLabelComponent } from './card-tab-label.component';
var CardTabComponent = /** @class */ (function () {
    function CardTabComponent(elementRef) {
        this.elementRef = elementRef;
    }
    CardTabComponent.prototype.ngOnInit = function () {
        var _this = this;
        console.warn('Beware, this component is not prepared for production usage!');
        this.hiddenLabels = this.elementRef.nativeElement.querySelector('.three-dots');
        this.hiddenLabels.addEventListener('focusout', function (e) {
            var leavingParent = !_this.hiddenLabels.contains(e.relatedTarget);
            if (leavingParent) {
                _this.toggleHiddenLabels(false);
            }
        });
        this.enableKeyboardControl();
        this.setResizeTrigger();
        setTimeout(function () {
            _this.hideLabelsIfNecessary();
        }, 10);
    };
    CardTabComponent.prototype.ngAfterViewInit = function () {
        this.prepareLabels();
    };
    CardTabComponent.prototype.prepareLabels = function () {
        var _this = this;
        this.articles = this.elementRef.nativeElement.querySelectorAll('bmw-card-tab-content');
        this.labels.toArray().forEach(function (labelElement, i) {
            var label = labelElement.elementRef.nativeElement.querySelector('label');
            var closeEmitter = new EventEmitter();
            closeEmitter.emit = function (closeId) {
                _this.remove(closeId);
            };
            var clickEmitter = new EventEmitter();
            clickEmitter.emit = function (clickId) {
                _this.setSelected(clickId);
                _this.toggleHiddenLabels(false);
            };
            labelElement.emitClose = closeEmitter;
            labelElement.emitClick = clickEmitter;
            label.dataset.order = i;
            var id = labelElement.for;
            if (typeof labelElement.selected !== 'undefined') {
                _this.setSelected(id);
            }
        });
        if (!this.selected && this.labels.toArray()[0]) {
            Promise.resolve().then(function () {
                _this.setSelected(_this.labels.toArray()[0].for);
            });
        }
    };
    CardTabComponent.prototype.setResizeTrigger = function () {
        var _this = this;
        var resizeTimer;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimer);
            var that = _this;
            resizeTimer = setTimeout(function () {
                that.hideLabelsIfNecessary(true);
            }, 10);
        });
    };
    CardTabComponent.prototype.setSelected = function (selected) {
        var _this = this;
        this.selected = selected;
        this.labels.toArray().forEach(function (labelElement, i) {
            var id = labelElement.for;
            if (selected === id) {
                labelElement.selected = true;
            }
            else {
                labelElement.selected = false;
            }
        });
        for (var i = 0; i < this.articles.length; i++) {
            var id = this.articles[i].getAttribute('id');
            if (selected === id) {
                this.articles[i].classList.add('selected');
            }
            else {
                this.articles[i].classList.remove('selected');
            }
        }
        setTimeout(function () {
            _this.hideLabelsIfNecessary(true);
        });
    };
    CardTabComponent.prototype.remove = function (removedId) {
        this.labels['_results'].forEach(function (labelElement, i) {
            var id = labelElement.for;
            if (removedId === id) {
                labelElement.destroy();
            }
        });
        for (var i = 0; i < this.articles.length; i++) {
            var id = this.articles[i].getAttribute('id');
            if (removedId === id) {
                this.articles[i].parentElement.removeChild(this.articles[i]);
            }
        }
        if (this.selected === removedId && this.labels.toArray().filter(function (e) { return e.destroyed === false; }).length > 0) {
            this.setSelected(this.labels.toArray().filter(function (e) { return e.destroyed === false; })[0].for);
        }
        this.hideLabelsIfNecessary(true);
    };
    CardTabComponent.prototype.enableKeyboardControl = function () {
        var _this = this;
        this.elementRef.nativeElement.querySelector('.labels').addEventListener('keydown', function (event) {
            event.preventDefault();
            var keyName = event.key;
            if (keyName.slice(-5) === 'Right') {
                for (var i = 0; i < _this.labels.length - 1; i++) {
                    var id = _this.labels[i].getAttribute('for');
                    if (id === _this.selected && _this.labels[i + 1].getAttribute('disabled') === null) {
                        _this.setSelected(_this.labels[i + 1].getAttribute('for'));
                        if (_this.labels[i + 1].parentElement.classList.contains('menu')) {
                            _this.toggleHiddenLabels(true);
                        }
                        break;
                    }
                }
            }
            if (keyName.slice(-4) === 'Left') {
                for (var i = 1; i < _this.labels.length; i++) {
                    var id = _this.labels[i].getAttribute('for');
                    if (id === _this.selected && _this.labels[i - 1].getAttribute('disabled') === null) {
                        _this.setSelected(_this.labels[i - 1].getAttribute('for'));
                        if (_this.labels[i - 1].parentElement.classList.contains('menu')) {
                            _this.toggleHiddenLabels(true);
                        }
                        break;
                    }
                }
            }
            if (keyName.slice(0, 3) === 'Esc' || keyName === 'Enter') {
                _this.toggleHiddenLabels(false);
                _this.hideLabelsIfNecessary(true);
            }
        });
    };
    CardTabComponent.prototype.hideLabelsIfNecessary = function (showAllFirst) {
        var labelsDiv = this.elementRef.nativeElement.querySelector('div.labels');
        if (showAllFirst) {
            this.showAllLabels(labelsDiv);
        }
        var height = labelsDiv.offsetHeight;
        var defaultHeight = this.elementRef.nativeElement.querySelector('.labels .height-limiter').offsetHeight;
        if (height > defaultHeight) {
            this.createHiddenLabelsMenuElement();
            var id = this.hideLastNonActiveLabel(labelsDiv);
            if (id > 0) {
                this.hideLabelsIfNecessary();
            }
        }
    };
    CardTabComponent.prototype.showAllLabels = function (parentElement) {
        if (!this.hiddenLabelsMenu)
            return;
        var length = this.hiddenLabelsMenu.children.length;
        for (var i = 0; i < length; i++) {
            parentElement.append(this.hiddenLabelsMenu.children[0]);
        }
        this.hiddenLabels.removeChild(this.hiddenLabelsMenu);
        this.hiddenLabelsMenu = undefined;
        this.sort(parentElement);
    };
    CardTabComponent.prototype.sort = function (parentElement) {
        var array = parentElement.children;
        array = Array.from(array).sort(function (a, b) {
            if (!a.querySelector('label'))
                return -1;
            if (!b.querySelector('label'))
                return 1;
            return a.querySelector('label').dataset.order - b.querySelector('label').dataset.order;
        });
        for (var i = 0; i < array.length; i++) {
            parentElement.append(array[i]);
        }
    };
    CardTabComponent.prototype.hideLastNonActiveLabel = function (parentElement) {
        var lastID = parentElement.querySelectorAll('.labels > bmw-card-tab-label').length - 1;
        var lastChild = parentElement.querySelectorAll('.labels > bmw-card-tab-label')[lastID];
        if (lastChild.querySelector('.selected') !== null) {
            lastID--;
            lastChild = parentElement.querySelectorAll('.labels > bmw-card-tab-label')[lastID];
        }
        if (lastChild.classList.contains('height-limiter') || lastChild.classList.contains('three-dots')) {
            return -1;
        }
        this.hiddenLabelsMenu.prepend(lastChild);
        return lastID;
    };
    CardTabComponent.prototype.createHiddenLabelsMenuElement = function () {
        if (this.hiddenLabelsMenu)
            return;
        this.hiddenLabelsMenu = document.createElement('div');
        this.hiddenLabelsMenu.classList.add('menu');
        this.hiddenLabels.append(this.hiddenLabelsMenu);
    };
    CardTabComponent.prototype.toggleHiddenLabels = function (state) {
        if (!this.hiddenLabels)
            return;
        var opened = this.hiddenLabels.classList.contains('opened');
        if (this.hiddenLabelsMenu && (state === true || opened === false)) {
            var rectangle = this.hiddenLabels.getBoundingClientRect();
            var position = rectangle.x + rectangle.width - 2;
            this.hiddenLabelsMenu.style['max-width'] = position + 'px';
        }
        if (state === true) {
            this.hiddenLabels.classList.add('opened');
        }
        else if (state === false) {
            this.hiddenLabels.classList.remove('opened');
        }
        else if (opened) {
            this.hiddenLabels.classList.remove('opened');
        }
        else {
            this.hiddenLabels.classList.add('opened');
        }
    };
    CardTabComponent.ctorParameters = function () { return [
        { type: ElementRef }
    ]; };
    __decorate([
        ContentChildren(CardTabLabelComponent)
    ], CardTabComponent.prototype, "labels", void 0);
    CardTabComponent = __decorate([
        Component({
            selector: 'bmw-card-tab',
            template: "<div class=\"wrapper\">\n  <div class=\"labels\" tabindex=\"0\">\n    <div class=\"three-dots\" (click)=\"toggleHiddenLabels()\" tabindex=\"0\"></div>\n    <div class=\"height-limiter\"></div>\n    <ng-content select=\"bmw-card-tab-label\"></ng-content>\n  </div>\n  <ng-content select=\"bmw-card-tab-content\"></ng-content>\n</div>\n",
            styles: [".three-dots{position:absolute;bottom:0;right:0;display:inline-block;order:2;box-sizing:card-box;height:var(--card-tabs__label__default__height)}.three-dots:empty{display:none}.three-dots:focus{outline:0;background-color:var(--card-tabs__more-dots__selected__background-color)}.three-dots .menu{display:none;position:absolute;background-color:var(--card-tabs__more-dots__menu__background-color);top:100%;right:0;z-index:var(--card-tabs__menu__z-index);border:solid 2px var(--card-tabs__more-dots__menu__border-color)}.three-dots .menu ::ng-deep bmw-card-tab-label{display:block;max-width:100%}.three-dots.opened .menu{display:inline-block}.three-dots::after{display:inline-block;line-height:var(--card-tabs__label__icon__font-size);font-size:var(--card-tabs__label__icon__font-size);padding:var(--card-tabs__label__icon__padding);padding-bottom:calc(var(--card-tabs__label__icon__padding) - 2px);font-family:iwp;color:var(--card-tabs__labels__default__color);content:'\\ea22'}.labels{padding-right:var(--card-tabs__label__default__height);position:relative;display:flex;flex:1 0 auto;flex-wrap:wrap}.labels:focus{outline:0}.labels .height-limiter{position:absolute;width:100%;z-index:-9;left:0;top:0;height:calc(var(--card-tabs__label__default__height) + 2px);box-sizing:border-box}.wrapper{min-width:calc(100px + var(--card-tabs__label__default__height))}"]
        })
    ], CardTabComponent);
    return CardTabComponent;
}());
export { CardTabComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FyZC10YWIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGJtdy1kcy9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY2FyZC10YWIvY2FyZC10YWIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZILE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBT25FO0lBT0UsMEJBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7SUFBRyxDQUFDO0lBRTlDLG1DQUFRLEdBQVI7UUFBQSxpQkFpQkM7UUFoQkMsT0FBTyxDQUFDLElBQUksQ0FBQyw4REFBOEQsQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRS9FLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLFVBQUEsQ0FBQztZQUM5QyxJQUFNLGFBQWEsR0FBRyxDQUFDLEtBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNuRSxJQUFJLGFBQWEsRUFBRTtnQkFDakIsS0FBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ2hDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QixVQUFVLENBQUM7WUFDVCxLQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUMvQixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDVCxDQUFDO0lBRUQs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YztZQUN4QiwwVkFBd0M7O1NBRXpDLENBQUM7T0FDVyxnQkFBZ0IsQ0FnUDVCO0lBQUQsdUJBQUM7Q0FBQSxBQWhQRCxJQWdQQztTQWhQWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgRWxlbWVudFJlZiwgQ29udGVudENoaWxkcmVuLCBRdWVyeUxpc3QsIEFmdGVyVmlld0luaXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ2FyZFRhYkxhYmVsQ29tcG9uZW50IH0gZnJvbSAnLi9jYXJkLXRhYi1sYWJlbC5jb21wb25lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdibXctY2FyZC10YWInLFxuICB0ZW1wbGF0ZVVybDogJy4vY2FyZC10YWIuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9jYXJkLXRhYi5jb21wb25lbnQubGVzcyddXG59KVxuZXhwb3J0IGNsYXNzIENhcmRUYWJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQge1xuICBAQ29udGVudENoaWxkcmVuKENhcmRUYWJMYWJlbENvbXBvbmVudClcbiAgbGFiZWxzOiBRdWVyeUxpc3Q8Q2FyZFRhYkxhYmVsQ29tcG9uZW50PjtcbiAgYXJ0aWNsZXM6IGFueVtdO1xuICBzZWxlY3RlZDogc3RyaW5nO1xuICBoaWRkZW5MYWJlbHM6IGFueTtcbiAgaGlkZGVuTGFiZWxzTWVudTogYW55O1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgY29uc29sZS53YXJuKCdCZXdhcmUsIHRoaXMgY29tcG9uZW50IGlzIG5vdCBwcmVwYXJlZCBmb3IgcHJvZHVjdGlvbiB1c2FnZSEnKTtcbiAgICB0aGlzLmhpZGRlbkxhYmVscyA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy50aHJlZS1kb3RzJyk7XG5cbiAgICB0aGlzLmhpZGRlbkxhYmVscy5hZGRFdmVudExpc3RlbmVyKCdmb2N1c291dCcsIGUgPT4ge1xuICAgICAgY29uc3QgbGVhdmluZ1BhcmVudCA9ICF0aGlzLmhpZGRlbkxhYmVscy5jb250YWlucyhlLnJlbGF0ZWRUYXJnZXQpO1xuICAgICAgaWYgKGxlYXZpbmdQYXJlbnQpIHtcbiAgICAgICAgdGhpcy50b2dnbGVIaWRkZW5MYWJlbHMoZmFsc2UpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5lbmFibGVLZXlib2FyZENvbnRyb2woKTtcblxuICAgIHRoaXMuc2V0UmVzaXplVHJpZ2dlcigpO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5oaWRlTGFiZWxzSWZOZWNlc3NhcnkoKTtcbiAgICB9LCAxMCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5wcmVwYXJlTGFiZWxzKCk7XG4gIH1cblxuICBwcmVwYXJlTGFiZWxzKCkge1xuICAgIHRoaXMuYXJ0aWNsZXMgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdibXctY2FyZC10YWItY29udGVudCcpO1xuXG4gICAgdGhpcy5sYWJlbHMudG9BcnJheSgpLmZvckVhY2goKGxhYmVsRWxlbWVudCwgaSkgPT4ge1xuICAgICAgY29uc3QgbGFiZWwgPSBsYWJlbEVsZW1lbnQuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2xhYmVsJyk7XG4gICAgICBjb25zdCBjbG9zZUVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgICAgIGNsb3NlRW1pdHRlci5lbWl0ID0gKGNsb3NlSWQ6IHN0cmluZykgPT4ge1xuICAgICAgICB0aGlzLnJlbW92ZShjbG9zZUlkKTtcbiAgICAgIH07XG4gICAgICBjb25zdCBjbGlja0VtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgICAgIGNsaWNrRW1pdHRlci5lbWl0ID0gKGNsaWNrSWQ6IHN0cmluZykgPT4ge1xuICAgICAgICB0aGlzLnNldFNlbGVjdGVkKGNsaWNrSWQpO1xuXG4gICAgICAgIHRoaXMudG9nZ2xlSGlkZGVuTGFiZWxzKGZhbHNlKTtcbiAgICAgIH07XG4gICAgICBsYWJlbEVsZW1lbnQuZW1pdENsb3NlID0gY2xvc2VFbWl0dGVyO1xuICAgICAgbGFiZWxFbGVtZW50LmVtaXRDbGljayA9IGNsaWNrRW1pdHRlcjtcbiAgICAgIGxhYmVsLmRhdGFzZXQub3JkZXIgPSBpO1xuICAgICAgY29uc3QgaWQgPSBsYWJlbEVsZW1lbnQuZm9yO1xuICAgICAgaWYgKHR5cGVvZiBsYWJlbEVsZW1lbnQuc2VsZWN0ZWQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRoaXMuc2V0U2VsZWN0ZWQoaWQpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLnNlbGVjdGVkICYmIHRoaXMubGFiZWxzLnRvQXJyYXkoKVswXSkge1xuICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U2VsZWN0ZWQodGhpcy5sYWJlbHMudG9BcnJheSgpWzBdLmZvcik7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBzZXRSZXNpemVUcmlnZ2VyKCkge1xuICAgIGxldCByZXNpemVUaW1lcjtcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCAoKSA9PiB7XG4gICAgICBjbGVhclRpbWVvdXQocmVzaXplVGltZXIpO1xuICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICByZXNpemVUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGF0LmhpZGVMYWJlbHNJZk5lY2Vzc2FyeSh0cnVlKTtcbiAgICAgIH0sIDEwKTtcbiAgICB9KTtcbiAgfVxuXG4gIHNldFNlbGVjdGVkKHNlbGVjdGVkOiBzdHJpbmcpIHtcbiAgICB0aGlzLnNlbGVjdGVkID0gc2VsZWN0ZWQ7XG4gICAgdGhpcy5sYWJlbHMudG9BcnJheSgpLmZvckVhY2goKGxhYmVsRWxlbWVudCwgaSkgPT4ge1xuICAgICAgY29uc3QgaWQgPSBsYWJlbEVsZW1lbnQuZm9yO1xuICAgICAgaWYgKHNlbGVjdGVkID09PSBpZCkge1xuICAgICAgICBsYWJlbEVsZW1lbnQuc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGFiZWxFbGVtZW50LnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmFydGljbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpZCA9IHRoaXMuYXJ0aWNsZXNbaV0uZ2V0QXR0cmlidXRlKCdpZCcpO1xuICAgICAgaWYgKHNlbGVjdGVkID09PSBpZCkge1xuICAgICAgICB0aGlzLmFydGljbGVzW2ldLmNsYXNzTGlzdC5hZGQoJ3NlbGVjdGVkJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFydGljbGVzW2ldLmNsYXNzTGlzdC5yZW1vdmUoJ3NlbGVjdGVkJyk7XG4gICAgICB9XG4gICAgfVxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5oaWRlTGFiZWxzSWZOZWNlc3NhcnkodHJ1ZSk7XG4gICAgfSk7XG4gIH1cblxuICByZW1vdmUocmVtb3ZlZElkOiBzdHJpbmcpIHtcbiAgICB0aGlzLmxhYmVsc1snX3Jlc3VsdHMnXS5mb3JFYWNoKChsYWJlbEVsZW1lbnQsIGkpID0+IHtcbiAgICAgIGNvbnN0IGlkID0gbGFiZWxFbGVtZW50LmZvcjtcbiAgICAgIGlmIChyZW1vdmVkSWQgPT09IGlkKSB7XG4gICAgICAgIGxhYmVsRWxlbWVudC5kZXN0cm95KCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmFydGljbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpZCA9IHRoaXMuYXJ0aWNsZXNbaV0uZ2V0QXR0cmlidXRlKCdpZCcpO1xuICAgICAgaWYgKHJlbW92ZWRJZCA9PT0gaWQpIHtcbiAgICAgICAgdGhpcy5hcnRpY2xlc1tpXS5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMuYXJ0aWNsZXNbaV0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5zZWxlY3RlZCA9PT0gcmVtb3ZlZElkICYmIHRoaXMubGFiZWxzLnRvQXJyYXkoKS5maWx0ZXIoZSA9PiBlLmRlc3Ryb3llZCA9PT0gZmFsc2UpLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuc2V0U2VsZWN0ZWQodGhpcy5sYWJlbHMudG9BcnJheSgpLmZpbHRlcihlID0+IGUuZGVzdHJveWVkID09PSBmYWxzZSlbMF0uZm9yKTtcbiAgICB9XG4gICAgdGhpcy5oaWRlTGFiZWxzSWZOZWNlc3NhcnkodHJ1ZSk7XG4gIH1cblxuICBlbmFibGVLZXlib2FyZENvbnRyb2woKSB7XG4gICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmxhYmVscycpLmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBldmVudCA9PiB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgY29uc3Qga2V5TmFtZSA9IGV2ZW50LmtleTtcbiAgICAgIGlmIChrZXlOYW1lLnNsaWNlKC01KSA9PT0gJ1JpZ2h0Jykge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubGFiZWxzLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgICAgIGNvbnN0IGlkID0gdGhpcy5sYWJlbHNbaV0uZ2V0QXR0cmlidXRlKCdmb3InKTtcbiAgICAgICAgICBpZiAoaWQgPT09IHRoaXMuc2VsZWN0ZWQgJiYgdGhpcy5sYWJlbHNbaSArIDFdLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTZWxlY3RlZCh0aGlzLmxhYmVsc1tpICsgMV0uZ2V0QXR0cmlidXRlKCdmb3InKSk7XG4gICAgICAgICAgICBpZiAodGhpcy5sYWJlbHNbaSArIDFdLnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdtZW51JykpIHtcbiAgICAgICAgICAgICAgdGhpcy50b2dnbGVIaWRkZW5MYWJlbHModHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChrZXlOYW1lLnNsaWNlKC00KSA9PT0gJ0xlZnQnKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgdGhpcy5sYWJlbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBpZCA9IHRoaXMubGFiZWxzW2ldLmdldEF0dHJpYnV0ZSgnZm9yJyk7XG4gICAgICAgICAgaWYgKGlkID09PSB0aGlzLnNlbGVjdGVkICYmIHRoaXMubGFiZWxzW2kgLSAxXS5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U2VsZWN0ZWQodGhpcy5sYWJlbHNbaSAtIDFdLmdldEF0dHJpYnV0ZSgnZm9yJykpO1xuICAgICAgICAgICAgaWYgKHRoaXMubGFiZWxzW2kgLSAxXS5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygnbWVudScpKSB7XG4gICAgICAgICAgICAgIHRoaXMudG9nZ2xlSGlkZGVuTGFiZWxzKHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoa2V5TmFtZS5zbGljZSgwLCAzKSA9PT0gJ0VzYycgfHwga2V5TmFtZSA9PT0gJ0VudGVyJykge1xuICAgICAgICB0aGlzLnRvZ2dsZUhpZGRlbkxhYmVscyhmYWxzZSk7XG4gICAgICAgIHRoaXMuaGlkZUxhYmVsc0lmTmVjZXNzYXJ5KHRydWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaGlkZUxhYmVsc0lmTmVjZXNzYXJ5KHNob3dBbGxGaXJzdD86IGJvb2xlYW4pIHtcbiAgICBjb25zdCBsYWJlbHNEaXYgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdkaXYubGFiZWxzJyk7XG4gICAgaWYgKHNob3dBbGxGaXJzdCkge1xuICAgICAgdGhpcy5zaG93QWxsTGFiZWxzKGxhYmVsc0Rpdik7XG4gICAgfVxuICAgIGNvbnN0IGhlaWdodCA9IGxhYmVsc0Rpdi5vZmZzZXRIZWlnaHQ7XG4gICAgY29uc3QgZGVmYXVsdEhlaWdodCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5sYWJlbHMgLmhlaWdodC1saW1pdGVyJykub2Zmc2V0SGVpZ2h0O1xuICAgIGlmIChoZWlnaHQgPiBkZWZhdWx0SGVpZ2h0KSB7XG4gICAgICB0aGlzLmNyZWF0ZUhpZGRlbkxhYmVsc01lbnVFbGVtZW50KCk7XG4gICAgICBjb25zdCBpZCA9IHRoaXMuaGlkZUxhc3ROb25BY3RpdmVMYWJlbChsYWJlbHNEaXYpO1xuICAgICAgaWYgKGlkID4gMCkge1xuICAgICAgICB0aGlzLmhpZGVMYWJlbHNJZk5lY2Vzc2FyeSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNob3dBbGxMYWJlbHMocGFyZW50RWxlbWVudCkge1xuICAgIGlmICghdGhpcy5oaWRkZW5MYWJlbHNNZW51KSByZXR1cm47XG5cbiAgICBjb25zdCBsZW5ndGggPSB0aGlzLmhpZGRlbkxhYmVsc01lbnUuY2hpbGRyZW4ubGVuZ3RoO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgcGFyZW50RWxlbWVudC5hcHBlbmQodGhpcy5oaWRkZW5MYWJlbHNNZW51LmNoaWxkcmVuWzBdKTtcbiAgICB9XG5cbiAgICB0aGlzLmhpZGRlbkxhYmVscy5yZW1vdmVDaGlsZCh0aGlzLmhpZGRlbkxhYmVsc01lbnUpO1xuICAgIHRoaXMuaGlkZGVuTGFiZWxzTWVudSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnNvcnQocGFyZW50RWxlbWVudCk7XG4gIH1cblxuICBzb3J0KHBhcmVudEVsZW1lbnQpIHtcbiAgICBsZXQgYXJyYXkgPSBwYXJlbnRFbGVtZW50LmNoaWxkcmVuO1xuICAgIGFycmF5ID0gQXJyYXkuZnJvbShhcnJheSkuc29ydCgoYTogYW55LCBiOiBhbnkpID0+IHtcbiAgICAgIGlmICghYS5xdWVyeVNlbGVjdG9yKCdsYWJlbCcpKSByZXR1cm4gLTE7XG4gICAgICBpZiAoIWIucXVlcnlTZWxlY3RvcignbGFiZWwnKSkgcmV0dXJuIDE7XG5cbiAgICAgIHJldHVybiBhLnF1ZXJ5U2VsZWN0b3IoJ2xhYmVsJykuZGF0YXNldC5vcmRlciAtIGIucXVlcnlTZWxlY3RvcignbGFiZWwnKS5kYXRhc2V0Lm9yZGVyO1xuICAgIH0pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgIHBhcmVudEVsZW1lbnQuYXBwZW5kKGFycmF5W2ldKTtcbiAgICB9XG4gIH1cblxuICBoaWRlTGFzdE5vbkFjdGl2ZUxhYmVsKHBhcmVudEVsZW1lbnQ6IGFueSk6IG51bWJlciB7XG4gICAgbGV0IGxhc3RJRCA9IHBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmxhYmVscyA+IGJtdy1jYXJkLXRhYi1sYWJlbCcpLmxlbmd0aCAtIDE7XG4gICAgbGV0IGxhc3RDaGlsZCA9IHBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmxhYmVscyA+IGJtdy1jYXJkLXRhYi1sYWJlbCcpW2xhc3RJRF07XG5cbiAgICBpZiAobGFzdENoaWxkLnF1ZXJ5U2VsZWN0b3IoJy5zZWxlY3RlZCcpICE9PSBudWxsKSB7XG4gICAgICBsYXN0SUQtLTtcbiAgICAgIGxhc3RDaGlsZCA9IHBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmxhYmVscyA+IGJtdy1jYXJkLXRhYi1sYWJlbCcpW2xhc3RJRF07XG4gICAgfVxuXG4gICAgaWYgKGxhc3RDaGlsZC5jbGFzc0xpc3QuY29udGFpbnMoJ2hlaWdodC1saW1pdGVyJykgfHwgbGFzdENoaWxkLmNsYXNzTGlzdC5jb250YWlucygndGhyZWUtZG90cycpKSB7XG4gICAgICByZXR1cm4gLTE7XG4gICAgfVxuXG4gICAgdGhpcy5oaWRkZW5MYWJlbHNNZW51LnByZXBlbmQobGFzdENoaWxkKTtcbiAgICByZXR1cm4gbGFzdElEO1xuICB9XG5cbiAgY3JlYXRlSGlkZGVuTGFiZWxzTWVudUVsZW1lbnQoKSB7XG4gICAgaWYgKHRoaXMuaGlkZGVuTGFiZWxzTWVudSkgcmV0dXJuO1xuXG4gICAgdGhpcy5oaWRkZW5MYWJlbHNNZW51ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgdGhpcy5oaWRkZW5MYWJlbHNNZW51LmNsYXNzTGlzdC5hZGQoJ21lbnUnKTtcbiAgICB0aGlzLmhpZGRlbkxhYmVscy5hcHBlbmQodGhpcy5oaWRkZW5MYWJlbHNNZW51KTtcbiAgfVxuXG4gIHRvZ2dsZUhpZGRlbkxhYmVscyhzdGF0ZT86IGJvb2xlYW4pIHtcbiAgICBpZiAoIXRoaXMuaGlkZGVuTGFiZWxzKSByZXR1cm47XG4gICAgY29uc3Qgb3BlbmVkID0gdGhpcy5oaWRkZW5MYWJlbHMuY2xhc3NMaXN0LmNvbnRhaW5zKCdvcGVuZWQnKTtcblxuICAgIGlmICh0aGlzLmhpZGRlbkxhYmVsc01lbnUgJiYgKHN0YXRlID09PSB0cnVlIHx8IG9wZW5lZCA9PT0gZmFsc2UpKSB7XG4gICAgICBjb25zdCByZWN0YW5nbGUgPSB0aGlzLmhpZGRlbkxhYmVscy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gcmVjdGFuZ2xlLnggKyByZWN0YW5nbGUud2lkdGggLSAyO1xuICAgICAgdGhpcy5oaWRkZW5MYWJlbHNNZW51LnN0eWxlWydtYXgtd2lkdGgnXSA9IHBvc2l0aW9uICsgJ3B4JztcbiAgICB9XG5cbiAgICBpZiAoc3RhdGUgPT09IHRydWUpIHtcbiAgICAgIHRoaXMuaGlkZGVuTGFiZWxzLmNsYXNzTGlzdC5hZGQoJ29wZW5lZCcpO1xuICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLmhpZGRlbkxhYmVscy5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuZWQnKTtcbiAgICB9IGVsc2UgaWYgKG9wZW5lZCkge1xuICAgICAgdGhpcy5oaWRkZW5MYWJlbHMuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbmVkJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaGlkZGVuTGFiZWxzLmNsYXNzTGlzdC5hZGQoJ29wZW5lZCcpO1xuICAgIH1cbiAgfVxufVxuIl19