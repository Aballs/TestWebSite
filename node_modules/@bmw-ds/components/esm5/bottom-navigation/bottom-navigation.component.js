import { __decorate } from "tslib";
import { AfterContentInit, Component, ContentChildren, ElementRef, EventEmitter, HostBinding, Input, OnDestroy, Output, QueryList, Renderer2, ViewChild, HostListener, ChangeDetectorRef } from '@angular/core';
import { BottomNavigationItemComponent } from './bottom-navigation-item.component';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
var BottomNavigationComponent = /** @class */ (function () {
    function BottomNavigationComponent(renderer, cdRef) {
        this.renderer = renderer;
        this.cdRef = cdRef;
        this.selectionChanged = new EventEmitter();
        this.childOfMoreSelected = false;
        this._moreSelected = false;
        this.onDestroy$ = new Subject();
    }
    Object.defineProperty(BottomNavigationComponent.prototype, "moreSelected", {
        get: function () {
            return this._moreSelected;
        },
        enumerable: true,
        configurable: true
    });
    BottomNavigationComponent.prototype.onKeydown = function (event) {
        var key = event.code || event.keyCode;
        switch (key) {
            case 'ArrowDown':
            case 40:
                if (this._moreSelected) {
                    this.setNextItemAsFocused();
                }
                event.preventDefault();
                break;
            case 'ArrowUp':
            case 38:
                if (this._moreSelected) {
                    this.setPreviousItemAsFocused();
                }
                event.preventDefault();
                break;
            case 'Enter':
            case 'NumpadEnter':
            case 13:
            case 'Space':
            case 32:
                if (event.target === this.moreButton.nativeElement) {
                    this.moreButton.nativeElement.click();
                }
                else {
                    var targetedItem = this.items.find(function (item) { return item.nativeElement === event.target; });
                    if (targetedItem) {
                        targetedItem.nativeElement.click();
                        if (this.moreEntries.some(function (item) { return item.nativeElement === event.target; })) {
                            this.moreButton.nativeElement.focus();
                        }
                    }
                }
                this.cdRef.detectChanges();
                event.preventDefault();
                break;
            case 'Tab':
            case 9:
                if (this._moreSelected &&
                    this.moreEntries.some(function (item) { return item.nativeElement === document.activeElement; })) {
                    this.toggleMore(false);
                    this.moreButton.nativeElement.focus();
                    event.preventDefault();
                    event.stopPropagation();
                }
                break;
            case 'Escape':
            case 27:
                this.toggleMore(false);
                this.moreButton.nativeElement.focus();
                event.preventDefault();
                break;
        }
    };
    BottomNavigationComponent.prototype.ngAfterContentInit = function () {
        var _this = this;
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
        this.items.changes.subscribe(function (value) {
            _this.processTransclusion();
        });
        this.processTransclusion();
    };
    BottomNavigationComponent.prototype.ngOnDestroy = function () {
        this.onDestroy$.next();
        this.onDestroy$.complete();
    };
    BottomNavigationComponent.prototype.toggleMore = function (forcedState) {
        if (this._moreSelected || forcedState === false) {
            this._moreSelected = false;
        }
        else if (!this._moreSelected || forcedState === true) {
            this._moreSelected = true;
        }
    };
    BottomNavigationComponent.prototype.processTransclusion = function () {
        var _this = this;
        this.items.forEach(function (item) {
            item.selectedChange.pipe(takeUntil(_this.onDestroy$)).subscribe(function (selected) {
                _this.selectItem(item, selected);
            });
        });
        if (this.menuEntries.length > 5) {
            this.moreEntries = this.menuEntries.filter(function (item, index) { return index >= 4; });
            this.moreEntries.forEach(function (item) {
                _this.renderer.removeChild(_this.baseContainer.nativeElement, item.nativeElement);
                _this.renderer.appendChild(_this.moreContainer.nativeElement, item.nativeElement);
                item.tabIndex = -1;
            });
        }
    };
    BottomNavigationComponent.prototype.setPreviousItemAsFocused = function () {
        if (this._moreSelected && this.moreEntries.length > 0) {
            var focusedItemIndex = this.moreEntries.findIndex(function (item) { return item.nativeElement === document.activeElement; });
            if (focusedItemIndex !== -1 && focusedItemIndex !== 0) {
                focusedItemIndex = focusedItemIndex - 1;
            }
            else {
                focusedItemIndex = this.moreEntries.length - 1;
            }
            this.moreEntries[focusedItemIndex].nativeElement.focus();
            this.cdRef.detectChanges();
        }
    };
    BottomNavigationComponent.prototype.setNextItemAsFocused = function () {
        if (this._moreSelected && this.moreEntries.length > 0) {
            var focusedItemIndex = this.moreEntries.findIndex(function (item) { return item.nativeElement === document.activeElement; });
            if (focusedItemIndex !== -1 && focusedItemIndex !== this.moreEntries.length - 1) {
                focusedItemIndex = focusedItemIndex + 1;
            }
            else {
                focusedItemIndex = 0;
            }
            this.moreEntries[focusedItemIndex].nativeElement.focus();
            this.cdRef.detectChanges();
        }
    };
    BottomNavigationComponent.prototype.selectItem = function (targetItem, selectedState) {
        if (selectedState) {
            this.items.forEach(function (item) {
                if (targetItem !== item) {
                    item.selected = false;
                }
            });
            if (this.moreEntries && this.moreEntries.includes(targetItem)) {
                this.childOfMoreSelected = true;
            }
            else {
                this.childOfMoreSelected = false;
            }
        }
        else {
            this.childOfMoreSelected = false;
        }
        this.toggleMore(false);
        this.selectionChanged.emit({ item: targetItem, selected: selectedState });
    };
    BottomNavigationComponent.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        Output()
    ], BottomNavigationComponent.prototype, "selectionChanged", void 0);
    __decorate([
        ContentChildren(BottomNavigationItemComponent)
    ], BottomNavigationComponent.prototype, "items", void 0);
    __decorate([
        ContentChildren(BottomNavigationItemComponent)
    ], BottomNavigationComponent.prototype, "menuEntries", void 0);
    __decorate([
        ViewChild(BottomNavigationItemComponent, { static: true })
    ], BottomNavigationComponent.prototype, "moreButton", void 0);
    __decorate([
        ViewChild('moreContainer', { read: ElementRef, static: true })
    ], BottomNavigationComponent.prototype, "moreContainer", void 0);
    __decorate([
        ViewChild('baseContainer', { read: ElementRef, static: true })
    ], BottomNavigationComponent.prototype, "baseContainer", void 0);
    __decorate([
        HostBinding('attr.id'),
        Input()
    ], BottomNavigationComponent.prototype, "id", void 0);
    __decorate([
        HostListener('keydown', ['$event'])
    ], BottomNavigationComponent.prototype, "onKeydown", null);
    BottomNavigationComponent = __decorate([
        Component({
            selector: 'bmw-bottom-navigation',
            template: "<div #baseContainer class=\"base-container\">\n  <ng-content select=\"bmw-bottom-navigation-item\"></ng-content>\n  <div class=\"more-button-wrapper\" [ngStyle]=\"{ display: items.length <= 5 ? 'none' : undefined }\">\n    <bmw-bottom-navigation-item\n      [selected]=\"moreSelected\"\n      class=\"secondary\"\n      [ngClass]=\"{ 'child-selected': childOfMoreSelected }\"\n      icon=\"iwp-icon-gen_more\"\n      label=\"More\"\n      (selectedChange)=\"toggleMore()\"\n    ></bmw-bottom-navigation-item>\n    <div [ngStyle]=\"{ display: !moreSelected ? 'none' : undefined }\" #moreContainer class=\"more-container\"></div>\n  </div>\n</div>\n",
            styles: [":host{height:56px;max-height:56px;margin-top:auto;display:flex;flex-direction:column-reverse;width:100%;flex:1 1 100%;z-index:var(--bottom-navigation__base__z-index)}:host .base-container{align-items:center;display:flex;background-color:var(--bottom-navigation__default__background-color);border-top:1px solid var(--bottom-navigation__default__border-color);height:100%}:host .more-button-wrapper{flex:1 1 100%;align-self:flex-end;display:flex;flex-direction:column-reverse}:host .more-container{display:flex;flex-direction:column;align-self:flex-end;z-index:var(--bottom-navigation__popup__z-index);background-color:var(--bottom-navigation__default__background-color);border-top:1px solid var(--bottom-navigation__default__border-color);border-left:1px solid var(--bottom-navigation__default__border-color);width:100%}"]
        })
    ], BottomNavigationComponent);
    return BottomNavigationComponent;
}());
export { BottomNavigationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm90dG9tLW5hdmlnYXRpb24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGJtdy1kcy9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiYm90dG9tLW5hdmlnYXRpb24vYm90dG9tLW5hdmlnYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFDVCxlQUFlLEVBQ2YsVUFBVSxFQUNWLFlBQVksRUFDWixXQUFXLEVBQ1gsS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1QsWUFBWSxFQUNaLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNuRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQU8zQztJQTJGRSxtQ0FBb0IsUUFBbUIsRUFBVSxLQUF3QjtRQUFyRCxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBbUI7UUF6RnpFLHFCQUFnQixHQUFHLElBQUksWUFBWSxFQUE4RCxDQUFDO1FBZ0JsRyx3QkFBbUIsR0FBRyxLQUFLLENBQUM7UUFNcEIsa0JBQWEsR0FBRyxLQUFLLENBQUM7UUFDdEIsZUFBVSxHQUFrQixJQUFJLE9BQU8sRUFBRSxDQUFDO0lBa0UwQixDQUFDO0lBdkU3RSxzQkFBSSxtREFBWTthQUFoQjtZQUNFLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUM1QixDQUFDOzs7T0FBQTtJQVVELDZDQUFTLEdBQVQsVUFBVSxLQUFvQjtRQUM1QixJQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDeEMsUUFBUSxHQUFHLEVBQUU7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QUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7SUFDNUUsQ0FBQzs7Z0JBOUY2QixTQUFTO2dCQUFpQixpQkFBaUI7O0lBekZ6RTtRQURDLE1BQU0sRUFBRTt1RUFDeUY7SUFHbEc7UUFEQyxlQUFlLENBQUMsNkJBQTZCLENBQUM7NERBQ0M7SUFHaEQ7UUFEQyxlQUFlLENBQUMsNkJBQTZCLENBQUM7a0VBQ087SUFJdEQ7UUFEQyxTQUFTLENBQUMsNkJBQTZCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7aUVBQ2pCO0lBRTFDO1FBREMsU0FBUyxDQUFDLGVBQWUsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO29FQUNyQztJQUUxQjtRQURDLFNBQVMsQ0FBQyxlQUFlLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQztvRUFDckM7SUFhMUI7UUFGQyxXQUFXLENBQUMsU0FBUyxDQUFDO1FBQ3RCLEtBQUssRUFBRTt5REFDRztJQUdYO1FBREMsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDOzhEQTBEbkM7SUF6RlUseUJBQXlCO1FBTHJDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx1QkFBdUI7WUFDakMsbXBCQUFpRDs7U0FFbEQsQ0FBQztPQUNXLHlCQUF5QixDQTBMckM7SUFBRCxnQ0FBQztDQUFBLEFBMUxELElBMExDO1NBMUxZLHlCQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyQ29udGVudEluaXQsXG4gIENvbXBvbmVudCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RCaW5kaW5nLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPdXRwdXQsXG4gIFF1ZXJ5TGlzdCxcbiAgUmVuZGVyZXIyLFxuICBWaWV3Q2hpbGQsXG4gIEhvc3RMaXN0ZW5lcixcbiAgQ2hhbmdlRGV0ZWN0b3JSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCb3R0b21OYXZpZ2F0aW9uSXRlbUNvbXBvbmVudCB9IGZyb20gJy4vYm90dG9tLW5hdmlnYXRpb24taXRlbS5jb21wb25lbnQnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdibXctYm90dG9tLW5hdmlnYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJy4vYm90dG9tLW5hdmlnYXRpb24uY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9ib3R0b20tbmF2aWdhdGlvbi5jb21wb25lbnQubGVzcyddXG59KVxuZXhwb3J0IGNsYXNzIEJvdHRvbU5hdmlnYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3kge1xuICBAT3V0cHV0KClcbiAgc2VsZWN0aW9uQ2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXI8eyBpdGVtOiBCb3R0b21OYXZpZ2F0aW9uSXRlbUNvbXBvbmVudDsgc2VsZWN0ZWQ6IGJvb2xlYW4gfT4oKTtcblxuICBAQ29udGVudENoaWxkcmVuKEJvdHRvbU5hdmlnYXRpb25JdGVtQ29tcG9uZW50KVxuICBpdGVtczogUXVlcnlMaXN0PEJvdHRvbU5hdmlnYXRpb25JdGVtQ29tcG9uZW50PjtcblxuICBAQ29udGVudENoaWxkcmVuKEJvdHRvbU5hdmlnYXRpb25JdGVtQ29tcG9uZW50KVxuICBtZW51RW50cmllczogUXVlcnlMaXN0PEJvdHRvbU5hdmlnYXRpb25JdGVtQ29tcG9uZW50PjtcbiAgbW9yZUVudHJpZXM6IEFycmF5PEJvdHRvbU5hdmlnYXRpb25JdGVtQ29tcG9uZW50PjtcblxuICBAVmlld0NoaWxkKEJvdHRvbU5hdmlnYXRpb25JdGVtQ29tcG9uZW50LCB7IHN0YXRpYzogdHJ1ZSB9KVxuICBtb3JlQnV0dG9uOiBCb3R0b21OYXZpZ2F0aW9uSXRlbUNvbXBvbmVudDtcbiAgQFZpZXdDaGlsZCgnbW9yZUNvbnRhaW5lcicsIHsgcmVhZDogRWxlbWVudFJlZiwgc3RhdGljOiB0cnVlIH0pXG4gIG1vcmVDb250YWluZXI6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ2Jhc2VDb250YWluZXInLCB7IHJlYWQ6IEVsZW1lbnRSZWYsIHN0YXRpYzogdHJ1ZSB9KVxuICBiYXNlQ29udGFpbmVyOiBFbGVtZW50UmVmO1xuXG4gIGNoaWxkT2ZNb3JlU2VsZWN0ZWQgPSBmYWxzZTtcblxuICBnZXQgbW9yZVNlbGVjdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9tb3JlU2VsZWN0ZWQ7XG4gIH1cblxuICBwcml2YXRlIF9tb3JlU2VsZWN0ZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBvbkRlc3Ryb3kkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuaWQnKVxuICBASW5wdXQoKVxuICBpZDogc3RyaW5nO1xuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxuICBvbktleWRvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBjb25zdCBrZXkgPSBldmVudC5jb2RlIHx8IGV2ZW50LmtleUNvZGU7XG4gICAgc3dpdGNoIChrZXkpIHtcbiAgICAgIGNhc2UgJ0Fycm93RG93bic6XG4gICAgICBjYXNlIDQwOlxuICAgICAgICBpZiAodGhpcy5fbW9yZVNlbGVjdGVkKSB7XG4gICAgICAgICAgdGhpcy5zZXROZXh0SXRlbUFzRm9jdXNlZCgpO1xuICAgICAgICB9XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQXJyb3dVcCc6XG4gICAgICBjYXNlIDM4OlxuICAgICAgICBpZiAodGhpcy5fbW9yZVNlbGVjdGVkKSB7XG4gICAgICAgICAgdGhpcy5zZXRQcmV2aW91c0l0ZW1Bc0ZvY3VzZWQoKTtcbiAgICAgICAgfVxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0VudGVyJzpcbiAgICAgIGNhc2UgJ051bXBhZEVudGVyJzpcbiAgICAgIGNhc2UgMTM6XG4gICAgICBjYXNlICdTcGFjZSc6XG4gICAgICBjYXNlIDMyOlxuICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSB0aGlzLm1vcmVCdXR0b24ubmF0aXZlRWxlbWVudCkge1xuICAgICAgICAgIHRoaXMubW9yZUJ1dHRvbi5uYXRpdmVFbGVtZW50LmNsaWNrKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgdGFyZ2V0ZWRJdGVtID0gdGhpcy5pdGVtcy5maW5kKGl0ZW0gPT4gaXRlbS5uYXRpdmVFbGVtZW50ID09PSBldmVudC50YXJnZXQpO1xuICAgICAgICAgIGlmICh0YXJnZXRlZEl0ZW0pIHtcbiAgICAgICAgICAgIHRhcmdldGVkSXRlbS5uYXRpdmVFbGVtZW50LmNsaWNrKCk7XG4gICAgICAgICAgICBpZiAodGhpcy5tb3JlRW50cmllcy5zb21lKGl0ZW0gPT4gaXRlbS5uYXRpdmVFbGVtZW50ID09PSBldmVudC50YXJnZXQpKSB7XG4gICAgICAgICAgICAgIHRoaXMubW9yZUJ1dHRvbi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnVGFiJzpcbiAgICAgIGNhc2UgOTpcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHRoaXMuX21vcmVTZWxlY3RlZCAmJlxuICAgICAgICAgIHRoaXMubW9yZUVudHJpZXMuc29tZShpdGVtID0+IGl0ZW0ubmF0aXZlRWxlbWVudCA9PT0gKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQpKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aGlzLnRvZ2dsZU1vcmUoZmFsc2UpO1xuICAgICAgICAgIHRoaXMubW9yZUJ1dHRvbi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnRXNjYXBlJzpcbiAgICAgIGNhc2UgMjc6XG4gICAgICAgIHRoaXMudG9nZ2xlTW9yZShmYWxzZSk7XG4gICAgICAgIHRoaXMubW9yZUJ1dHRvbi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHt9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pZCkge1xuICAgICAgdGhpcy5pZCA9IE1hdGgucmFuZG9tKClcbiAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAuc3Vic3RyaW5nKDIpO1xuICAgIH1cbiAgICB0aGlzLml0ZW1zLmNoYW5nZXMuc3Vic2NyaWJlKHZhbHVlID0+IHtcbiAgICAgIHRoaXMucHJvY2Vzc1RyYW5zY2x1c2lvbigpO1xuICAgIH0pO1xuICAgIHRoaXMucHJvY2Vzc1RyYW5zY2x1c2lvbigpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5vbkRlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLm9uRGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHRvZ2dsZU1vcmUoZm9yY2VkU3RhdGU/OiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX21vcmVTZWxlY3RlZCB8fCBmb3JjZWRTdGF0ZSA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuX21vcmVTZWxlY3RlZCA9IGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoIXRoaXMuX21vcmVTZWxlY3RlZCB8fCBmb3JjZWRTdGF0ZSA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5fbW9yZVNlbGVjdGVkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NUcmFuc2NsdXNpb24oKSB7XG4gICAgdGhpcy5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbS5zZWxlY3RlZENoYW5nZS5waXBlKHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKS5zdWJzY3JpYmUoKHNlbGVjdGVkOiBib29sZWFuKSA9PiB7XG4gICAgICAgIHRoaXMuc2VsZWN0SXRlbShpdGVtLCBzZWxlY3RlZCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBpZiAodGhpcy5tZW51RW50cmllcy5sZW5ndGggPiA1KSB7XG4gICAgICB0aGlzLm1vcmVFbnRyaWVzID0gdGhpcy5tZW51RW50cmllcy5maWx0ZXIoKGl0ZW0sIGluZGV4KSA9PiBpbmRleCA+PSA0KTtcbiAgICAgIHRoaXMubW9yZUVudHJpZXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLmJhc2VDb250YWluZXIubmF0aXZlRWxlbWVudCwgaXRlbS5uYXRpdmVFbGVtZW50KTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLm1vcmVDb250YWluZXIubmF0aXZlRWxlbWVudCwgaXRlbS5uYXRpdmVFbGVtZW50KTtcbiAgICAgICAgaXRlbS50YWJJbmRleCA9IC0xO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgc2V0UHJldmlvdXNJdGVtQXNGb2N1c2VkKCkge1xuICAgIGlmICh0aGlzLl9tb3JlU2VsZWN0ZWQgJiYgdGhpcy5tb3JlRW50cmllcy5sZW5ndGggPiAwKSB7XG4gICAgICBsZXQgZm9jdXNlZEl0ZW1JbmRleDogbnVtYmVyID0gdGhpcy5tb3JlRW50cmllcy5maW5kSW5kZXgoXG4gICAgICAgIGl0ZW0gPT4gaXRlbS5uYXRpdmVFbGVtZW50ID09PSAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudClcbiAgICAgICk7XG5cbiAgICAgIGlmIChmb2N1c2VkSXRlbUluZGV4ICE9PSAtMSAmJiBmb2N1c2VkSXRlbUluZGV4ICE9PSAwKSB7XG4gICAgICAgIGZvY3VzZWRJdGVtSW5kZXggPSBmb2N1c2VkSXRlbUluZGV4IC0gMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvY3VzZWRJdGVtSW5kZXggPSB0aGlzLm1vcmVFbnRyaWVzLmxlbmd0aCAtIDE7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubW9yZUVudHJpZXNbZm9jdXNlZEl0ZW1JbmRleF0ubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgdGhpcy5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQoKSB7XG4gICAgaWYgKHRoaXMuX21vcmVTZWxlY3RlZCAmJiB0aGlzLm1vcmVFbnRyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGxldCBmb2N1c2VkSXRlbUluZGV4OiBudW1iZXIgPSB0aGlzLm1vcmVFbnRyaWVzLmZpbmRJbmRleChcbiAgICAgICAgaXRlbSA9PiBpdGVtLm5hdGl2ZUVsZW1lbnQgPT09IChkb2N1bWVudC5hY3RpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50KVxuICAgICAgKTtcblxuICAgICAgaWYgKGZvY3VzZWRJdGVtSW5kZXggIT09IC0xICYmIGZvY3VzZWRJdGVtSW5kZXggIT09IHRoaXMubW9yZUVudHJpZXMubGVuZ3RoIC0gMSkge1xuICAgICAgICBmb2N1c2VkSXRlbUluZGV4ID0gZm9jdXNlZEl0ZW1JbmRleCArIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmb2N1c2VkSXRlbUluZGV4ID0gMDtcbiAgICAgIH1cblxuICAgICAgdGhpcy5tb3JlRW50cmllc1tmb2N1c2VkSXRlbUluZGV4XS5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICB0aGlzLmNkUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNlbGVjdEl0ZW0odGFyZ2V0SXRlbTogQm90dG9tTmF2aWdhdGlvbkl0ZW1Db21wb25lbnQsIHNlbGVjdGVkU3RhdGU6IGJvb2xlYW4pIHtcbiAgICBpZiAoc2VsZWN0ZWRTdGF0ZSkge1xuICAgICAgdGhpcy5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBpZiAodGFyZ2V0SXRlbSAhPT0gaXRlbSkge1xuICAgICAgICAgIGl0ZW0uc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBpZiAodGhpcy5tb3JlRW50cmllcyAmJiB0aGlzLm1vcmVFbnRyaWVzLmluY2x1ZGVzKHRhcmdldEl0ZW0pKSB7XG4gICAgICAgIHRoaXMuY2hpbGRPZk1vcmVTZWxlY3RlZCA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNoaWxkT2ZNb3JlU2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jaGlsZE9mTW9yZVNlbGVjdGVkID0gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMudG9nZ2xlTW9yZShmYWxzZSk7XG4gICAgdGhpcy5zZWxlY3Rpb25DaGFuZ2VkLmVtaXQoeyBpdGVtOiB0YXJnZXRJdGVtLCBzZWxlY3RlZDogc2VsZWN0ZWRTdGF0ZSB9KTtcbiAgfVxufVxuIl19