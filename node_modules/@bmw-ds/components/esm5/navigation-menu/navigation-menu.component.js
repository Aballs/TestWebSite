import { __decorate } from "tslib";
import { takeUntil } from 'rxjs/operators';
import { NavigationService } from './navigation.service';
import { Component, AfterContentInit, ContentChildren, QueryList, OnDestroy, Output, EventEmitter, Input, HostBinding, HostListener, ElementRef, ChangeDetectorRef } from '@angular/core';
import { NavigationMenuSubmenuItemComponent } from './navigation-menu-submenu-item.component';
import { NavigationMenuItemComponent } from './navigation-menu-item.component';
import { NavigationMenuSubmenuComponent } from './navigation-menu-submenu.component';
import { Subject } from 'rxjs';
var NavigationMenuComponent = /** @class */ (function () {
    function NavigationMenuComponent(elemRef, cdRef, _navService) {
        var _this = this;
        this.elemRef = elemRef;
        this.cdRef = cdRef;
        this._navService = _navService;
        this.onDestroy$ = new Subject();
        this._opened = false;
        /**
         * closes menu when user clicks outside (default = false)
         */
        this.closeOnClickOutside = false;
        this.itemSelectedEvent = new EventEmitter();
        this._navService.selectionChange.pipe(takeUntil(this.onDestroy$)).subscribe(function (item) {
            var _a;
            if (item instanceof NavigationMenuItemComponent) {
                _this.itemSelectedEvent.emit(item);
                item.onMouseOut(null);
                _this.opened = false;
            }
            else if (item instanceof NavigationMenuSubmenuItemComponent) {
                _this.itemSelectedEvent.emit(item);
                (_a = _this.items.find(function (navItem) { return navItem.popUp; })) === null || _a === void 0 ? void 0 : _a.onMouseOut(null);
                _this.opened = false;
            }
        });
    }
    Object.defineProperty(NavigationMenuComponent.prototype, "opened", {
        get: function () {
            return this._opened;
        },
        set: function (value) {
            this._opened = value;
            this._navService.menuOpened.next(this._opened);
        },
        enumerable: true,
        configurable: true
    });
    NavigationMenuComponent.prototype.onFocusIn = function (event) {
        if (this.items.some(function (item) { return event.target === item.labelWrapper.nativeElement; })) {
            this.items.forEach(function (item) {
                if (event.target === item.labelWrapper.nativeElement) {
                    item.onMouseOver();
                }
                else {
                    item.popUp = false;
                }
            });
        }
    };
    NavigationMenuComponent.prototype.clickout = function (event) {
        if (this.closeOnClickOutside && !this.elemRef.nativeElement.contains(event.target) && this.opened) {
            this.opened = false;
        }
    };
    NavigationMenuComponent.prototype.onKeydown = function (event) {
        var key = event.code || event.keyCode;
        switch (key) {
            case 'ArrowRight':
            case 39:
                if (!this.opened) {
                    this.focusIntoSubmenu(event.target);
                    this.expandAllSubmenus();
                    event.preventDefault();
                    event.stopPropagation();
                }
                break;
            case 'Enter':
            case 'NumpadEnter':
            case 13:
            case 'Space':
            case 32:
                if (event.target === this.elemRef.nativeElement.querySelector('i.arrow')) {
                    this.opened = !this.opened;
                }
                else {
                    this.clickMenuItem(this.items.find(function (item) { return item.labelWrapper.nativeElement === event.target; }));
                }
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'Escape':
            case 27:
                if (!this.opened) {
                    this.items.forEach(function (item) { return (item.popUp = false); });
                    event.preventDefault();
                }
                else {
                    this.opened = false;
                }
                break;
            case 'Tab':
            case 9:
                var focusedItem = this.items.find(function (item) { return event.target === item.labelWrapper.nativeElement; });
                if (focusedItem) {
                    focusedItem.popUp = false;
                }
                break;
        }
    };
    NavigationMenuComponent.prototype.ngAfterContentInit = function () {
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
    };
    NavigationMenuComponent.prototype.ngOnDestroy = function () {
        this.onDestroy$.next();
        this.onDestroy$.complete();
    };
    NavigationMenuComponent.prototype.focusIntoSubmenu = function (target) {
        var focusedItem = this.items.find(function (item) { return target === item.labelWrapper.nativeElement; });
        if (focusedItem && focusedItem.popUp) {
            focusedItem.setNextSubmenuItemAsFocused();
        }
    };
    NavigationMenuComponent.prototype.clickMenuItem = function (menuItem) {
        if (menuItem) {
            menuItem.click(null);
            if (this.opened) {
                this.expandAllSubmenus();
            }
            else {
                menuItem.toggleSubmenuPopup();
            }
        }
    };
    NavigationMenuComponent.prototype.expandAllSubmenus = function () {
        this.submenus.forEach(function (submenu) { return (submenu.opened = true); });
    };
    NavigationMenuComponent.ctorParameters = function () { return [
        { type: ElementRef },
        { type: ChangeDetectorRef },
        { type: NavigationService }
    ]; };
    __decorate([
        ContentChildren(NavigationMenuSubmenuItemComponent, { descendants: true })
    ], NavigationMenuComponent.prototype, "submenuItems", void 0);
    __decorate([
        ContentChildren(NavigationMenuSubmenuComponent, { descendants: true })
    ], NavigationMenuComponent.prototype, "submenus", void 0);
    __decorate([
        ContentChildren(NavigationMenuItemComponent)
    ], NavigationMenuComponent.prototype, "items", void 0);
    __decorate([
        HostBinding('attr.id'),
        Input()
    ], NavigationMenuComponent.prototype, "id", void 0);
    __decorate([
        Input()
    ], NavigationMenuComponent.prototype, "opened", null);
    __decorate([
        Input()
    ], NavigationMenuComponent.prototype, "closeOnClickOutside", void 0);
    __decorate([
        Output()
    ], NavigationMenuComponent.prototype, "itemSelectedEvent", void 0);
    __decorate([
        HostListener('focusin', ['$event'])
    ], NavigationMenuComponent.prototype, "onFocusIn", null);
    __decorate([
        HostListener('document:click', ['$event'])
    ], NavigationMenuComponent.prototype, "clickout", null);
    __decorate([
        HostListener('keydown', ['$event'])
    ], NavigationMenuComponent.prototype, "onKeydown", null);
    NavigationMenuComponent = __decorate([
        Component({
            selector: 'bmw-navigation-menu',
            template: "<div class=\"navigation-menu-wrapper\" [ngClass]=\"opened ? 'opened' : ''\">\n  <i\n    [ngClass]=\"opened ? 'iwp-icon-gen_arrow_left' : 'iwp-icon-gen_arrow_right'\"\n    class=\"arrow\"\n    (click)=\"opened = !opened\"\n    tabindex=\"0\"\n  ></i>\n  <div class=\"navigation-content\">\n    <ng-content select=\"bmw-navigation-menu-item\"></ng-content>\n  </div>\n</div>\n",
            providers: [NavigationService],
            styles: [":host{display:inline-block;height:100%;position:relative;box-sizing:border-box}.navigation-menu-wrapper{display:inline-flex;position:relative;padding-top:var(--navigation-menu__default__padding-top);box-shadow:1px 0 0 0 var(--navigation-menu__default__border-right-color);height:100%;background-color:var(--navigation-menu__default__background-color);box-sizing:border-box}.navigation-menu-wrapper.opened{width:var(--navigation-menu__opened__width);z-index:var(--navigation-menu__z-index)}.navigation-menu-wrapper.opened .navigation-content{box-sizing:border-box;width:100%;overflow:hidden;overflow-y:auto}.navigation-menu-wrapper .arrow{font-size:var(--navigation-menu__icon__font-size);position:absolute;width:var(--navigation-menu__icon__font-size);cursor:pointer;padding:var(--navigation-menu__icon__padding);margin-top:var(--navigation-menu__icon__padding-top);top:0;right:var(--navigation-menu__icon__padding)}.navigation-menu-wrapper .arrow:focus{outline:solid 1px;outline-color:var(--color-bmw-highlight);outline-offset:-1px}::ng-deep .chevron{font-size:var(--navigation-menu__chevron__font-size);cursor:pointer}"]
        })
    ], NavigationMenuComponent);
    return NavigationMenuComponent;
}());
export { NavigationMenuComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1tZW51LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BibXctZHMvY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbIm5hdmlnYXRpb24tbWVudS9uYXZpZ2F0aW9uLW1lbnUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQsT0FBTyxFQUNMLFNBQVMsRUFDVCxnQkFBZ0IsRUFDaEIsZUFBZSxFQUNmLFNBQVMsRUFDVCxTQUFTLEVBQ1QsTUFBTSxFQUNOLFlBQVksRUFDWixLQUFLLEVBQ0wsV0FBVyxFQUNYLFlBQVksRUFDWixVQUFVLEVBQ1YsaUJBQWlCLEVBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQzlGLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQy9FLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFRL0I7SUFzR0UsaUNBQW9CLE9BQW1CLEVBQVUsS0FBd0IsRUFBVSxXQUE4QjtRQUFqSCxpQkFZQztRQVptQixZQUFPLEdBQVAsT0FBTyxDQUFZO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBbUI7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBbUI7UUFyR3pHLGVBQVUsR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUMxQyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBcUJ4Qjs7V0FFRztRQUVILHdCQUFtQixHQUFHLEtBQUssQ0FBQztRQUc1QixzQkFBaUIsR0FBRyxJQUFJLFlBQVksRUFBb0UsQ0FBQztRQXlFdkcsSUFBSSxDQUFDLFdBQVcsQ0FB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Z0JBQWlCLGlCQUFpQjtnQkFBdUIsaUJBQWlCOztJQWpHakg7UUFEQyxlQUFlLENBQUMsa0NBQWtDLEVBQUUsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUM7aUVBQ2Y7SUFFNUQ7UUFEQyxlQUFlLENBQUMsOEJBQThCLEVBQUUsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUM7NkRBQ25CO0lBRXBEO1FBREMsZUFBZSxDQUFDLDJCQUEyQixDQUFDOzBEQUNDO0lBSTlDO1FBRkMsV0FBVyxDQUFDLFNBQVMsQ0FBQztRQUN0QixLQUFLLEVBQUU7dURBQ0c7SUFFWDtRQURDLEtBQUssRUFBRTt5REFJUDtJQVNEO1FBREMsS0FBSyxFQUFFO3dFQUNvQjtJQUc1QjtRQURDLE1BQU0sRUFBRTtzRUFDZ0c7SUFHekc7UUFEQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7NERBV25DO0lBR0Q7UUFEQyxZQUFZLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzsyREFLMUM7SUFHRDtRQURDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzs0REFnRG5DO0lBcEdVLHVCQUF1QjtRQU5uQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUscUJBQXFCO1lBQy9CLGtZQUErQztZQUUvQyxTQUFTLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQzs7U0FDL0IsQ0FBQztPQUNXLHVCQUF1QixDQXNKbkM7SUFBRCw4QkFBQztDQUFBLEFBdEpELElBc0pDO1NBdEpZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5hdmlnYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9uYXZpZ2F0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBBZnRlckNvbnRlbnRJbml0LFxuICBDb250ZW50Q2hpbGRyZW4sXG4gIFF1ZXJ5TGlzdCxcbiAgT25EZXN0cm95LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIEhvc3RCaW5kaW5nLFxuICBIb3N0TGlzdGVuZXIsXG4gIEVsZW1lbnRSZWYsXG4gIENoYW5nZURldGVjdG9yUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTmF2aWdhdGlvbk1lbnVTdWJtZW51SXRlbUNvbXBvbmVudCB9IGZyb20gJy4vbmF2aWdhdGlvbi1tZW51LXN1Ym1lbnUtaXRlbS5jb21wb25lbnQnO1xuaW1wb3J0IHsgTmF2aWdhdGlvbk1lbnVJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi9uYXZpZ2F0aW9uLW1lbnUtaXRlbS5jb21wb25lbnQnO1xuaW1wb3J0IHsgTmF2aWdhdGlvbk1lbnVTdWJtZW51Q29tcG9uZW50IH0gZnJvbSAnLi9uYXZpZ2F0aW9uLW1lbnUtc3VibWVudS5jb21wb25lbnQnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdibXctbmF2aWdhdGlvbi1tZW51JyxcbiAgdGVtcGxhdGVVcmw6ICcuL25hdmlnYXRpb24tbWVudS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL25hdmlnYXRpb24tbWVudS5jb21wb25lbnQubGVzcyddLFxuICBwcm92aWRlcnM6IFtOYXZpZ2F0aW9uU2VydmljZV1cbn0pXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvbk1lbnVDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIG9uRGVzdHJveSQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIF9vcGVuZWQgPSBmYWxzZTtcbiAgc2VsZWN0ZWQ6IE5hdmlnYXRpb25NZW51SXRlbUNvbXBvbmVudDtcbiAgQENvbnRlbnRDaGlsZHJlbihOYXZpZ2F0aW9uTWVudVN1Ym1lbnVJdGVtQ29tcG9uZW50LCB7IGRlc2NlbmRhbnRzOiB0cnVlIH0pXG4gIHN1Ym1lbnVJdGVtczogUXVlcnlMaXN0PE5hdmlnYXRpb25NZW51U3VibWVudUl0ZW1Db21wb25lbnQ+O1xuICBAQ29udGVudENoaWxkcmVuKE5hdmlnYXRpb25NZW51U3VibWVudUNvbXBvbmVudCwgeyBkZXNjZW5kYW50czogdHJ1ZSB9KVxuICBzdWJtZW51czogUXVlcnlMaXN0PE5hdmlnYXRpb25NZW51U3VibWVudUNvbXBvbmVudD47XG4gIEBDb250ZW50Q2hpbGRyZW4oTmF2aWdhdGlvbk1lbnVJdGVtQ29tcG9uZW50KVxuICBpdGVtczogUXVlcnlMaXN0PE5hdmlnYXRpb25NZW51SXRlbUNvbXBvbmVudD47XG5cbiAgQEhvc3RCaW5kaW5nKCdhdHRyLmlkJylcbiAgQElucHV0KClcbiAgaWQ6IHN0cmluZztcbiAgQElucHV0KClcbiAgc2V0IG9wZW5lZCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX29wZW5lZCA9IHZhbHVlO1xuICAgIHRoaXMuX25hdlNlcnZpY2UubWVudU9wZW5lZC5uZXh0KHRoaXMuX29wZW5lZCk7XG4gIH1cbiAgZ2V0IG9wZW5lZCgpIHtcbiAgICByZXR1cm4gdGhpcy5fb3BlbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIGNsb3NlcyBtZW51IHdoZW4gdXNlciBjbGlja3Mgb3V0c2lkZSAoZGVmYXVsdCA9IGZhbHNlKVxuICAgKi9cbiAgQElucHV0KClcbiAgY2xvc2VPbkNsaWNrT3V0c2lkZSA9IGZhbHNlO1xuXG4gIEBPdXRwdXQoKVxuICBpdGVtU2VsZWN0ZWRFdmVudCA9IG5ldyBFdmVudEVtaXR0ZXI8TmF2aWdhdGlvbk1lbnVJdGVtQ29tcG9uZW50IHwgTmF2aWdhdGlvbk1lbnVTdWJtZW51SXRlbUNvbXBvbmVudD4oKTtcblxuICBASG9zdExpc3RlbmVyKCdmb2N1c2luJywgWyckZXZlbnQnXSlcbiAgb25Gb2N1c0luKGV2ZW50OiBFdmVudCkge1xuICAgIGlmICh0aGlzLml0ZW1zLnNvbWUoaXRlbSA9PiBldmVudC50YXJnZXQgPT09IGl0ZW0ubGFiZWxXcmFwcGVyLm5hdGl2ZUVsZW1lbnQpKSB7XG4gICAgICB0aGlzLml0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGlmIChldmVudC50YXJnZXQgPT09IGl0ZW0ubGFiZWxXcmFwcGVyLm5hdGl2ZUVsZW1lbnQpIHtcbiAgICAgICAgICBpdGVtLm9uTW91c2VPdmVyKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaXRlbS5wb3BVcCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDpjbGljaycsIFsnJGV2ZW50J10pXG4gIGNsaWNrb3V0KGV2ZW50KSB7XG4gICAgaWYgKHRoaXMuY2xvc2VPbkNsaWNrT3V0c2lkZSAmJiAhdGhpcy5lbGVtUmVmLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0KSAmJiB0aGlzLm9wZW5lZCkge1xuICAgICAgdGhpcy5vcGVuZWQgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdrZXlkb3duJywgWyckZXZlbnQnXSlcbiAgb25LZXlkb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgY29uc3Qga2V5ID0gZXZlbnQuY29kZSB8fCBldmVudC5rZXlDb2RlO1xuXG4gICAgc3dpdGNoIChrZXkpIHtcbiAgICAgIGNhc2UgJ0Fycm93UmlnaHQnOlxuICAgICAgY2FzZSAzOTpcbiAgICAgICAgaWYgKCF0aGlzLm9wZW5lZCkge1xuICAgICAgICAgIHRoaXMuZm9jdXNJbnRvU3VibWVudShldmVudC50YXJnZXQpO1xuICAgICAgICAgIHRoaXMuZXhwYW5kQWxsU3VibWVudXMoKTtcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdFbnRlcic6XG4gICAgICBjYXNlICdOdW1wYWRFbnRlcic6XG4gICAgICBjYXNlIDEzOlxuICAgICAgY2FzZSAnU3BhY2UnOlxuICAgICAgY2FzZSAzMjpcbiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gdGhpcy5lbGVtUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignaS5hcnJvdycpKSB7XG4gICAgICAgICAgdGhpcy5vcGVuZWQgPSAhdGhpcy5vcGVuZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5jbGlja01lbnVJdGVtKHRoaXMuaXRlbXMuZmluZChpdGVtID0+IGl0ZW0ubGFiZWxXcmFwcGVyLm5hdGl2ZUVsZW1lbnQgPT09IGV2ZW50LnRhcmdldCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdFc2NhcGUnOlxuICAgICAgY2FzZSAyNzpcbiAgICAgICAgaWYgKCF0aGlzLm9wZW5lZCkge1xuICAgICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IChpdGVtLnBvcFVwID0gZmFsc2UpKTtcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMub3BlbmVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ1RhYic6XG4gICAgICBjYXNlIDk6XG4gICAgICAgIGNvbnN0IGZvY3VzZWRJdGVtID0gdGhpcy5pdGVtcy5maW5kKGl0ZW0gPT4gZXZlbnQudGFyZ2V0ID09PSBpdGVtLmxhYmVsV3JhcHBlci5uYXRpdmVFbGVtZW50KTtcbiAgICAgICAgaWYgKGZvY3VzZWRJdGVtKSB7XG4gICAgICAgICAgZm9jdXNlZEl0ZW0ucG9wVXAgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1SZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIF9uYXZTZXJ2aWNlOiBOYXZpZ2F0aW9uU2VydmljZSkge1xuICAgIHRoaXMuX25hdlNlcnZpY2Uuc2VsZWN0aW9uQ2hhbmdlLnBpcGUodGFrZVVudGlsKHRoaXMub25EZXN0cm95JCkpLnN1YnNjcmliZShpdGVtID0+IHtcbiAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgTmF2aWdhdGlvbk1lbnVJdGVtQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuaXRlbVNlbGVjdGVkRXZlbnQuZW1pdChpdGVtKTtcbiAgICAgICAgaXRlbS5vbk1vdXNlT3V0KG51bGwpO1xuICAgICAgICB0aGlzLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgTmF2aWdhdGlvbk1lbnVTdWJtZW51SXRlbUNvbXBvbmVudCkge1xuICAgICAgICB0aGlzLml0ZW1TZWxlY3RlZEV2ZW50LmVtaXQoaXRlbSk7XG4gICAgICAgIHRoaXMuaXRlbXMuZmluZChuYXZJdGVtID0+IG5hdkl0ZW0ucG9wVXApPy5vbk1vdXNlT3V0KG51bGwpO1xuICAgICAgICB0aGlzLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgIGlmICghdGhpcy5pZCkge1xuICAgICAgdGhpcy5pZCA9IE1hdGgucmFuZG9tKClcbiAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAuc3Vic3RyaW5nKDIpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMub25EZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5vbkRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBmb2N1c0ludG9TdWJtZW51KHRhcmdldDogRXZlbnRUYXJnZXQpIHtcbiAgICBjb25zdCBmb2N1c2VkSXRlbSA9IHRoaXMuaXRlbXMuZmluZChpdGVtID0+IHRhcmdldCA9PT0gaXRlbS5sYWJlbFdyYXBwZXIubmF0aXZlRWxlbWVudCk7XG4gICAgaWYgKGZvY3VzZWRJdGVtICYmIGZvY3VzZWRJdGVtLnBvcFVwKSB7XG4gICAgICBmb2N1c2VkSXRlbS5zZXROZXh0U3VibWVudUl0ZW1Bc0ZvY3VzZWQoKTtcbiAgICB9XG4gIH1cblxuICBjbGlja01lbnVJdGVtKG1lbnVJdGVtOiBOYXZpZ2F0aW9uTWVudUl0ZW1Db21wb25lbnQpIHtcbiAgICBpZiAobWVudUl0ZW0pIHtcbiAgICAgIG1lbnVJdGVtLmNsaWNrKG51bGwpO1xuICAgICAgaWYgKHRoaXMub3BlbmVkKSB7XG4gICAgICAgIHRoaXMuZXhwYW5kQWxsU3VibWVudXMoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1lbnVJdGVtLnRvZ2dsZVN1Ym1lbnVQb3B1cCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGV4cGFuZEFsbFN1Ym1lbnVzKCkge1xuICAgIHRoaXMuc3VibWVudXMuZm9yRWFjaChzdWJtZW51ID0+IChzdWJtZW51Lm9wZW5lZCA9IHRydWUpKTtcbiAgfVxufVxuIl19