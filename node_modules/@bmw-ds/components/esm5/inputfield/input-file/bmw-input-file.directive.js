import { __decorate, __param } from "tslib";
import { Directive, Renderer2, ElementRef, AfterViewInit, HostListener, OnChanges, Input, Injector, SimpleChanges, Optional } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { NgControl, FormControl } from '@angular/forms';
var BmwInputFileDirective = /** @class */ (function () {
    function BmwInputFileDirective(injector, _renderer, _el, control) {
        this.injector = injector;
        this._renderer = _renderer;
        this._el = _el;
        this.control = control;
        this.destroy$ = new Subject();
        this.btnLabel = 'Browse';
    }
    BmwInputFileDirective.prototype.onMouseOver = function () {
        this._renderer.addClass(this.browseBtn, 'active');
    };
    BmwInputFileDirective.prototype.onMouseLeave = function () {
        this._renderer.removeClass(this.browseBtn, 'active');
    };
    BmwInputFileDirective.prototype.onChange = function () {
        if (this._el.nativeElement.files.length) {
            var fileName = this._el.nativeElement.files[0].name;
            this._renderer.setAttribute(this.visibleInput, 'value', fileName);
        }
        else {
            this._renderer.setAttribute(this.visibleInput, 'value', '');
        }
        this.checkForRequired();
    };
    BmwInputFileDirective.prototype.checkForRequired = function () {
        var _this = this;
        setTimeout(function () {
            var classList = _this._el.nativeElement.classList;
            if (_this._el.nativeElement.required && classList.contains('ng-invalid') && classList.contains('ng-touched')) {
                _this.visibleInput.classList.add('ng-invalid');
                _this.visibleInput.classList.add('ng-touched');
            }
            else {
                _this.visibleInput.classList.remove('ng-invalid');
                _this.visibleInput.classList.remove('ng-touched');
            }
        }, 0);
    };
    BmwInputFileDirective.prototype._getInputGridClass = function (el) {
        return el.classList.value.split(' ').find(function (className) { return className.includes('bmw__grid__cell'); });
    };
    BmwInputFileDirective.prototype.ngOnChanges = function (changes) {
        if (this.visibleInput && this.browseBtn) {
            this.checkForRequired();
            if (changes.btnLabel) {
                this.updateButtonLabel();
            }
        }
    };
    BmwInputFileDirective.prototype.ngAfterViewInit = function () {
        var _this = this;
        if (!this._el.nativeElement.nextElementSibling)
            return;
        var gridClass = this._getInputGridClass(this._el.nativeElement);
        this._renderer.addClass(this._el.nativeElement.nextElementSibling, gridClass);
        this.browseBtn = this._el.nativeElement.nextElementSibling.querySelector('button');
        this.visibleInput = this._el.nativeElement.nextElementSibling.querySelector('input');
        if (this._el.nativeElement.attributes['aria-label']) {
            this.visibleInput.setAttribute('aria-label', this._el.nativeElement.attributes['aria-label'].value);
        }
        var clickOnButton$ = fromEvent(this.browseBtn, 'click').pipe(takeUntil(this.destroy$));
        var clickOnInput$ = fromEvent(this.visibleInput, 'click').pipe(takeUntil(this.destroy$));
        var keydownOnInput$ = fromEvent(this.visibleInput, 'keydown').pipe(takeUntil(this.destroy$));
        var ngControl = this.injector.get(NgControl, null);
        if (ngControl) {
            this.inputControl = ngControl.control;
        }
        clickOnButton$.subscribe(function () {
            var _a;
            _this._el.nativeElement.click();
            (_a = _this.inputControl) === null || _a === void 0 ? void 0 : _a.markAsTouched();
        });
        clickOnInput$.subscribe(function () {
            var _a;
            _this._el.nativeElement.click();
            (_a = _this.inputControl) === null || _a === void 0 ? void 0 : _a.markAsTouched();
        });
        keydownOnInput$.subscribe(function (event) {
            var _a;
            if (event.code === 'Space' || event.keyCode === 32) {
                _this._el.nativeElement.click();
                (_a = _this.inputControl) === null || _a === void 0 ? void 0 : _a.markAsTouched();
            }
        });
        if (this.control) {
            this.control.valueChanges.pipe(takeUntil(this.destroy$)).subscribe(function (value) {
                if (!value) {
                    _this.onChange();
                }
            });
        }
        this.checkForRequired();
        this.updateButtonLabel();
    };
    BmwInputFileDirective.prototype.updateButtonLabel = function () {
        this.browseBtn.querySelector('div').innerText = this.btnLabel;
    };
    BmwInputFileDirective.prototype.destroy = function () {
        this.destroy$.next();
    };
    BmwInputFileDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: Renderer2 },
        { type: ElementRef },
        { type: NgControl, decorators: [{ type: Optional }] }
    ]; };
    __decorate([
        Input()
    ], BmwInputFileDirective.prototype, "btnLabel", void 0);
    __decorate([
        HostListener('mouseover')
    ], BmwInputFileDirective.prototype, "onMouseOver", null);
    __decorate([
        HostListener('mouseleave')
    ], BmwInputFileDirective.prototype, "onMouseLeave", null);
    __decorate([
        HostListener('change')
    ], BmwInputFileDirective.prototype, "onChange", null);
    BmwInputFileDirective = __decorate([
        Directive({
            selector: 'input[bmwInputFile]'
        }),
        __param(3, Optional())
    ], BmwInputFileDirective);
    return BmwInputFileDirective;
}());
export { BmwInputFileDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm13LWlucHV0LWZpbGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGJtdy1kcy9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiaW5wdXRmaWVsZC9pbnB1dC1maWxlL2Jtdy1pbnB1dC1maWxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxTQUFTLEVBQ1QsVUFBVSxFQUNWLGFBQWEsRUFDYixZQUFZLEVBQ1osU0FBUyxFQUNULEtBQUssRUFDTCxRQUFRLEVBQ1IsYUFBYSxFQUNiLFFBQVEsRUFDVCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUt4RDtJQStCRSwrQkFDVSxRQUFrQixFQUNsQixTQUFvQixFQUNwQixHQUFlLEVBQ0gsT0FBa0I7UUFIOUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDSCxZQUFPLEdBQVAsT0FBTyxDQUFXO1FBN0JoQyxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUU5QixhQUFRLEdBQUcsUUFBUSxDQUFDO0lBNEIxQixDQUFDO0lBekJKLDJDQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFHRCw0Q0FBWSxHQUFaO1FBQ0UsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBR0Qsd0NBQVEsR0FB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QVN0QjtJQTdCVSxxQkFBcUI7UUFIakMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHFCQUFxQjtTQUNoQyxDQUFDO1FBb0NHLFdBQUEsUUFBUSxFQUFFLENBQUE7T0FuQ0YscUJBQXFCLENBeUhqQztJQUFELDRCQUFDO0NBQUEsQUF6SEQsSUF5SEM7U0F6SFkscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBSZW5kZXJlcjIsXG4gIEVsZW1lbnRSZWYsXG4gIEFmdGVyVmlld0luaXQsXG4gIEhvc3RMaXN0ZW5lcixcbiAgT25DaGFuZ2VzLFxuICBJbnB1dCxcbiAgSW5qZWN0b3IsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE9wdGlvbmFsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBOZ0NvbnRyb2wsIEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdpbnB1dFtibXdJbnB1dEZpbGVdJ1xufSlcbmV4cG9ydCBjbGFzcyBCbXdJbnB1dEZpbGVEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMge1xuICBicm93c2VCdG46IEhUTUxFbGVtZW50O1xuICB2aXNpYmxlSW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQ7XG5cbiAgcHJpdmF0ZSBpbnB1dENvbnRyb2w6IEZvcm1Db250cm9sO1xuXG4gIHByaXZhdGUgZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIEBJbnB1dCgpIGJ0bkxhYmVsID0gJ0Jyb3dzZSc7XG5cbiAgQEhvc3RMaXN0ZW5lcignbW91c2VvdmVyJylcbiAgb25Nb3VzZU92ZXIoKSB7XG4gICAgdGhpcy5fcmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5icm93c2VCdG4sICdhY3RpdmUnKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlbGVhdmUnKVxuICBvbk1vdXNlTGVhdmUoKSB7XG4gICAgdGhpcy5fcmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5icm93c2VCdG4sICdhY3RpdmUnKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2NoYW5nZScpXG4gIG9uQ2hhbmdlKCkge1xuICAgIGlmICh0aGlzLl9lbC5uYXRpdmVFbGVtZW50LmZpbGVzLmxlbmd0aCkge1xuICAgICAgY29uc3QgZmlsZU5hbWUgPSB0aGlzLl9lbC5uYXRpdmVFbGVtZW50LmZpbGVzWzBdLm5hbWU7XG4gICAgICB0aGlzLl9yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy52aXNpYmxlSW5wdXQsICd2YWx1ZScsIGZpbGVOYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMudmlzaWJsZUlucHV0LCAndmFsdWUnLCAnJyk7XG4gICAgfVxuICAgIHRoaXMuY2hlY2tGb3JSZXF1aXJlZCgpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcml2YXRlIF9lbDogRWxlbWVudFJlZixcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGNvbnRyb2w6IE5nQ29udHJvbFxuICApIHt9XG5cbiAgY2hlY2tGb3JSZXF1aXJlZCgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGNvbnN0IGNsYXNzTGlzdCA9IHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0O1xuICAgICAgaWYgKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQucmVxdWlyZWQgJiYgY2xhc3NMaXN0LmNvbnRhaW5zKCduZy1pbnZhbGlkJykgJiYgY2xhc3NMaXN0LmNvbnRhaW5zKCduZy10b3VjaGVkJykpIHtcbiAgICAgICAgdGhpcy52aXNpYmxlSW5wdXQuY2xhc3NMaXN0LmFkZCgnbmctaW52YWxpZCcpO1xuICAgICAgICB0aGlzLnZpc2libGVJbnB1dC5jbGFzc0xpc3QuYWRkKCduZy10b3VjaGVkJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnZpc2libGVJbnB1dC5jbGFzc0xpc3QucmVtb3ZlKCduZy1pbnZhbGlkJyk7XG4gICAgICAgIHRoaXMudmlzaWJsZUlucHV0LmNsYXNzTGlzdC5yZW1vdmUoJ25nLXRvdWNoZWQnKTtcbiAgICAgIH1cbiAgICB9LCAwKTtcbiAgfVxuXG4gIF9nZXRJbnB1dEdyaWRDbGFzcyhlbDogSFRNTEVsZW1lbnQpOiBzdHJpbmcge1xuICAgIHJldHVybiBlbC5jbGFzc0xpc3QudmFsdWUuc3BsaXQoJyAnKS5maW5kKGNsYXNzTmFtZSA9PiBjbGFzc05hbWUuaW5jbHVkZXMoJ2Jtd19fZ3JpZF9fY2VsbCcpKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy52aXNpYmxlSW5wdXQgJiYgdGhpcy5icm93c2VCdG4pIHtcbiAgICAgIHRoaXMuY2hlY2tGb3JSZXF1aXJlZCgpO1xuXG4gICAgICBpZiAoY2hhbmdlcy5idG5MYWJlbCkge1xuICAgICAgICB0aGlzLnVwZGF0ZUJ1dHRvbkxhYmVsKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGlmICghdGhpcy5fZWwubmF0aXZlRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIHJldHVybjtcbiAgICBjb25zdCBncmlkQ2xhc3MgPSB0aGlzLl9nZXRJbnB1dEdyaWRDbGFzcyh0aGlzLl9lbC5uYXRpdmVFbGVtZW50KTtcbiAgICB0aGlzLl9yZW5kZXJlci5hZGRDbGFzcyh0aGlzLl9lbC5uYXRpdmVFbGVtZW50Lm5leHRFbGVtZW50U2libGluZywgZ3JpZENsYXNzKTtcbiAgICB0aGlzLmJyb3dzZUJ0biA9IHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nLnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbicpO1xuICAgIHRoaXMudmlzaWJsZUlucHV0ID0gdGhpcy5fZWwubmF0aXZlRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcucXVlcnlTZWxlY3RvcignaW5wdXQnKTtcblxuICAgIGlmICh0aGlzLl9lbC5uYXRpdmVFbGVtZW50LmF0dHJpYnV0ZXNbJ2FyaWEtbGFiZWwnXSkge1xuICAgICAgdGhpcy52aXNpYmxlSW5wdXQuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgdGhpcy5fZWwubmF0aXZlRWxlbWVudC5hdHRyaWJ1dGVzWydhcmlhLWxhYmVsJ10udmFsdWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGNsaWNrT25CdXR0b24kID0gZnJvbUV2ZW50KHRoaXMuYnJvd3NlQnRuLCAnY2xpY2snKS5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSk7XG4gICAgY29uc3QgY2xpY2tPbklucHV0JCA9IGZyb21FdmVudCh0aGlzLnZpc2libGVJbnB1dCwgJ2NsaWNrJykucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpO1xuICAgIGNvbnN0IGtleWRvd25PbklucHV0JCA9IGZyb21FdmVudCh0aGlzLnZpc2libGVJbnB1dCwgJ2tleWRvd24nKS5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSk7XG5cbiAgICBjb25zdCBuZ0NvbnRyb2w6IE5nQ29udHJvbCA9IHRoaXMuaW5qZWN0b3IuZ2V0KE5nQ29udHJvbCwgbnVsbCk7XG4gICAgaWYgKG5nQ29udHJvbCkge1xuICAgICAgdGhpcy5pbnB1dENvbnRyb2wgPSBuZ0NvbnRyb2wuY29udHJvbCBhcyBGb3JtQ29udHJvbDtcbiAgICB9XG5cbiAgICBjbGlja09uQnV0dG9uJC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5fZWwubmF0aXZlRWxlbWVudC5jbGljaygpO1xuICAgICAgdGhpcy5pbnB1dENvbnRyb2w/Lm1hcmtBc1RvdWNoZWQoKTtcbiAgICB9KTtcblxuICAgIGNsaWNrT25JbnB1dCQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQuY2xpY2soKTtcbiAgICAgIHRoaXMuaW5wdXRDb250cm9sPy5tYXJrQXNUb3VjaGVkKCk7XG4gICAgfSk7XG5cbiAgICBrZXlkb3duT25JbnB1dCQuc3Vic2NyaWJlKChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xuICAgICAgaWYgKGV2ZW50LmNvZGUgPT09ICdTcGFjZScgfHwgZXZlbnQua2V5Q29kZSA9PT0gMzIpIHtcbiAgICAgICAgdGhpcy5fZWwubmF0aXZlRWxlbWVudC5jbGljaygpO1xuICAgICAgICB0aGlzLmlucHV0Q29udHJvbD8ubWFya0FzVG91Y2hlZCgpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuY29udHJvbCkge1xuICAgICAgdGhpcy5jb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSkuc3Vic2NyaWJlKHZhbHVlID0+IHtcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy5jaGVja0ZvclJlcXVpcmVkKCk7XG4gICAgdGhpcy51cGRhdGVCdXR0b25MYWJlbCgpO1xuICB9XG5cbiAgdXBkYXRlQnV0dG9uTGFiZWwoKSB7XG4gICAgdGhpcy5icm93c2VCdG4ucXVlcnlTZWxlY3RvcignZGl2JykuaW5uZXJUZXh0ID0gdGhpcy5idG5MYWJlbDtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gIH1cbn1cbiJdfQ==