import { __decorate, __param } from "tslib";
import { AfterContentInit, Component, ContentChild, ContentChildren, EventEmitter, forwardRef, HostBinding, Input, OnDestroy, OnInit, Optional, Output, QueryList, HostListener, ElementRef, ChangeDetectorRef, ViewChild } from '@angular/core';
import { Subject } from 'rxjs';
import { startWith, takeUntil } from 'rxjs/operators';
import { ContextMenuEventProviderService } from './context-menu-event-provider.service';
// Note that ContextMenuItemComponent and ContextMenuComponent are defined in the same file in order to avoid circular dependencies
var ContextMenuItemComponent = /** @class */ (function () {
    function ContextMenuItemComponent(elementRef, eventProviderService) {
        var _this = this;
        this.elementRef = elementRef;
        this.eventProviderService = eventProviderService;
        // emit the whole component, because this is only supposed to be used by within our own components, i.e.
        // between the item and the context-menu. the top-level context-menu will emit a more concise event for the user.
        this.selected = new EventEmitter();
        this.showSelected = false;
        this.itemClick = function (event) {
            if (_this.eventProviderService) {
                _this.eventProviderService.broadcastItemSelected(_this);
            }
            _this.selected.emit(_this);
            if (_this.subMenu) {
                _this.subMenu.opened = true;
            }
            event === null || event === void 0 ? void 0 : event.stopPropagation();
        };
    }
    ContextMenuItemComponent.prototype.ngOnInit = function () {
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
    };
    ContextMenuItemComponent.prototype.ngAfterContentInit = function () {
        var _this = this;
        if (this.subMenu) {
            this.subMenu.isRootMenu = false;
            this.subMenu.closeEvent.subscribe(function () {
                _this.wrapper.nativeElement.focus();
                _this.unselectSubs();
            });
        }
    };
    ContextMenuItemComponent.prototype.unselectSubs = function () {
        this.isSelected = false;
        if (this.subMenu) {
            this.subMenu.toggle(false);
            this.subMenu.unselectSubs();
        }
    };
    ContextMenuItemComponent.prototype.ngOnDestroy = function () {
        var _a;
        (_a = this.subMenu) === null || _a === void 0 ? void 0 : _a.closeEvent.unsubscribe();
    };
    ContextMenuItemComponent.ctorParameters = function () { return [
        { type: ElementRef },
        { type: ContextMenuEventProviderService, decorators: [{ type: Optional }] }
    ]; };
    __decorate([
        Input()
    ], ContextMenuItemComponent.prototype, "disabled", void 0);
    __decorate([
        Input()
    ], ContextMenuItemComponent.prototype, "icon", void 0);
    __decorate([
        Input()
    ], ContextMenuItemComponent.prototype, "labelText", void 0);
    __decorate([
        ViewChild('itemWrapper')
    ], ContextMenuItemComponent.prototype, "wrapper", void 0);
    __decorate([
        Output()
    ], ContextMenuItemComponent.prototype, "selected", void 0);
    __decorate([
        ContentChild(forwardRef(function () { return ContextMenuComponent; }))
    ], ContextMenuItemComponent.prototype, "subMenu", void 0);
    __decorate([
        HostBinding('attr.id'),
        Input()
    ], ContextMenuItemComponent.prototype, "id", void 0);
    ContextMenuItemComponent = __decorate([
        Component({
            selector: 'bmw-context-menu-item',
            template: "<div\n  #itemWrapper\n  class=\"wrapper\"\n  [class.disabled]=\"disabled\"\n  [class.selected]=\"showSelected && isSelected\"\n  [attr.aria-selected]=\"isSelected\"\n  [attr.aria-disabled]=\"disabled\"\n  tabindex=\"0\"\n>\n  <i *ngIf=\"icon\" [ngClass]=\"[icon, 'icon-left']\"></i>\n  <i *ngIf=\"subMenu\" class=\"iwp-icon-gen_arrow_right hasChild\"></i>\n  <div [class.disabled]=\"disabled\" [class.icon-left]=\"icon\" class=\"bmw-component-text\" (click)=\"itemClick($event)\">\n    {{ labelText }}\n  </div>\n  <div class=\"content-container\">\n    <ng-content></ng-content>\n  </div>\n</div>\n",
            styles: ["div.wrapper{max-height:calc(2 * var(--context-menu__default__padding) + 2 * var(--context-menu__default__line-height));position:relative;border:none;box-sizing:border-box;cursor:pointer;color:var(--context-menu__default__color);background-color:var(--context-menu__default__background-color);white-space:nowrap}div.wrapper:hover{background-color:var(--context-menu__default__hover__background-color)}div.wrapper:focus{background-color:var(--context-menu__default__hover__background-color);outline:solid 1px;outline-color:var(--color-bmw-highlight);z-index:calc(var(--context-menu__default__z-index) + 1)}div.wrapper.selected{background-color:var(--context-menu__default__selected__background-color);color:var(--context-menu__default__selected__color)}div.wrapper.selected:focus{outline:solid 1px;outline-color:var(--color-bmw-basic5);outline-offset:-3px;z-index:calc(var(--context-menu__default__z-index) + 1)}div.wrapper.disabled{background-color:var(--context-menu__default__disabled__background-color);color:var(--context-menu__default__disabled__color);pointer-events:none}div.wrapper div.bmw-component-text{width:100%;display:block;box-sizing:border-box;position:relative;overflow:hidden;padding:var(--context-menu__default__padding);color:inherit}:host[hasChild] div.wrapper div.bmw-component-text{padding-right:calc(var(--context-menu__default__padding) + var(--context-menu__default__font-size) + var(--context-menu__arrow__padding-right))}div.wrapper div.bmw-component-text.icon-left{padding-left:calc(var(--context-menu__default__padding) + var(--context-menu__default__font-size) + var(--context-menu__icon__padding-right))}div.wrapper i{height:var(--context-menu__default__font-size);width:var(--context-menu__default__font-size);top:calc(50% - var(--context-menu__default__font-size)/ 2);position:absolute;font-size:var(--context-menu__default__font-size)}div.wrapper i.icon-left{left:var(--context-menu__default__padding)}div.wrapper i.hasChild{right:var(--context-menu__arrow__padding-right)}div.wrapper i.hasChild+.bmw-component-text{padding-right:calc(var(--context-menu__default__padding) + var(--context-menu__default__font-size) + var(--context-menu__icon__padding-right))}@media all and (-ms-high-contrast:none),(-ms-high-contrast:active){:host[hasChild] div.wrapper div.bmw-component-text{padding-right:30px}div.wrapper div.bmw-component-text.icon-left{padding-left:30px}div.wrapper i.hasChild+.bmw-component-text{padding-right:30px}}div.wrapper .content-container{position:absolute;left:100%;top:-1px}:host[disabled]{cursor:no-drop}"]
        }),
        __param(1, Optional())
    ], ContextMenuItemComponent);
    return ContextMenuItemComponent;
}());
export { ContextMenuItemComponent };
// TODO idea for the future: optional close on click outside (i.e. add this as a convenience feature if menu-button is not used)
var ContextMenuComponent = /** @class */ (function () {
    function ContextMenuComponent(cdRef, elementRef) {
        this.cdRef = cdRef;
        this.elementRef = elementRef;
        this.closeOnClickOutside = true;
        this.closeOnSelected = true;
        // this is emitted in ngOnDestroy
        this._destroy = new Subject();
        /**
         * keeps the previously selected item highlited when reopening the menu (default = false)
         */
        this.keepItemSelected = false;
        /**
         * preserves the opened state of the menu after closing (default = false)
         */
        this.preserveState = false;
        this.isRootMenu = true;
        this.closeEvent = new EventEmitter();
    }
    Object.defineProperty(ContextMenuComponent.prototype, "opened", {
        get: function () {
            return this._opened;
        },
        set: function (state) {
            this.toggle(state);
        },
        enumerable: true,
        configurable: true
    });
    ContextMenuComponent.prototype.onKeydown = function (event) {
        var key = event.code || event.keyCode;
        switch (key) {
            case 'ArrowDown':
            case 40:
                this.setNextItemAsFocused(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'ArrowUp':
            case 38:
                this.setPreviousItemAsFocused(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'ArrowLeft':
            case 37:
                this.closeSubmenu(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'ArrowRight':
            case 39:
                this.openSubmenu(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'Enter':
            case 'NumpadEnter':
            case 13:
            case 'Space':
            case 32:
                this.activateItem(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'Escape':
            case 27:
                if (this._opened) {
                    this.toggle(false);
                }
                event.preventDefault();
                break;
            case 'Tab':
            case 9:
                if (this._opened && this.closeOnClickOutside) {
                    this.toggle(false);
                }
                break;
        }
    };
    ContextMenuComponent.prototype.ngOnInit = function () {
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
    };
    ContextMenuComponent.prototype.ngAfterContentInit = function () {
        var _this = this;
        this.childContextMenuItems.changes
            .pipe(
        // tslint:disable-next-line:deprecation
        startWith(null), takeUntil(this._destroy))
            .subscribe(function () {
            _this._register();
        });
        if (this.closeOnSelected) {
            this.childContextMenuItems.map(function (child) {
                if (!child.subMenu) {
                    child.selected.pipe(takeUntil(_this._destroy)).subscribe(function () {
                        _this.toggle(!_this.isRootMenu && _this.preserveState);
                    });
                }
            });
        }
    };
    ContextMenuComponent.prototype._register = function () {
        var _this = this;
        this.childContextMenuItems.forEach(function (item) {
            item.showSelected = _this.keepItemSelected;
            item.selected.pipe(takeUntil(_this._destroy)).subscribe(function (selectedItem) {
                _this._select(selectedItem);
            });
        });
    };
    ContextMenuComponent.prototype.ngOnDestroy = function () {
        this._destroy.next();
        this._destroy.complete();
        document.removeEventListener('mouseup', this.clickOutsideCallback);
        document.removeEventListener('touchend', this.clickOutsideCallback);
    };
    ContextMenuComponent.prototype._select = function (selectedItem) {
        this.childContextMenuItems.forEach(function (item) {
            if (item !== selectedItem)
                item.unselectSubs();
        });
        selectedItem.isSelected = true;
    };
    ContextMenuComponent.prototype.activateItem = function (target) {
        var focusedItem = this.childContextMenuItems.find(function (item) { return target === item.wrapper.nativeElement; });
        if (focusedItem) {
            focusedItem.itemClick();
        }
    };
    ContextMenuComponent.prototype.closeSubmenu = function (target) {
        var _a;
        if (!this.isRootMenu) {
            var focusedItem = this.childContextMenuItems.find(function (item) { return target === item.wrapper.nativeElement; });
            if (focusedItem && !((_a = focusedItem.subMenu) === null || _a === void 0 ? void 0 : _a.opened)) {
                target.blur();
                this.toggle(false);
            }
        }
    };
    ContextMenuComponent.prototype.openSubmenu = function (target) {
        var focusedItem = this.childContextMenuItems.find(function (item) { return target === item.wrapper.nativeElement; });
        if (focusedItem && focusedItem.subMenu) {
            focusedItem.itemClick();
            target.blur();
            focusedItem.subMenu.setNextItemAsFocused();
        }
    };
    ContextMenuComponent.prototype.setPreviousItemAsFocused = function (target) {
        if (this._opened &&
            this.childContextMenuItems.length > 0 &&
            this.childContextMenuItems.filter(function (item) { return !item.disabled; }).length > 0) {
            var itemsArray = this.childContextMenuItems.toArray();
            var targetItemIndex = itemsArray.findIndex(function (item) { return target === item.wrapper.nativeElement; });
            if (targetItemIndex !== -1) {
                itemsArray[targetItemIndex].wrapper.nativeElement.blur();
            }
            if (targetItemIndex > 0) {
                targetItemIndex = targetItemIndex - 1;
            }
            else {
                targetItemIndex = itemsArray.length - 1;
            }
            if (itemsArray[targetItemIndex].disabled) {
                this.setPreviousItemAsFocused(itemsArray[targetItemIndex].wrapper.nativeElement);
            }
            else {
                itemsArray[targetItemIndex].wrapper.nativeElement.focus();
            }
        }
    };
    ContextMenuComponent.prototype.setNextItemAsFocused = function (target) {
        if (this._opened &&
            this.childContextMenuItems.length > 0 &&
            this.childContextMenuItems.filter(function (item) { return !item.disabled; }).length > 0) {
            var itemsArray = this.childContextMenuItems.toArray();
            var targetItemIndex = itemsArray.findIndex(function (item) { return target === item.wrapper.nativeElement; });
            if (targetItemIndex !== -1) {
                itemsArray[targetItemIndex].wrapper.nativeElement.blur();
            }
            if (targetItemIndex !== -1 && targetItemIndex !== itemsArray.length - 1) {
                targetItemIndex = targetItemIndex + 1;
            }
            else {
                targetItemIndex = 0;
            }
            if (itemsArray[targetItemIndex].disabled) {
                this.setNextItemAsFocused(itemsArray[targetItemIndex].wrapper.nativeElement);
            }
            else {
                this.cdRef.detectChanges();
                itemsArray[targetItemIndex].wrapper.nativeElement.focus();
            }
        }
    };
    ContextMenuComponent.prototype.unselectSubs = function () {
        this.childContextMenuItems.forEach(function (item) {
            item.unselectSubs();
        });
    };
    ContextMenuComponent.prototype.toggle = function (state) {
        var _this = this;
        var focusFirstItem = false;
        var emitCloseEvent = false;
        var initialOpenedState = this._opened;
        if (typeof state !== 'undefined') {
            focusFirstItem = !this._opened && state;
            emitCloseEvent = this._opened && !state;
            this._opened = state;
        }
        else {
            this._opened = !this._opened;
            focusFirstItem = this._opened;
            emitCloseEvent = !this._opened;
        }
        if (this.opened !== initialOpenedState) {
            if (this.opened && this.closeOnClickOutside) {
                setTimeout(function () {
                    /**
                     * .toggle public use will probably be triggered by a user click.
                     * Since the event will not be passed down, we can't use .preventDefault
                     * Thus, the new listener added below will catch the event immediately
                     * and prevent the context-menu from opening.
                     * Alternative would be to timestamp this call and verify on .onClickOutside
                     * but setTimeout(0) is a universally known hack
                     */
                    _this.clickOutsideCallback = _this.onClickOutside.bind(_this);
                    document.addEventListener('mouseup', _this.clickOutsideCallback);
                    document.addEventListener('touchend', _this.clickOutsideCallback);
                }, 0);
            }
            else {
                document.removeEventListener('mouseup', this.clickOutsideCallback);
                document.removeEventListener('touchend', this.clickOutsideCallback);
            }
        }
        if (this.childContextMenuItems && focusFirstItem) {
            document.activeElement.blur();
            this.setNextItemAsFocused();
        }
        if (emitCloseEvent) {
            this.closeEvent.emit();
        }
    };
    ContextMenuComponent.prototype.onClickOutside = function (_a) {
        var target = _a.target;
        var _b;
        var grandParent = this.elementRef.nativeElement.parentElement.parentElement;
        var parentIsWrapper = grandParent.localName === 'bmw-split-button' || grandParent.localName === 'bmw-menu-button';
        var elementToCheck = parentIsWrapper
            ? this.elementRef.nativeElement.parentElement
            : this.elementRef.nativeElement;
        if (!elementToCheck.contains(target) && !((_b = target.shadowRoot) === null || _b === void 0 ? void 0 : _b.querySelector('bmw-context-menu-item'))) {
            this.opened = this.preserveState;
            document.removeEventListener('mouseup', this.clickOutsideCallback);
            document.removeEventListener('touchend', this.clickOutsideCallback);
        }
    };
    ContextMenuComponent.ctorParameters = function () { return [
        { type: ChangeDetectorRef },
        { type: ElementRef }
    ]; };
    __decorate([
        ContentChildren(ContextMenuItemComponent)
    ], ContextMenuComponent.prototype, "childContextMenuItems", void 0);
    __decorate([
        Input()
    ], ContextMenuComponent.prototype, "closeOnClickOutside", void 0);
    __decorate([
        Input()
    ], ContextMenuComponent.prototype, "closeOnSelected", void 0);
    __decorate([
        Input('opened')
    ], ContextMenuComponent.prototype, "opened", null);
    __decorate([
        HostBinding('attr.id'),
        Input()
    ], ContextMenuComponent.prototype, "id", void 0);
    __decorate([
        Input()
    ], ContextMenuComponent.prototype, "keepItemSelected", void 0);
    __decorate([
        Input()
    ], ContextMenuComponent.prototype, "preserveState", void 0);
    __decorate([
        Output()
    ], ContextMenuComponent.prototype, "closeEvent", void 0);
    __decorate([
        HostListener('keydown', ['$event'])
    ], ContextMenuComponent.prototype, "onKeydown", null);
    ContextMenuComponent = __decorate([
        Component({
            selector: 'bmw-context-menu',
            template: "<div class=\"bmw-context-menu\" [class.open]=\"opened\">\n  <ng-content></ng-content>\n</div>\n",
            styles: ["div{min-width:100px;box-sizing:border-box;border:solid 1px var(--context-menu__default_border-color);display:none;position:absolute;z-index:var(--context-menu__default__z-index)}div.open{display:block}div:focus{outline-style:none}"]
        })
    ], ContextMenuComponent);
    return ContextMenuComponent;
}());
export { ContextMenuComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BibXctZHMvY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvbnRleHQtbWVudS9jb250ZXh0LW1lbnUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFDVCxZQUFZLEVBQ1osZUFBZSxFQUNmLFlBQVksRUFDWixVQUFVLEVBQ1YsV0FBVyxFQUNYLEtBQUssRUFDTCxTQUFTLEVBQ1QsTUFBTSxFQUNOLFFBQVEsRUFDUixNQUFNLEVBQ04sU0FBUyxFQUNULFlBQVksRUFDWixVQUFVLEVBQ1YsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFFeEYsbUlBQW1JO0FBT25JO0lBeUJFLGtDQUNTLFVBQXNCLEVBQ1Qsb0JBQXFEO1FBRjNFLGlCQUdJO1FBRkssZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUNULHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBaUM7UUFmM0Usd0dBQXdHO1FBQ3hHLGlIQUFpSDtRQUVqSCxhQUFRLEdBQTJDLElBQUksWUFBWSxFQUE0QixDQUFDO1FBUWhHLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBeUJyQixjQUFTLEdBQUcsVUFBQyxLQUFrQjtZQUM3QixJQUFJLEtBQUksQ0FBQyxvQkFBb0IsRUFBRTtnQkFDN0IsS0FBSSxDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixDQUFDLEtBQUksQ0FBQyxDQUFDO2FBQ3ZEO1lBQ0QsS0FBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLENBQUM7WUFDekIsSUFB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YSxDQUFDLHVCQUF1QixFQUFDLEVBQUU7WUFDbEcsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1lBQ2pDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7WUFDbkUsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztTQUNyRTtJQUNILENBQUM7O2dCQXJRMEIsaUJBQWlCO2dCQUFxQixVQUFVOztJQXRDM0U7UUFEQyxlQUFlLENBQUMsd0JBQXdCLENBQUM7dUVBQ2lCO0lBSTNEO1FBREMsS0FBSyxFQUFFO3FFQUNtQjtJQUkzQjtRQURDLEtBQUssRUFBRTtpRUFDZTtJQUd2QjtRQURDLEtBQUssQ0FBQyxRQUFRLENBQUM7c0RBR2Y7SUFPRDtRQUZDLFdBQVcsQ0FBQyxTQUFTLENBQUM7UUFDdEIsS0FBSyxFQUFFO29EQUNHO0lBT1g7UUFEQyxLQUFLLEVBQUU7a0VBQ2lCO0lBSWhCO1FBQVIsS0FBSyxFQUFFOytEQUF1QjtJQUsvQjtRQURDLE1BQU0sRUFBRTs0REFDdUQ7SUFLaEU7UUFEQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7eURBeURuQztJQW5HVSxvQkFBb0I7UUFMaEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLGtCQUFrQjtZQUM1QiwyR0FBNEM7O1NBRTdDLENBQUM7T0FDVyxvQkFBb0IsQ0E4U2hDO0lBQUQsMkJBQUM7Q0FBQSxBQTlTRCxJQThTQztTQTlTWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBFdmVudEVtaXR0ZXIsXG4gIGZvcndhcmRSZWYsXG4gIEhvc3RCaW5kaW5nLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBPdXRwdXQsXG4gIFF1ZXJ5TGlzdCxcbiAgSG9zdExpc3RlbmVyLFxuICBFbGVtZW50UmVmLFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc3RhcnRXaXRoLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb250ZXh0TWVudUV2ZW50UHJvdmlkZXJTZXJ2aWNlIH0gZnJvbSAnLi9jb250ZXh0LW1lbnUtZXZlbnQtcHJvdmlkZXIuc2VydmljZSc7XG5cbi8vIE5vdGUgdGhhdCBDb250ZXh0TWVudUl0ZW1Db21wb25lbnQgYW5kIENvbnRleHRNZW51Q29tcG9uZW50IGFyZSBkZWZpbmVkIGluIHRoZSBzYW1lIGZpbGUgaW4gb3JkZXIgdG8gYXZvaWQgY2lyY3VsYXIgZGVwZW5kZW5jaWVzXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2Jtdy1jb250ZXh0LW1lbnUtaXRlbScsXG4gIHRlbXBsYXRlVXJsOiAnLi9jb250ZXh0LW1lbnUtaXRlbS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2NvbnRleHQtbWVudS1pdGVtLmNvbXBvbmVudC5sZXNzJ11cbn0pXG5leHBvcnQgY2xhc3MgQ29udGV4dE1lbnVJdGVtQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyQ29udGVudEluaXQge1xuICBpc1NlbGVjdGVkOiBib29sZWFuO1xuICBASW5wdXQoKVxuICBkaXNhYmxlZDogYm9vbGVhbjtcbiAgQElucHV0KClcbiAgaWNvbjogc3RyaW5nO1xuICBASW5wdXQoKVxuICBsYWJlbFRleHQ6IHN0cmluZztcblxuICBAVmlld0NoaWxkKCdpdGVtV3JhcHBlcicpXG4gIHdyYXBwZXI6IEVsZW1lbnRSZWY7XG5cbiAgLy8gZW1pdCB0aGUgd2hvbGUgY29tcG9uZW50LCBiZWNhdXNlIHRoaXMgaXMgb25seSBzdXBwb3NlZCB0byBiZSB1c2VkIGJ5IHdpdGhpbiBvdXIgb3duIGNvbXBvbmVudHMsIGkuZS5cbiAgLy8gYmV0d2VlbiB0aGUgaXRlbSBhbmQgdGhlIGNvbnRleHQtbWVudS4gdGhlIHRvcC1sZXZlbCBjb250ZXh0LW1lbnUgd2lsbCBlbWl0IGEgbW9yZSBjb25jaXNlIGV2ZW50IGZvciB0aGUgdXNlci5cbiAgQE91dHB1dCgpXG4gIHNlbGVjdGVkOiBFdmVudEVtaXR0ZXI8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50PiA9IG5ldyBFdmVudEVtaXR0ZXI8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50PigpO1xuICBAQ29udGVudENoaWxkKGZvcndhcmRSZWYoKCkgPT4gQ29udGV4dE1lbnVDb21wb25lbnQpKVxuICBzdWJNZW51OiBDb250ZXh0TWVudUNvbXBvbmVudDtcblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuaWQnKVxuICBASW5wdXQoKVxuICBpZDogc3RyaW5nO1xuXG4gIHNob3dTZWxlY3RlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZXZlbnRQcm92aWRlclNlcnZpY2U6IENvbnRleHRNZW51RXZlbnRQcm92aWRlclNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5pZCkge1xuICAgICAgdGhpcy5pZCA9IE1hdGgucmFuZG9tKClcbiAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAuc3Vic3RyaW5nKDIpO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICBpZiAodGhpcy5zdWJNZW51KSB7XG4gICAgICB0aGlzLnN1Yk1lbnUuaXNSb290TWVudSA9IGZhbHNlO1xuICAgICAgdGhpcy5zdWJNZW51LmNsb3NlRXZlbnQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdGhpcy53cmFwcGVyLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgICAgdGhpcy51bnNlbGVjdFN1YnMoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGl0ZW1DbGljayA9IChldmVudD86IE1vdXNlRXZlbnQpID0+IHtcbiAgICBpZiAodGhpcy5ldmVudFByb3ZpZGVyU2VydmljZSkge1xuICAgICAgdGhpcy5ldmVudFByb3ZpZGVyU2VydmljZS5icm9hZGNhc3RJdGVtU2VsZWN0ZWQodGhpcyk7XG4gICAgfVxuICAgIHRoaXMuc2VsZWN0ZWQuZW1pdCh0aGlzKTtcbiAgICBpZiAodGhpcy5zdWJNZW51KSB7XG4gICAgICB0aGlzLnN1Yk1lbnUub3BlbmVkID0gdHJ1ZTtcbiAgICB9XG4gICAgZXZlbnQ/LnN0b3BQcm9wYWdhdGlvbigpO1xuICB9O1xuXG4gIHVuc2VsZWN0U3VicygpIHtcbiAgICB0aGlzLmlzU2VsZWN0ZWQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5zdWJNZW51KSB7XG4gICAgICB0aGlzLnN1Yk1lbnUudG9nZ2xlKGZhbHNlKTtcbiAgICAgIHRoaXMuc3ViTWVudS51bnNlbGVjdFN1YnMoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnN1Yk1lbnU/LmNsb3NlRXZlbnQudW5zdWJzY3JpYmUoKTtcbiAgfVxufVxuXG4vLyBUT0RPIGlkZWEgZm9yIHRoZSBmdXR1cmU6IG9wdGlvbmFsIGNsb3NlIG9uIGNsaWNrIG91dHNpZGUgKGkuZS4gYWRkIHRoaXMgYXMgYSBjb252ZW5pZW5jZSBmZWF0dXJlIGlmIG1lbnUtYnV0dG9uIGlzIG5vdCB1c2VkKVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdibXctY29udGV4dC1tZW51JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2NvbnRleHQtbWVudS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2NvbnRleHQtbWVudS5jb21wb25lbnQubGVzcyddXG59KVxuZXhwb3J0IGNsYXNzIENvbnRleHRNZW51Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyQ29udGVudEluaXQge1xuICBAQ29udGVudENoaWxkcmVuKENvbnRleHRNZW51SXRlbUNvbXBvbmVudClcbiAgY2hpbGRDb250ZXh0TWVudUl0ZW1zOiBRdWVyeUxpc3Q8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50PjtcblxuICBwcml2YXRlIF9vcGVuZWQ6IGJvb2xlYW47XG4gIEBJbnB1dCgpXG4gIGNsb3NlT25DbGlja091dHNpZGUgPSB0cnVlO1xuICBjbGlja091dHNpZGVDYWxsYmFjazogKHRoaXM6IERvY3VtZW50LCBldjogTW91c2VFdmVudCkgPT4gYW55O1xuXG4gIEBJbnB1dCgpXG4gIGNsb3NlT25TZWxlY3RlZCA9IHRydWU7XG5cbiAgQElucHV0KCdvcGVuZWQnKVxuICBzZXQgb3BlbmVkKHN0YXRlOiBib29sZWFuKSB7XG4gICAgdGhpcy50b2dnbGUoc3RhdGUpO1xuICB9XG4gIGdldCBvcGVuZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX29wZW5lZDtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnYXR0ci5pZCcpXG4gIEBJbnB1dCgpXG4gIGlkOiBzdHJpbmc7XG4gIC8vIHRoaXMgaXMgZW1pdHRlZCBpbiBuZ09uRGVzdHJveVxuICBwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgLyoqXG4gICAqIGtlZXBzIHRoZSBwcmV2aW91c2x5IHNlbGVjdGVkIGl0ZW0gaGlnaGxpdGVkIHdoZW4gcmVvcGVuaW5nIHRoZSBtZW51IChkZWZhdWx0ID0gZmFsc2UpXG4gICAqL1xuICBASW5wdXQoKVxuICBrZWVwSXRlbVNlbGVjdGVkID0gZmFsc2U7XG4gIC8qKlxuICAgKiBwcmVzZXJ2ZXMgdGhlIG9wZW5lZCBzdGF0ZSBvZiB0aGUgbWVudSBhZnRlciBjbG9zaW5nIChkZWZhdWx0ID0gZmFsc2UpXG4gICAqL1xuICBASW5wdXQoKSBwcmVzZXJ2ZVN0YXRlID0gZmFsc2U7XG5cbiAgaXNSb290TWVudSA9IHRydWU7XG5cbiAgQE91dHB1dCgpXG4gIGNsb3NlRXZlbnQ6IEV2ZW50RW1pdHRlcjxib29sZWFuPiA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZiwgcHVibGljIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHt9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIG9uS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGNvbnN0IGtleSA9IGV2ZW50LmNvZGUgfHwgZXZlbnQua2V5Q29kZTtcbiAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgY2FzZSAnQXJyb3dEb3duJzpcbiAgICAgIGNhc2UgNDA6XG4gICAgICAgIHRoaXMuc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQoZXZlbnQudGFyZ2V0KTtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdBcnJvd1VwJzpcbiAgICAgIGNhc2UgMzg6XG4gICAgICAgIHRoaXMuc2V0UHJldmlvdXNJdGVtQXNGb2N1c2VkKGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnQXJyb3dMZWZ0JzpcbiAgICAgIGNhc2UgMzc6XG4gICAgICAgIHRoaXMuY2xvc2VTdWJtZW51KGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnQXJyb3dSaWdodCc6XG4gICAgICBjYXNlIDM5OlxuICAgICAgICB0aGlzLm9wZW5TdWJtZW51KGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnRW50ZXInOlxuICAgICAgY2FzZSAnTnVtcGFkRW50ZXInOlxuICAgICAgY2FzZSAxMzpcbiAgICAgIGNhc2UgJ1NwYWNlJzpcbiAgICAgIGNhc2UgMzI6XG4gICAgICAgIHRoaXMuYWN0aXZhdGVJdGVtKGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnRXNjYXBlJzpcbiAgICAgIGNhc2UgMjc6XG4gICAgICAgIGlmICh0aGlzLl9vcGVuZWQpIHtcbiAgICAgICAgICB0aGlzLnRvZ2dsZShmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ1RhYic6XG4gICAgICBjYXNlIDk6XG4gICAgICAgIGlmICh0aGlzLl9vcGVuZWQgJiYgdGhpcy5jbG9zZU9uQ2xpY2tPdXRzaWRlKSB7XG4gICAgICAgICAgdGhpcy50b2dnbGUoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5pZCkge1xuICAgICAgdGhpcy5pZCA9IE1hdGgucmFuZG9tKClcbiAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAuc3Vic3RyaW5nKDIpO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICB0aGlzLmNoaWxkQ29udGV4dE1lbnVJdGVtcy5jaGFuZ2VzXG4gICAgICAucGlwZShcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmRlcHJlY2F0aW9uXG4gICAgICAgIHN0YXJ0V2l0aCg8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50Pm51bGwpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLl9yZWdpc3RlcigpO1xuICAgICAgfSk7XG5cbiAgICBpZiAodGhpcy5jbG9zZU9uU2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLm1hcCgoY2hpbGQ6IENvbnRleHRNZW51SXRlbUNvbXBvbmVudCkgPT4ge1xuICAgICAgICBpZiAoIWNoaWxkLnN1Yk1lbnUpIHtcbiAgICAgICAgICBjaGlsZC5zZWxlY3RlZC5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95KSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlKCF0aGlzLmlzUm9vdE1lbnUgJiYgdGhpcy5wcmVzZXJ2ZVN0YXRlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgX3JlZ2lzdGVyKCkge1xuICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpdGVtLnNob3dTZWxlY3RlZCA9IHRoaXMua2VlcEl0ZW1TZWxlY3RlZDtcblxuICAgICAgaXRlbS5zZWxlY3RlZC5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95KSkuc3Vic2NyaWJlKHNlbGVjdGVkSXRlbSA9PiB7XG4gICAgICAgIHRoaXMuX3NlbGVjdChzZWxlY3RlZEl0ZW0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl9kZXN0cm95Lm5leHQoKTtcbiAgICB0aGlzLl9kZXN0cm95LmNvbXBsZXRlKCk7XG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuY2xpY2tPdXRzaWRlQ2FsbGJhY2spO1xuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gIH1cblxuICBfc2VsZWN0KHNlbGVjdGVkSXRlbSkge1xuICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpZiAoaXRlbSAhPT0gc2VsZWN0ZWRJdGVtKSBpdGVtLnVuc2VsZWN0U3VicygpO1xuICAgIH0pO1xuXG4gICAgc2VsZWN0ZWRJdGVtLmlzU2VsZWN0ZWQgPSB0cnVlO1xuICB9XG5cbiAgYWN0aXZhdGVJdGVtKHRhcmdldDogRXZlbnRUYXJnZXQpIHtcbiAgICBjb25zdCBmb2N1c2VkSXRlbSA9IHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZpbmQoaXRlbSA9PiB0YXJnZXQgPT09IGl0ZW0ud3JhcHBlci5uYXRpdmVFbGVtZW50KTtcbiAgICBpZiAoZm9jdXNlZEl0ZW0pIHtcbiAgICAgIGZvY3VzZWRJdGVtLml0ZW1DbGljaygpO1xuICAgIH1cbiAgfVxuXG4gIGNsb3NlU3VibWVudSh0YXJnZXQ6IEV2ZW50VGFyZ2V0KSB7XG4gICAgaWYgKCF0aGlzLmlzUm9vdE1lbnUpIHtcbiAgICAgIGNvbnN0IGZvY3VzZWRJdGVtID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMuZmluZChpdGVtID0+IHRhcmdldCA9PT0gaXRlbS53cmFwcGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgaWYgKGZvY3VzZWRJdGVtICYmICFmb2N1c2VkSXRlbS5zdWJNZW51Py5vcGVuZWQpIHtcbiAgICAgICAgKHRhcmdldCBhcyBIVE1MRWxlbWVudCkuYmx1cigpO1xuICAgICAgICB0aGlzLnRvZ2dsZShmYWxzZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb3BlblN1Ym1lbnUodGFyZ2V0OiBFdmVudFRhcmdldCkge1xuICAgIGNvbnN0IGZvY3VzZWRJdGVtID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMuZmluZChpdGVtID0+IHRhcmdldCA9PT0gaXRlbS53cmFwcGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgIGlmIChmb2N1c2VkSXRlbSAmJiBmb2N1c2VkSXRlbS5zdWJNZW51KSB7XG4gICAgICBmb2N1c2VkSXRlbS5pdGVtQ2xpY2soKTtcbiAgICAgICh0YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmJsdXIoKTtcbiAgICAgIGZvY3VzZWRJdGVtLnN1Yk1lbnUuc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQoKTtcbiAgICB9XG4gIH1cblxuICBzZXRQcmV2aW91c0l0ZW1Bc0ZvY3VzZWQodGFyZ2V0PzogRXZlbnRUYXJnZXQpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLl9vcGVuZWQgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmxlbmd0aCA+IDAgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZpbHRlcihpdGVtID0+ICFpdGVtLmRpc2FibGVkKS5sZW5ndGggPiAwXG4gICAgKSB7XG4gICAgICBjb25zdCBpdGVtc0FycmF5ID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMudG9BcnJheSgpO1xuICAgICAgbGV0IHRhcmdldEl0ZW1JbmRleDogbnVtYmVyID0gaXRlbXNBcnJheS5maW5kSW5kZXgoaXRlbSA9PiB0YXJnZXQgPT09IGl0ZW0ud3JhcHBlci5uYXRpdmVFbGVtZW50KTtcblxuICAgICAgaWYgKHRhcmdldEl0ZW1JbmRleCAhPT0gLTEpIHtcbiAgICAgICAgaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudC5ibHVyKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0YXJnZXRJdGVtSW5kZXggPiAwKSB7XG4gICAgICAgIHRhcmdldEl0ZW1JbmRleCA9IHRhcmdldEl0ZW1JbmRleCAtIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0YXJnZXRJdGVtSW5kZXggPSBpdGVtc0FycmF5Lmxlbmd0aCAtIDE7XG4gICAgICB9XG5cbiAgICAgIGlmIChpdGVtc0FycmF5W3RhcmdldEl0ZW1JbmRleF0uZGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5zZXRQcmV2aW91c0l0ZW1Bc0ZvY3VzZWQoaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpdGVtc0FycmF5W3RhcmdldEl0ZW1JbmRleF0ud3JhcHBlci5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQodGFyZ2V0PzogRXZlbnRUYXJnZXQpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLl9vcGVuZWQgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmxlbmd0aCA+IDAgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZpbHRlcihpdGVtID0+ICFpdGVtLmRpc2FibGVkKS5sZW5ndGggPiAwXG4gICAgKSB7XG4gICAgICBjb25zdCBpdGVtc0FycmF5ID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMudG9BcnJheSgpO1xuICAgICAgbGV0IHRhcmdldEl0ZW1JbmRleDogbnVtYmVyID0gaXRlbXNBcnJheS5maW5kSW5kZXgoaXRlbSA9PiB0YXJnZXQgPT09IGl0ZW0ud3JhcHBlci5uYXRpdmVFbGVtZW50KTtcblxuICAgICAgaWYgKHRhcmdldEl0ZW1JbmRleCAhPT0gLTEpIHtcbiAgICAgICAgaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudC5ibHVyKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0YXJnZXRJdGVtSW5kZXggIT09IC0xICYmIHRhcmdldEl0ZW1JbmRleCAhPT0gaXRlbXNBcnJheS5sZW5ndGggLSAxKSB7XG4gICAgICAgIHRhcmdldEl0ZW1JbmRleCA9IHRhcmdldEl0ZW1JbmRleCArIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0YXJnZXRJdGVtSW5kZXggPSAwO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLmRpc2FibGVkKSB7XG4gICAgICAgIHRoaXMuc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQoaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNkUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHVuc2VsZWN0U3VicygpIHtcbiAgICB0aGlzLmNoaWxkQ29udGV4dE1lbnVJdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbS51bnNlbGVjdFN1YnMoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHRvZ2dsZShzdGF0ZT86IGJvb2xlYW4pIHtcbiAgICBsZXQgZm9jdXNGaXJzdEl0ZW0gPSBmYWxzZTtcbiAgICBsZXQgZW1pdENsb3NlRXZlbnQgPSBmYWxzZTtcbiAgICBjb25zdCBpbml0aWFsT3BlbmVkU3RhdGUgPSB0aGlzLl9vcGVuZWQ7XG5cbiAgICBpZiAodHlwZW9mIHN0YXRlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgZm9jdXNGaXJzdEl0ZW0gPSAhdGhpcy5fb3BlbmVkICYmIHN0YXRlO1xuICAgICAgZW1pdENsb3NlRXZlbnQgPSB0aGlzLl9vcGVuZWQgJiYgIXN0YXRlO1xuICAgICAgdGhpcy5fb3BlbmVkID0gc3RhdGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX29wZW5lZCA9ICF0aGlzLl9vcGVuZWQ7XG4gICAgICBmb2N1c0ZpcnN0SXRlbSA9IHRoaXMuX29wZW5lZDtcbiAgICAgIGVtaXRDbG9zZUV2ZW50ID0gIXRoaXMuX29wZW5lZDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcGVuZWQgIT09IGluaXRpYWxPcGVuZWRTdGF0ZSkge1xuICAgICAgaWYgKHRoaXMub3BlbmVkICYmIHRoaXMuY2xvc2VPbkNsaWNrT3V0c2lkZSkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiAudG9nZ2xlIHB1YmxpYyB1c2Ugd2lsbCBwcm9iYWJseSBiZSB0cmlnZ2VyZWQgYnkgYSB1c2VyIGNsaWNrLlxuICAgICAgICAgICAqIFNpbmNlIHRoZSBldmVudCB3aWxsIG5vdCBiZSBwYXNzZWQgZG93biwgd2UgY2FuJ3QgdXNlIC5wcmV2ZW50RGVmYXVsdFxuICAgICAgICAgICAqIFRodXMsIHRoZSBuZXcgbGlzdGVuZXIgYWRkZWQgYmVsb3cgd2lsbCBjYXRjaCB0aGUgZXZlbnQgaW1tZWRpYXRlbHlcbiAgICAgICAgICAgKiBhbmQgcHJldmVudCB0aGUgY29udGV4dC1tZW51IGZyb20gb3BlbmluZy5cbiAgICAgICAgICAgKiBBbHRlcm5hdGl2ZSB3b3VsZCBiZSB0byB0aW1lc3RhbXAgdGhpcyBjYWxsIGFuZCB2ZXJpZnkgb24gLm9uQ2xpY2tPdXRzaWRlXG4gICAgICAgICAgICogYnV0IHNldFRpbWVvdXQoMCkgaXMgYSB1bml2ZXJzYWxseSBrbm93biBoYWNrXG4gICAgICAgICAgICovXG4gICAgICAgICAgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayA9IHRoaXMub25DbGlja091dHNpZGUuYmluZCh0aGlzKTtcbiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLmNsaWNrT3V0c2lkZUNhbGxiYWNrKTtcbiAgICAgICAgfSwgMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zICYmIGZvY3VzRmlyc3RJdGVtKSB7XG4gICAgICAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudCkuYmx1cigpO1xuICAgICAgdGhpcy5zZXROZXh0SXRlbUFzRm9jdXNlZCgpO1xuICAgIH1cblxuICAgIGlmIChlbWl0Q2xvc2VFdmVudCkge1xuICAgICAgdGhpcy5jbG9zZUV2ZW50LmVtaXQoKTtcbiAgICB9XG4gIH1cblxuICBvbkNsaWNrT3V0c2lkZSh7IHRhcmdldCB9KSB7XG4gICAgY29uc3QgZ3JhbmRQYXJlbnQgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgY29uc3QgcGFyZW50SXNXcmFwcGVyID0gZ3JhbmRQYXJlbnQubG9jYWxOYW1lID09PSAnYm13LXNwbGl0LWJ1dHRvbicgfHwgZ3JhbmRQYXJlbnQubG9jYWxOYW1lID09PSAnYm13LW1lbnUtYnV0dG9uJztcbiAgICBjb25zdCBlbGVtZW50VG9DaGVjayA9IHBhcmVudElzV3JhcHBlclxuICAgICAgPyB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50XG4gICAgICA6IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuXG4gICAgaWYgKCFlbGVtZW50VG9DaGVjay5jb250YWlucyh0YXJnZXQpICYmICF0YXJnZXQuc2hhZG93Um9vdD8ucXVlcnlTZWxlY3RvcignYm13LWNvbnRleHQtbWVudS1pdGVtJykpIHtcbiAgICAgIHRoaXMub3BlbmVkID0gdGhpcy5wcmVzZXJ2ZVN0YXRlO1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuY2xpY2tPdXRzaWRlQ2FsbGJhY2spO1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLmNsaWNrT3V0c2lkZUNhbGxiYWNrKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==