import { __decorate } from "tslib";
import { Component, OnInit, ElementRef, ContentChildren, QueryList, AfterViewInit, EventEmitter } from '@angular/core';
import { CardTabLabelComponent } from './card-tab-label.component';
let CardTabComponent = class CardTabComponent {
    constructor(elementRef) {
        this.elementRef = elementRef;
    }
    ngOnInit() {
        console.warn('Beware, this component is not prepared for production usage!');
        this.hiddenLabels = this.elementRef.nativeElement.querySelector('.three-dots');
        this.hiddenLabels.addEventListener('focusout', e => {
            const leavingParent = !this.hiddenLabels.contains(e.relatedTarget);
            if (leavingParent) {
                this.toggleHiddenLabels(false);
            }
        });
        this.enableKeyboardControl();
        this.setResizeTrigger();
        setTimeout(() => {
            this.hideLabelsIfNecessary();
        }, 10);
    }
    ngAfterViewInit() {
        this.prepareLabels();
    }
    prepareLabels() {
        this.articles = this.elementRef.nativeElement.querySelectorAll('bmw-card-tab-content');
        this.labels.toArray().forEach((labelElement, i) => {
            const label = labelElement.elementRef.nativeElement.querySelector('label');
            const closeEmitter = new EventEmitter();
            closeEmitter.emit = (closeId) => {
                this.remove(closeId);
            };
            const clickEmitter = new EventEmitter();
            clickEmitter.emit = (clickId) => {
                this.setSelected(clickId);
                this.toggleHiddenLabels(false);
            };
            labelElement.emitClose = closeEmitter;
            labelElement.emitClick = clickEmitter;
            label.dataset.order = i;
            const id = labelElement.for;
            if (typeof labelElement.selected !== 'undefined') {
                this.setSelected(id);
            }
        });
        if (!this.selected && this.labels.toArray()[0]) {
            Promise.resolve().then(() => {
                this.setSelected(this.labels.toArray()[0].for);
            });
        }
    }
    setResizeTrigger() {
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            const that = this;
            resizeTimer = setTimeout(() => {
                that.hideLabelsIfNecessary(true);
            }, 10);
        });
    }
    setSelected(selected) {
        this.selected = selected;
        this.labels.toArray().forEach((labelElement, i) => {
            const id = labelElement.for;
            if (selected === id) {
                labelElement.selected = true;
            }
            else {
                labelElement.selected = false;
            }
        });
        for (let i = 0; i < this.articles.length; i++) {
            const id = this.articles[i].getAttribute('id');
            if (selected === id) {
                this.articles[i].classList.add('selected');
            }
            else {
                this.articles[i].classList.remove('selected');
            }
        }
        setTimeout(() => {
            this.hideLabelsIfNecessary(true);
        });
    }
    remove(removedId) {
        this.labels['_results'].forEach((labelElement, i) => {
            const id = labelElement.for;
            if (removedId === id) {
                labelElement.destroy();
            }
        });
        for (let i = 0; i < this.articles.length; i++) {
            const id = this.articles[i].getAttribute('id');
            if (removedId === id) {
                this.articles[i].parentElement.removeChild(this.articles[i]);
            }
        }
        if (this.selected === removedId && this.labels.toArray().filter(e => e.destroyed === false).length > 0) {
            this.setSelected(this.labels.toArray().filter(e => e.destroyed === false)[0].for);
        }
        this.hideLabelsIfNecessary(true);
    }
    enableKeyboardControl() {
        this.elementRef.nativeElement.querySelector('.labels').addEventListener('keydown', event => {
            event.preventDefault();
            const keyName = event.key;
            if (keyName.slice(-5) === 'Right') {
                for (let i = 0; i < this.labels.length - 1; i++) {
                    const id = this.labels[i].getAttribute('for');
                    if (id === this.selected && this.labels[i + 1].getAttribute('disabled') === null) {
                        this.setSelected(this.labels[i + 1].getAttribute('for'));
                        if (this.labels[i + 1].parentElement.classList.contains('menu')) {
                            this.toggleHiddenLabels(true);
                        }
                        break;
                    }
                }
            }
            if (keyName.slice(-4) === 'Left') {
                for (let i = 1; i < this.labels.length; i++) {
                    const id = this.labels[i].getAttribute('for');
                    if (id === this.selected && this.labels[i - 1].getAttribute('disabled') === null) {
                        this.setSelected(this.labels[i - 1].getAttribute('for'));
                        if (this.labels[i - 1].parentElement.classList.contains('menu')) {
                            this.toggleHiddenLabels(true);
                        }
                        break;
                    }
                }
            }
            if (keyName.slice(0, 3) === 'Esc' || keyName === 'Enter') {
                this.toggleHiddenLabels(false);
                this.hideLabelsIfNecessary(true);
            }
        });
    }
    hideLabelsIfNecessary(showAllFirst) {
        const labelsDiv = this.elementRef.nativeElement.querySelector('div.labels');
        if (showAllFirst) {
            this.showAllLabels(labelsDiv);
        }
        const height = labelsDiv.offsetHeight;
        const defaultHeight = this.elementRef.nativeElement.querySelector('.labels .height-limiter').offsetHeight;
        if (height > defaultHeight) {
            this.createHiddenLabelsMenuElement();
            const id = this.hideLastNonActiveLabel(labelsDiv);
            if (id > 0) {
                this.hideLabelsIfNecessary();
            }
        }
    }
    showAllLabels(parentElement) {
        if (!this.hiddenLabelsMenu)
            return;
        const length = this.hiddenLabelsMenu.children.length;
        for (let i = 0; i < length; i++) {
            parentElement.append(this.hiddenLabelsMenu.children[0]);
        }
        this.hiddenLabels.removeChild(this.hiddenLabelsMenu);
        this.hiddenLabelsMenu = undefined;
        this.sort(parentElement);
    }
    sort(parentElement) {
        let array = parentElement.children;
        array = Array.from(array).sort((a, b) => {
            if (!a.querySelector('label'))
                return -1;
            if (!b.querySelector('label'))
                return 1;
            return a.querySelector('label').dataset.order - b.querySelector('label').dataset.order;
        });
        for (let i = 0; i < array.length; i++) {
            parentElement.append(array[i]);
        }
    }
    hideLastNonActiveLabel(parentElement) {
        let lastID = parentElement.querySelectorAll('.labels > bmw-card-tab-label').length - 1;
        let lastChild = parentElement.querySelectorAll('.labels > bmw-card-tab-label')[lastID];
        if (lastChild.querySelector('.selected') !== null) {
            lastID--;
            lastChild = parentElement.querySelectorAll('.labels > bmw-card-tab-label')[lastID];
        }
        if (lastChild.classList.contains('height-limiter') || lastChild.classList.contains('three-dots')) {
            return -1;
        }
        this.hiddenLabelsMenu.prepend(lastChild);
        return lastID;
    }
    createHiddenLabelsMenuElement() {
        if (this.hiddenLabelsMenu)
            return;
        this.hiddenLabelsMenu = document.createElement('div');
        this.hiddenLabelsMenu.classList.add('menu');
        this.hiddenLabels.append(this.hiddenLabelsMenu);
    }
    toggleHiddenLabels(state) {
        if (!this.hiddenLabels)
            return;
        const opened = this.hiddenLabels.classList.contains('opened');
        if (this.hiddenLabelsMenu && (state === true || opened === false)) {
            const rectangle = this.hiddenLabels.getBoundingClientRect();
            const position = rectangle.x + rectangle.width - 2;
            this.hiddenLabelsMenu.style['max-width'] = position + 'px';
        }
        if (state === true) {
            this.hiddenLabels.classList.add('opened');
        }
        else if (state === false) {
            this.hiddenLabels.classList.remove('opened');
        }
        else if (opened) {
            this.hiddenLabels.classList.remove('opened');
        }
        else {
            this.hiddenLabels.classList.add('opened');
        }
    }
};
CardTabComponent.ctorParameters = () => [
    { type: ElementRef }
];
__decorate([
    ContentChildren(CardTabLabelComponent)
], CardTabComponent.prototype, "labels", void 0);
CardTabComponent = __decorate([
    Component({
        selector: 'bmw-card-tab',
        template: "<div class=\"wrapper\">\n  <div class=\"labels\" tabindex=\"0\">\n    <div class=\"three-dots\" (click)=\"toggleHiddenLabels()\" tabindex=\"0\"></div>\n    <div class=\"height-limiter\"></div>\n    <ng-content select=\"bmw-card-tab-label\"></ng-content>\n  </div>\n  <ng-content select=\"bmw-card-tab-content\"></ng-content>\n</div>\n",
        styles: [".three-dots{position:absolute;bottom:0;right:0;display:inline-block;order:2;box-sizing:card-box;height:var(--card-tabs__label__default__height)}.three-dots:empty{display:none}.three-dots:focus{outline:0;background-color:var(--card-tabs__more-dots__selected__background-color)}.three-dots .menu{display:none;position:absolute;background-color:var(--card-tabs__more-dots__menu__background-color);top:100%;right:0;z-index:var(--card-tabs__menu__z-index);border:solid 2px var(--card-tabs__more-dots__menu__border-color)}.three-dots .menu ::ng-deep bmw-card-tab-label{display:block;max-width:100%}.three-dots.opened .menu{display:inline-block}.three-dots::after{display:inline-block;line-height:var(--card-tabs__label__icon__font-size);font-size:var(--card-tabs__label__icon__font-size);padding:var(--card-tabs__label__icon__padding);padding-bottom:calc(var(--card-tabs__label__icon__padding) - 2px);font-family:iwp;color:var(--card-tabs__labels__default__color);content:'\\ea22'}.labels{padding-right:var(--card-tabs__label__default__height);position:relative;display:flex;flex:1 0 auto;flex-wrap:wrap}.labels:focus{outline:0}.labels .height-limiter{position:absolute;width:100%;z-index:-9;left:0;top:0;height:calc(var(--card-tabs__label__default__height) + 2px);box-sizing:border-box}.wrapper{min-width:calc(100px + var(--card-tabs__label__default__height))}"]
    })
], CardTabComponent);
export { CardTabComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FyZC10YWIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGJtdy1kcy9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY2FyZC10YWIvY2FyZC10YWIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZILE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBT25FLElBQWEsZ0JBQWdCLEdBQTdCLE1BQWEsZ0JBQWdCO0lBTzNCLFlBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7SUFBRyxDQUFDO0lBRTlDLFFBQVE7UUFDTixPQUFPLENBQUMsSUFBSSxDQUFDLDhEQUE4RCxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFL0UsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDakQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDbkUsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNoQztRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFN0IsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQy9CLENBQUMsRUFBRSxFQUFF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LDBWQUF3Qzs7S0FFekMsQ0FBQztHQUNXLGdCQUFnQixDQWdQNUI7U0FoUFksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIEVsZW1lbnRSZWYsIENvbnRlbnRDaGlsZHJlbiwgUXVlcnlMaXN0LCBBZnRlclZpZXdJbml0LCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENhcmRUYWJMYWJlbENvbXBvbmVudCB9IGZyb20gJy4vY2FyZC10YWItbGFiZWwuY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYm13LWNhcmQtdGFiJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2NhcmQtdGFiLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY2FyZC10YWIuY29tcG9uZW50Lmxlc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBDYXJkVGFiQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcbiAgQENvbnRlbnRDaGlsZHJlbihDYXJkVGFiTGFiZWxDb21wb25lbnQpXG4gIGxhYmVsczogUXVlcnlMaXN0PENhcmRUYWJMYWJlbENvbXBvbmVudD47XG4gIGFydGljbGVzOiBhbnlbXTtcbiAgc2VsZWN0ZWQ6IHN0cmluZztcbiAgaGlkZGVuTGFiZWxzOiBhbnk7XG4gIGhpZGRlbkxhYmVsc01lbnU6IGFueTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbnNvbGUud2FybignQmV3YXJlLCB0aGlzIGNvbXBvbmVudCBpcyBub3QgcHJlcGFyZWQgZm9yIHByb2R1Y3Rpb24gdXNhZ2UhJyk7XG4gICAgdGhpcy5oaWRkZW5MYWJlbHMgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcudGhyZWUtZG90cycpO1xuXG4gICAgdGhpcy5oaWRkZW5MYWJlbHMuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXNvdXQnLCBlID0+IHtcbiAgICAgIGNvbnN0IGxlYXZpbmdQYXJlbnQgPSAhdGhpcy5oaWRkZW5MYWJlbHMuY29udGFpbnMoZS5yZWxhdGVkVGFyZ2V0KTtcbiAgICAgIGlmIChsZWF2aW5nUGFyZW50KSB7XG4gICAgICAgIHRoaXMudG9nZ2xlSGlkZGVuTGFiZWxzKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuZW5hYmxlS2V5Ym9hcmRDb250cm9sKCk7XG5cbiAgICB0aGlzLnNldFJlc2l6ZVRyaWdnZXIoKTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuaGlkZUxhYmVsc0lmTmVjZXNzYXJ5KCk7XG4gICAgfSwgMTApO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMucHJlcGFyZUxhYmVscygpO1xuICB9XG5cbiAgcHJlcGFyZUxhYmVscygpIHtcbiAgICB0aGlzLmFydGljbGVzID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnYm13LWNhcmQtdGFiLWNvbnRlbnQnKTtcblxuICAgIHRoaXMubGFiZWxzLnRvQXJyYXkoKS5mb3JFYWNoKChsYWJlbEVsZW1lbnQsIGkpID0+IHtcbiAgICAgIGNvbnN0IGxhYmVsID0gbGFiZWxFbGVtZW50LmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdsYWJlbCcpO1xuICAgICAgY29uc3QgY2xvc2VFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG4gICAgICBjbG9zZUVtaXR0ZXIuZW1pdCA9IChjbG9zZUlkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdGhpcy5yZW1vdmUoY2xvc2VJZCk7XG4gICAgICB9O1xuICAgICAgY29uc3QgY2xpY2tFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG4gICAgICBjbGlja0VtaXR0ZXIuZW1pdCA9IChjbGlja0lkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTZWxlY3RlZChjbGlja0lkKTtcblxuICAgICAgICB0aGlzLnRvZ2dsZUhpZGRlbkxhYmVscyhmYWxzZSk7XG4gICAgICB9O1xuICAgICAgbGFiZWxFbGVtZW50LmVtaXRDbG9zZSA9IGNsb3NlRW1pdHRlcjtcbiAgICAgIGxhYmVsRWxlbWVudC5lbWl0Q2xpY2sgPSBjbGlja0VtaXR0ZXI7XG4gICAgICBsYWJlbC5kYXRhc2V0Lm9yZGVyID0gaTtcbiAgICAgIGNvbnN0IGlkID0gbGFiZWxFbGVtZW50LmZvcjtcbiAgICAgIGlmICh0eXBlb2YgbGFiZWxFbGVtZW50LnNlbGVjdGVkICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICB0aGlzLnNldFNlbGVjdGVkKGlkKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmICghdGhpcy5zZWxlY3RlZCAmJiB0aGlzLmxhYmVscy50b0FycmF5KClbMF0pIHtcbiAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFNlbGVjdGVkKHRoaXMubGFiZWxzLnRvQXJyYXkoKVswXS5mb3IpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgc2V0UmVzaXplVHJpZ2dlcigpIHtcbiAgICBsZXQgcmVzaXplVGltZXI7XG5cbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgKCkgPT4ge1xuICAgICAgY2xlYXJUaW1lb3V0KHJlc2l6ZVRpbWVyKTtcbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgcmVzaXplVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhhdC5oaWRlTGFiZWxzSWZOZWNlc3NhcnkodHJ1ZSk7XG4gICAgICB9LCAxMCk7XG4gICAgfSk7XG4gIH1cblxuICBzZXRTZWxlY3RlZChzZWxlY3RlZDogc3RyaW5nKSB7XG4gICAgdGhpcy5zZWxlY3RlZCA9IHNlbGVjdGVkO1xuICAgIHRoaXMubGFiZWxzLnRvQXJyYXkoKS5mb3JFYWNoKChsYWJlbEVsZW1lbnQsIGkpID0+IHtcbiAgICAgIGNvbnN0IGlkID0gbGFiZWxFbGVtZW50LmZvcjtcbiAgICAgIGlmIChzZWxlY3RlZCA9PT0gaWQpIHtcbiAgICAgICAgbGFiZWxFbGVtZW50LnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxhYmVsRWxlbWVudC5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hcnRpY2xlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLmFydGljbGVzW2ldLmdldEF0dHJpYnV0ZSgnaWQnKTtcbiAgICAgIGlmIChzZWxlY3RlZCA9PT0gaWQpIHtcbiAgICAgICAgdGhpcy5hcnRpY2xlc1tpXS5jbGFzc0xpc3QuYWRkKCdzZWxlY3RlZCcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5hcnRpY2xlc1tpXS5jbGFzc0xpc3QucmVtb3ZlKCdzZWxlY3RlZCcpO1xuICAgICAgfVxuICAgIH1cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuaGlkZUxhYmVsc0lmTmVjZXNzYXJ5KHRydWUpO1xuICAgIH0pO1xuICB9XG5cbiAgcmVtb3ZlKHJlbW92ZWRJZDogc3RyaW5nKSB7XG4gICAgdGhpcy5sYWJlbHNbJ19yZXN1bHRzJ10uZm9yRWFjaCgobGFiZWxFbGVtZW50LCBpKSA9PiB7XG4gICAgICBjb25zdCBpZCA9IGxhYmVsRWxlbWVudC5mb3I7XG4gICAgICBpZiAocmVtb3ZlZElkID09PSBpZCkge1xuICAgICAgICBsYWJlbEVsZW1lbnQuZGVzdHJveSgpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hcnRpY2xlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLmFydGljbGVzW2ldLmdldEF0dHJpYnV0ZSgnaWQnKTtcbiAgICAgIGlmIChyZW1vdmVkSWQgPT09IGlkKSB7XG4gICAgICAgIHRoaXMuYXJ0aWNsZXNbaV0ucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLmFydGljbGVzW2ldKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWQgPT09IHJlbW92ZWRJZCAmJiB0aGlzLmxhYmVscy50b0FycmF5KCkuZmlsdGVyKGUgPT4gZS5kZXN0cm95ZWQgPT09IGZhbHNlKS5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnNldFNlbGVjdGVkKHRoaXMubGFiZWxzLnRvQXJyYXkoKS5maWx0ZXIoZSA9PiBlLmRlc3Ryb3llZCA9PT0gZmFsc2UpWzBdLmZvcik7XG4gICAgfVxuICAgIHRoaXMuaGlkZUxhYmVsc0lmTmVjZXNzYXJ5KHRydWUpO1xuICB9XG5cbiAgZW5hYmxlS2V5Ym9hcmRDb250cm9sKCkge1xuICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5sYWJlbHMnKS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgZXZlbnQgPT4ge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGNvbnN0IGtleU5hbWUgPSBldmVudC5rZXk7XG4gICAgICBpZiAoa2V5TmFtZS5zbGljZSgtNSkgPT09ICdSaWdodCcpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmxhYmVscy5sZW5ndGggLSAxOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBpZCA9IHRoaXMubGFiZWxzW2ldLmdldEF0dHJpYnV0ZSgnZm9yJyk7XG4gICAgICAgICAgaWYgKGlkID09PSB0aGlzLnNlbGVjdGVkICYmIHRoaXMubGFiZWxzW2kgKyAxXS5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U2VsZWN0ZWQodGhpcy5sYWJlbHNbaSArIDFdLmdldEF0dHJpYnV0ZSgnZm9yJykpO1xuICAgICAgICAgICAgaWYgKHRoaXMubGFiZWxzW2kgKyAxXS5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygnbWVudScpKSB7XG4gICAgICAgICAgICAgIHRoaXMudG9nZ2xlSGlkZGVuTGFiZWxzKHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoa2V5TmFtZS5zbGljZSgtNCkgPT09ICdMZWZ0Jykge1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHRoaXMubGFiZWxzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgaWQgPSB0aGlzLmxhYmVsc1tpXS5nZXRBdHRyaWJ1dGUoJ2ZvcicpO1xuICAgICAgICAgIGlmIChpZCA9PT0gdGhpcy5zZWxlY3RlZCAmJiB0aGlzLmxhYmVsc1tpIC0gMV0uZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpID09PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLnNldFNlbGVjdGVkKHRoaXMubGFiZWxzW2kgLSAxXS5nZXRBdHRyaWJ1dGUoJ2ZvcicpKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmxhYmVsc1tpIC0gMV0ucGFyZW50RWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoJ21lbnUnKSkge1xuICAgICAgICAgICAgICB0aGlzLnRvZ2dsZUhpZGRlbkxhYmVscyh0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGtleU5hbWUuc2xpY2UoMCwgMykgPT09ICdFc2MnIHx8IGtleU5hbWUgPT09ICdFbnRlcicpIHtcbiAgICAgICAgdGhpcy50b2dnbGVIaWRkZW5MYWJlbHMoZmFsc2UpO1xuICAgICAgICB0aGlzLmhpZGVMYWJlbHNJZk5lY2Vzc2FyeSh0cnVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGhpZGVMYWJlbHNJZk5lY2Vzc2FyeShzaG93QWxsRmlyc3Q/OiBib29sZWFuKSB7XG4gICAgY29uc3QgbGFiZWxzRGl2ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignZGl2LmxhYmVscycpO1xuICAgIGlmIChzaG93QWxsRmlyc3QpIHtcbiAgICAgIHRoaXMuc2hvd0FsbExhYmVscyhsYWJlbHNEaXYpO1xuICAgIH1cbiAgICBjb25zdCBoZWlnaHQgPSBsYWJlbHNEaXYub2Zmc2V0SGVpZ2h0O1xuICAgIGNvbnN0IGRlZmF1bHRIZWlnaHQgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcubGFiZWxzIC5oZWlnaHQtbGltaXRlcicpLm9mZnNldEhlaWdodDtcbiAgICBpZiAoaGVpZ2h0ID4gZGVmYXVsdEhlaWdodCkge1xuICAgICAgdGhpcy5jcmVhdGVIaWRkZW5MYWJlbHNNZW51RWxlbWVudCgpO1xuICAgICAgY29uc3QgaWQgPSB0aGlzLmhpZGVMYXN0Tm9uQWN0aXZlTGFiZWwobGFiZWxzRGl2KTtcbiAgICAgIGlmIChpZCA+IDApIHtcbiAgICAgICAgdGhpcy5oaWRlTGFiZWxzSWZOZWNlc3NhcnkoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzaG93QWxsTGFiZWxzKHBhcmVudEVsZW1lbnQpIHtcbiAgICBpZiAoIXRoaXMuaGlkZGVuTGFiZWxzTWVudSkgcmV0dXJuO1xuXG4gICAgY29uc3QgbGVuZ3RoID0gdGhpcy5oaWRkZW5MYWJlbHNNZW51LmNoaWxkcmVuLmxlbmd0aDtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgIHBhcmVudEVsZW1lbnQuYXBwZW5kKHRoaXMuaGlkZGVuTGFiZWxzTWVudS5jaGlsZHJlblswXSk7XG4gICAgfVxuXG4gICAgdGhpcy5oaWRkZW5MYWJlbHMucmVtb3ZlQ2hpbGQodGhpcy5oaWRkZW5MYWJlbHNNZW51KTtcbiAgICB0aGlzLmhpZGRlbkxhYmVsc01lbnUgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5zb3J0KHBhcmVudEVsZW1lbnQpO1xuICB9XG5cbiAgc29ydChwYXJlbnRFbGVtZW50KSB7XG4gICAgbGV0IGFycmF5ID0gcGFyZW50RWxlbWVudC5jaGlsZHJlbjtcbiAgICBhcnJheSA9IEFycmF5LmZyb20oYXJyYXkpLnNvcnQoKGE6IGFueSwgYjogYW55KSA9PiB7XG4gICAgICBpZiAoIWEucXVlcnlTZWxlY3RvcignbGFiZWwnKSkgcmV0dXJuIC0xO1xuICAgICAgaWYgKCFiLnF1ZXJ5U2VsZWN0b3IoJ2xhYmVsJykpIHJldHVybiAxO1xuXG4gICAgICByZXR1cm4gYS5xdWVyeVNlbGVjdG9yKCdsYWJlbCcpLmRhdGFzZXQub3JkZXIgLSBiLnF1ZXJ5U2VsZWN0b3IoJ2xhYmVsJykuZGF0YXNldC5vcmRlcjtcbiAgICB9KTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBwYXJlbnRFbGVtZW50LmFwcGVuZChhcnJheVtpXSk7XG4gICAgfVxuICB9XG5cbiAgaGlkZUxhc3ROb25BY3RpdmVMYWJlbChwYXJlbnRFbGVtZW50OiBhbnkpOiBudW1iZXIge1xuICAgIGxldCBsYXN0SUQgPSBwYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5sYWJlbHMgPiBibXctY2FyZC10YWItbGFiZWwnKS5sZW5ndGggLSAxO1xuICAgIGxldCBsYXN0Q2hpbGQgPSBwYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5sYWJlbHMgPiBibXctY2FyZC10YWItbGFiZWwnKVtsYXN0SURdO1xuXG4gICAgaWYgKGxhc3RDaGlsZC5xdWVyeVNlbGVjdG9yKCcuc2VsZWN0ZWQnKSAhPT0gbnVsbCkge1xuICAgICAgbGFzdElELS07XG4gICAgICBsYXN0Q2hpbGQgPSBwYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5sYWJlbHMgPiBibXctY2FyZC10YWItbGFiZWwnKVtsYXN0SURdO1xuICAgIH1cblxuICAgIGlmIChsYXN0Q2hpbGQuY2xhc3NMaXN0LmNvbnRhaW5zKCdoZWlnaHQtbGltaXRlcicpIHx8IGxhc3RDaGlsZC5jbGFzc0xpc3QuY29udGFpbnMoJ3RocmVlLWRvdHMnKSkge1xuICAgICAgcmV0dXJuIC0xO1xuICAgIH1cblxuICAgIHRoaXMuaGlkZGVuTGFiZWxzTWVudS5wcmVwZW5kKGxhc3RDaGlsZCk7XG4gICAgcmV0dXJuIGxhc3RJRDtcbiAgfVxuXG4gIGNyZWF0ZUhpZGRlbkxhYmVsc01lbnVFbGVtZW50KCkge1xuICAgIGlmICh0aGlzLmhpZGRlbkxhYmVsc01lbnUpIHJldHVybjtcblxuICAgIHRoaXMuaGlkZGVuTGFiZWxzTWVudSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIHRoaXMuaGlkZGVuTGFiZWxzTWVudS5jbGFzc0xpc3QuYWRkKCdtZW51Jyk7XG4gICAgdGhpcy5oaWRkZW5MYWJlbHMuYXBwZW5kKHRoaXMuaGlkZGVuTGFiZWxzTWVudSk7XG4gIH1cblxuICB0b2dnbGVIaWRkZW5MYWJlbHMoc3RhdGU/OiBib29sZWFuKSB7XG4gICAgaWYgKCF0aGlzLmhpZGRlbkxhYmVscykgcmV0dXJuO1xuICAgIGNvbnN0IG9wZW5lZCA9IHRoaXMuaGlkZGVuTGFiZWxzLmNsYXNzTGlzdC5jb250YWlucygnb3BlbmVkJyk7XG5cbiAgICBpZiAodGhpcy5oaWRkZW5MYWJlbHNNZW51ICYmIChzdGF0ZSA9PT0gdHJ1ZSB8fCBvcGVuZWQgPT09IGZhbHNlKSkge1xuICAgICAgY29uc3QgcmVjdGFuZ2xlID0gdGhpcy5oaWRkZW5MYWJlbHMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHJlY3RhbmdsZS54ICsgcmVjdGFuZ2xlLndpZHRoIC0gMjtcbiAgICAgIHRoaXMuaGlkZGVuTGFiZWxzTWVudS5zdHlsZVsnbWF4LXdpZHRoJ10gPSBwb3NpdGlvbiArICdweCc7XG4gICAgfVxuXG4gICAgaWYgKHN0YXRlID09PSB0cnVlKSB7XG4gICAgICB0aGlzLmhpZGRlbkxhYmVscy5jbGFzc0xpc3QuYWRkKCdvcGVuZWQnKTtcbiAgICB9IGVsc2UgaWYgKHN0YXRlID09PSBmYWxzZSkge1xuICAgICAgdGhpcy5oaWRkZW5MYWJlbHMuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbmVkJyk7XG4gICAgfSBlbHNlIGlmIChvcGVuZWQpIHtcbiAgICAgIHRoaXMuaGlkZGVuTGFiZWxzLmNsYXNzTGlzdC5yZW1vdmUoJ29wZW5lZCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmhpZGRlbkxhYmVscy5jbGFzc0xpc3QuYWRkKCdvcGVuZWQnKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==