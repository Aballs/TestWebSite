import { __decorate } from "tslib";
import { Component, OnInit, Input, Output, EventEmitter, HostListener, HostBinding, OnChanges, SimpleChanges, ElementRef, AfterViewInit } from '@angular/core';
const SUPPORTED_TYPES = ['info', 'success', 'warning', 'error'];
let DialogComponent = class DialogComponent {
    constructor(elemRef) {
        this.elemRef = elemRef;
        this._type = '';
        this.allowToOverflow = false;
        this.primaryClick = new EventEmitter();
        this.secondaryClick = new EventEmitter();
        this.closeClick = new EventEmitter();
        this.nonModalNodes = [];
    }
    get type() {
        return this._type;
    }
    set type(value) {
        if (SUPPORTED_TYPES.indexOf(value) === -1) {
            console.warn(`Invalid or unsupported type: ${value}`);
            this._type = SUPPORTED_TYPES[0];
        }
        else {
            this._type = value;
        }
    }
    onEscKeydownHandler(event) {
        if (this.show) {
            this.show = false;
            this.closeClick.emit();
        }
        event.stopPropagation();
    }
    ngOnInit() {
        if (!this.type)
            this.type = SUPPORTED_TYPES[0];
        if (!this.id)
            this.id = Math.random()
                .toString(36)
                .substring(2);
    }
    ngOnChanges(changes) {
        var _a, _b, _c;
        if (((_a = changes.show) === null || _a === void 0 ? void 0 : _a.currentValue) === true) {
            this.invokingElement = document.activeElement;
            this.applyFocusTrapInDialog();
        }
        else if (((_b = changes.show) === null || _b === void 0 ? void 0 : _b.currentValue) === false) {
            this.removeFocusTrapFromDialog();
            (_c = this.invokingElement) === null || _c === void 0 ? void 0 : _c.focus();
        }
    }
    ngAfterViewInit() {
        if (this.show) {
            this.applyFocusTrapInDialog();
        }
    }
    closeButtonClick() {
        if (!this.closeButton)
            return;
        this.closeClick.emit();
    }
    primaryButtonClick() {
        this.primaryClick.emit();
    }
    secondaryButtonClick() {
        this.secondaryClick.emit();
    }
    applyFocusTrapInDialog() {
        this.nonModalNodes = [];
        this.getAllTabbableElements().forEach(element => {
            if (!this.elemRef.nativeElement.contains(element)) {
                const prevTabIndex = element.getAttribute('tabindex');
                element.setAttribute('tabindex', '-1');
                element.style.outline = 'none';
                this.nonModalNodes.push({ element: element, prevTabIndex: prevTabIndex });
            }
        });
    }
    removeFocusTrapFromDialog() {
        for (let i = 0, l = this.nonModalNodes.length; i < l; i++) {
            const node = this.nonModalNodes[i];
            if (node.prevTabIndex) {
                node.element.setAttribute('tabindex', node.prevTabIndex);
                node.prevTabIndex = null;
            }
            else {
                node.element.removeAttribute('tabindex');
            }
            node.element.style.outline = null;
        }
    }
    getAllTabbableElements() {
        return document.querySelectorAll(`body
        a[href]:not([tabindex="-1"]),
        area[href]:not([tabindex="-1"]),
        input:not([tabindex="-1"]),
        select:not([tabindex="-1"]),
        textarea:not([tabindex="-1"]),
        button:not([tabindex="-1"]),
        iframe:not([tabindex="-1"]),
        object:not([tabindex="-1"]),
        embed:not([tabindex="-1"]),
        [tabindex]:not([tabindex="-1"]),
        [contenteditable]:not([tabindex="-1"])`);
    }
};
DialogComponent.ctorParameters = () => [
    { type: ElementRef }
];
__decorate([
    Input()
], DialogComponent.prototype, "allowToOverflow", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "type", null);
__decorate([
    HostBinding('attr.id'),
    Input()
], DialogComponent.prototype, "id", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "show", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "title", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "primaryLabel", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "secondaryLabel", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "primaryDisabled", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "secondaryDisabled", void 0);
__decorate([
    Input()
], DialogComponent.prototype, "closeButton", void 0);
__decorate([
    Output()
], DialogComponent.prototype, "primaryClick", void 0);
__decorate([
    Output()
], DialogComponent.prototype, "secondaryClick", void 0);
__decorate([
    Output()
], DialogComponent.prototype, "closeClick", void 0);
__decorate([
    HostListener('body:keydown.esc', ['$event'])
], DialogComponent.prototype, "onEscKeydownHandler", null);
DialogComponent = __decorate([
    Component({
        selector: 'bmw-dialog',
        template: "<div class=\"wrapper\" *ngIf=\"show\">\n  <div class=\"dialog\" [ngClass]=\"type\" role=\"dialog\" aria-modal=\"true\" [attr.aria-label]=\"title\">\n    <div class=\"title bmw-component-headline-text\" [class.closable]=\"closeButton\">{{ title }}</div>\n    <div class=\"dialog-close-icon\">\n      <bmw-icon-button\n        class=\"dialog-close-icon\"\n        *ngIf=\"closeButton\"\n        iconClass=\"iwp-icon-gen_close\"\n        (clickEvent)=\"closeButtonClick()\"\n      ></bmw-icon-button>\n    </div>\n    <div class=\"separator\"></div>\n    <div class=\"content bmw-component-text\" [ngClass]=\"{ 'content-allow-to-overflow': allowToOverflow }\">\n      <ng-content></ng-content>\n    </div>\n    <div class=\"buttons\">\n      <bmw-button\n        *ngIf=\"primaryLabel\"\n        [disabled]=\"primaryDisabled\"\n        (clickEvent)=\"primaryButtonClick()\"\n        button=\"primary\"\n        >{{ primaryLabel }}</bmw-button\n      >\n      <bmw-button\n        *ngIf=\"secondaryLabel\"\n        [disabled]=\"secondaryDisabled\"\n        (clickEvent)=\"secondaryButtonClick()\"\n        button=\"secondary\"\n        >{{ secondaryLabel }}</bmw-button\n      >\n    </div>\n  </div>\n</div>\n",
        styles: [":host .wrapper{position:fixed;height:100%;width:100%;left:0;top:0;overflow:hidden;z-index:var(--dialog__default__backdrop-z-index);background-color:var(--dialog__default__backdrop-background-color)}:host .wrapper .dialog{position:relative;display:flex;flex-flow:column;min-width:0;min-height:0;max-height:80vh;top:50%;left:50%;transform:translate(-50%,-50%);box-sizing:border-box;max-width:var(--dialog__default__width);padding:var(--spacing-bmw-xs) var(--spacing-bmw-s);background-color:var(--dialog__default__backdrop-box-background-color);box-shadow:0 0 var(--dialog__default__backdrop-box-shadow-width) 0 var(--dialog__default__backdrop-box-shadow-color)}@media all and (-ms-high-contrast:none),(-ms-high-contrast:active){:host .wrapper .dialog{max-height:auto;height:300px}}:host .wrapper ::ng-deep .dialog-close-icon bmw-icon-button{position:absolute;top:var(--spacing-bmw-xxs);right:var(--spacing-bmw-xxs)}:host .wrapper ::ng-deep .dialog-close-icon bmw-icon-button button{font-size:var(--dialog__icon-button__font-size)!important;line-height:var(--dialog__title__line-height)!important}.title{padding-bottom:var(--spacing-bmw-xxs);line-height:var(--dialog__title__line-height)!important;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0}.title.closable{padding-right:calc(var(--icon-button__medium__font-size) + 2 * var(--icon-button__medium__padding) + var(--spacing-bmw-xxs) - var(--spacing-bmw-s))}.separator{height:var(--spacing-bmw-xxs);margin:0 calc(0px - var(--spacing-bmw-s));margin-bottom:var(--spacing-bmw-s);flex-shrink:0}.info .separator{background-color:var(--dialog__default__separator__background-color)}.success .separator{background-color:var(--dialog__success__separator__background-color)}.warning .separator{background-color:var(--dialog__warning__separator__background-color)}.error .separator{background-color:var(--dialog__error__separator__background-color)}.content{margin-bottom:var(--spacing-bmw-s);overflow:auto;min-width:0;min-height:0}.content-allow-to-overflow{overflow:visible}.buttons{flex-shrink:0;display:flex;flex-flow:row-reverse;flex-wrap:wrap-reverse}.buttons bmw-button{margin-left:var(--spacing-bmw-xs)}"]
    })
], DialogComponent);
export { DialogComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BibXctZHMvY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImRpYWxvZy9kaWFsb2cuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixZQUFZLEVBQ1osV0FBVyxFQUNYLFNBQVMsRUFDVCxhQUFhLEVBQ2IsVUFBVSxFQUNWLGFBQWEsRUFDZCxNQUFNLGVBQWUsQ0FBQztBQUN2QixNQUFNLGVBQWUsR0FBRyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBWWhFLElBQWEsZUFBZSxHQUE1QixNQUFhLGVBQWU7SUF3RDFCLFlBQW9CLE9BQW1CO1FBQW5CLFlBQU8sR0FBUCxPQUFPLENBQVk7UUF2RDdCLFVBQUssR0FBRyxFQUFFLENBQUM7UUFNWixvQkFBZSxHQUFHLEtBQUssQ0FBQztRQThCakMsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRWxDLG1CQUFjLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUVwQyxlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUV4QixrQkFBYSxHQUFZLEVBQUUsQ0FBQztJQWFNLENBQUM7SUFyRDNDLElBQUksSUFBSTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBS0QsSUFBSSxJQUFJLENBQUMsS0FBYTtRQUNwQixJQUFJLGVBQWUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDekMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsS0FBSyxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNqQzthQUFNO1lBQ0ws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ZW50LFxuICBPbkluaXQsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSG9zdExpc3RlbmVyLFxuICBIb3N0QmluZGluZyxcbiAgT25DaGFuZ2VzLFxuICBTaW1wbGVDaGFuZ2VzLFxuICBFbGVtZW50UmVmLFxuICBBZnRlclZpZXdJbml0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuY29uc3QgU1VQUE9SVEVEX1RZUEVTID0gWydpbmZvJywgJ3N1Y2Nlc3MnLCAnd2FybmluZycsICdlcnJvciddO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5vZGVzIHtcbiAgZWxlbWVudDogRWxlbWVudDtcbiAgcHJldlRhYkluZGV4OiBzdHJpbmc7XG59XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2Jtdy1kaWFsb2cnLFxuICB0ZW1wbGF0ZVVybDogJy4vZGlhbG9nLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZGlhbG9nLmNvbXBvbmVudC5sZXNzJ11cbn0pXG5leHBvcnQgY2xhc3MgRGlhbG9nQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIEFmdGVyVmlld0luaXQge1xuICBwcm90ZWN0ZWQgX3R5cGUgPSAnJztcblxuICBnZXQgdHlwZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fdHlwZTtcbiAgfVxuXG4gIEBJbnB1dCgpIGFsbG93VG9PdmVyZmxvdyA9IGZhbHNlO1xuXG4gIEBJbnB1dCgpXG4gIHNldCB0eXBlKHZhbHVlOiBzdHJpbmcpIHtcbiAgICBpZiAoU1VQUE9SVEVEX1RZUEVTLmluZGV4T2YodmFsdWUpID09PSAtMSkge1xuICAgICAgY29uc29sZS53YXJuKGBJbnZhbGlkIG9yIHVuc3VwcG9ydGVkIHR5cGU6ICR7dmFsdWV9YCk7XG4gICAgICB0aGlzLl90eXBlID0gU1VQUE9SVEVEX1RZUEVTWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl90eXBlID0gdmFsdWU7XG4gICAgfVxuICB9XG4gIEBIb3N0QmluZGluZygnYXR0ci5pZCcpXG4gIEBJbnB1dCgpXG4gIGlkOiBzdHJpbmc7XG5cbiAgQElucHV0KClcbiAgc2hvdzogYm9vbGVhbjtcbiAgQElucHV0KClcbiAgdGl0bGU6IHN0cmluZztcbiAgQElucHV0KClcbiAgcHJpbWFyeUxhYmVsOiBzdHJpbmc7XG4gIEBJbnB1dCgpXG4gIHNlY29uZGFyeUxhYmVsOiBzdHJpbmc7XG4gIEBJbnB1dCgpXG4gIHByaW1hcnlEaXNhYmxlZDogYm9vbGVhbjtcbiAgQElucHV0KClcbiAgc2Vjb25kYXJ5RGlzYWJsZWQ6IGJvb2xlYW47XG4gIEBJbnB1dCgpXG4gIGNsb3NlQnV0dG9uOiBib29sZWFuO1xuICBAT3V0cHV0KClcbiAgcHJpbWFyeUNsaWNrID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KClcbiAgc2Vjb25kYXJ5Q2xpY2sgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKVxuICBjbG9zZUNsaWNrID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHByaXZhdGUgbm9uTW9kYWxOb2RlczogTm9kZXNbXSA9IFtdO1xuXG4gIHByaXZhdGUgaW52b2tpbmdFbGVtZW50OiBIVE1MRWxlbWVudDtcblxuICBASG9zdExpc3RlbmVyKCdib2R5OmtleWRvd24uZXNjJywgWyckZXZlbnQnXSlcbiAgb25Fc2NLZXlkb3duSGFuZGxlcihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGlmICh0aGlzLnNob3cpIHtcbiAgICAgIHRoaXMuc2hvdyA9IGZhbHNlO1xuICAgICAgdGhpcy5jbG9zZUNsaWNrLmVtaXQoKTtcbiAgICB9XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1SZWY6IEVsZW1lbnRSZWYpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKCF0aGlzLnR5cGUpIHRoaXMudHlwZSA9IFNVUFBPUlRFRF9UWVBFU1swXTtcbiAgICBpZiAoIXRoaXMuaWQpXG4gICAgICB0aGlzLmlkID0gTWF0aC5yYW5kb20oKVxuICAgICAgICAudG9TdHJpbmcoMzYpXG4gICAgICAgIC5zdWJzdHJpbmcoMik7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuc2hvdz8uY3VycmVudFZhbHVlID09PSB0cnVlKSB7XG4gICAgICB0aGlzLmludm9raW5nRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICB0aGlzLmFwcGx5Rm9jdXNUcmFwSW5EaWFsb2coKTtcbiAgICB9IGVsc2UgaWYgKGNoYW5nZXMuc2hvdz8uY3VycmVudFZhbHVlID09PSBmYWxzZSkge1xuICAgICAgdGhpcy5yZW1vdmVGb2N1c1RyYXBGcm9tRGlhbG9nKCk7XG4gICAgICB0aGlzLmludm9raW5nRWxlbWVudD8uZm9jdXMoKTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgaWYgKHRoaXMuc2hvdykge1xuICAgICAgdGhpcy5hcHBseUZvY3VzVHJhcEluRGlhbG9nKCk7XG4gICAgfVxuICB9XG5cbiAgY2xvc2VCdXR0b25DbGljaygpIHtcbiAgICBpZiAoIXRoaXMuY2xvc2VCdXR0b24pIHJldHVybjtcbiAgICB0aGlzLmNsb3NlQ2xpY2suZW1pdCgpO1xuICB9XG4gIHByaW1hcnlCdXR0b25DbGljaygpIHtcbiAgICB0aGlzLnByaW1hcnlDbGljay5lbWl0KCk7XG4gIH1cbiAgc2Vjb25kYXJ5QnV0dG9uQ2xpY2soKSB7XG4gICAgdGhpcy5zZWNvbmRhcnlDbGljay5lbWl0KCk7XG4gIH1cblxuICBhcHBseUZvY3VzVHJhcEluRGlhbG9nKCkge1xuICAgIHRoaXMubm9uTW9kYWxOb2RlcyA9IFtdO1xuICAgIHRoaXMuZ2V0QWxsVGFiYmFibGVFbGVtZW50cygpLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICBpZiAoIXRoaXMuZWxlbVJlZi5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGVsZW1lbnQpKSB7XG4gICAgICAgIGNvbnN0IHByZXZUYWJJbmRleCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCd0YWJpbmRleCcpO1xuICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAnLTEnKTtcbiAgICAgICAgKGVsZW1lbnQgYXMgSFRNTEVsZW1lbnQpLnN0eWxlLm91dGxpbmUgPSAnbm9uZSc7XG4gICAgICAgIHRoaXMubm9uTW9kYWxOb2Rlcy5wdXNoKHsgZWxlbWVudDogZWxlbWVudCwgcHJldlRhYkluZGV4OiBwcmV2VGFiSW5kZXggfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICByZW1vdmVGb2N1c1RyYXBGcm9tRGlhbG9nKCkge1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5ub25Nb2RhbE5vZGVzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9uTW9kYWxOb2Rlc1tpXTtcbiAgICAgIGlmIChub2RlLnByZXZUYWJJbmRleCkge1xuICAgICAgICBub2RlLmVsZW1lbnQuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsIG5vZGUucHJldlRhYkluZGV4KTtcbiAgICAgICAgbm9kZS5wcmV2VGFiSW5kZXggPSBudWxsO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZS5lbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgndGFiaW5kZXgnKTtcbiAgICAgIH1cbiAgICAgIChub2RlLmVsZW1lbnQgYXMgSFRNTEVsZW1lbnQpLnN0eWxlLm91dGxpbmUgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0QWxsVGFiYmFibGVFbGVtZW50cygpOiBOb2RlTGlzdE9mPEVsZW1lbnQ+IHtcbiAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcbiAgICAgIGBib2R5XG4gICAgICAgIGFbaHJlZl06bm90KFt0YWJpbmRleD1cIi0xXCJdKSxcbiAgICAgICAgYXJlYVtocmVmXTpub3QoW3RhYmluZGV4PVwiLTFcIl0pLFxuICAgICAgICBpbnB1dDpub3QoW3RhYmluZGV4PVwiLTFcIl0pLFxuICAgICAgICBzZWxlY3Q6bm90KFt0YWJpbmRleD1cIi0xXCJdKSxcbiAgICAgICAgdGV4dGFyZWE6bm90KFt0YWJpbmRleD1cIi0xXCJdKSxcbiAgICAgICAgYnV0dG9uOm5vdChbdGFiaW5kZXg9XCItMVwiXSksXG4gICAgICAgIGlmcmFtZTpub3QoW3RhYmluZGV4PVwiLTFcIl0pLFxuICAgICAgICBvYmplY3Q6bm90KFt0YWJpbmRleD1cIi0xXCJdKSxcbiAgICAgICAgZW1iZWQ6bm90KFt0YWJpbmRleD1cIi0xXCJdKSxcbiAgICAgICAgW3RhYmluZGV4XTpub3QoW3RhYmluZGV4PVwiLTFcIl0pLFxuICAgICAgICBbY29udGVudGVkaXRhYmxlXTpub3QoW3RhYmluZGV4PVwiLTFcIl0pYFxuICAgICk7XG4gIH1cbn1cbiJdfQ==