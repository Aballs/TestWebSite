import { __decorate } from "tslib";
import { takeUntil } from 'rxjs/operators';
import { NavigationService } from './navigation.service';
import { Component, AfterContentInit, ContentChildren, QueryList, OnDestroy, Output, EventEmitter, Input, HostBinding, HostListener, ElementRef, ChangeDetectorRef } from '@angular/core';
import { NavigationMenuSubmenuItemComponent } from './navigation-menu-submenu-item.component';
import { NavigationMenuItemComponent } from './navigation-menu-item.component';
import { NavigationMenuSubmenuComponent } from './navigation-menu-submenu.component';
import { Subject } from 'rxjs';
let NavigationMenuComponent = class NavigationMenuComponent {
    constructor(elemRef, cdRef, _navService) {
        this.elemRef = elemRef;
        this.cdRef = cdRef;
        this._navService = _navService;
        this.onDestroy$ = new Subject();
        this._opened = false;
        /**
         * closes menu when user clicks outside (default = false)
         */
        this.closeOnClickOutside = false;
        this.itemSelectedEvent = new EventEmitter();
        this._navService.selectionChange.pipe(takeUntil(this.onDestroy$)).subscribe(item => {
            var _a;
            if (item instanceof NavigationMenuItemComponent) {
                this.itemSelectedEvent.emit(item);
                item.onMouseOut(null);
                this.opened = false;
            }
            else if (item instanceof NavigationMenuSubmenuItemComponent) {
                this.itemSelectedEvent.emit(item);
                (_a = this.items.find(navItem => navItem.popUp)) === null || _a === void 0 ? void 0 : _a.onMouseOut(null);
                this.opened = false;
            }
        });
    }
    set opened(value) {
        this._opened = value;
        this._navService.menuOpened.next(this._opened);
    }
    get opened() {
        return this._opened;
    }
    onFocusIn(event) {
        if (this.items.some(item => event.target === item.labelWrapper.nativeElement)) {
            this.items.forEach(item => {
                if (event.target === item.labelWrapper.nativeElement) {
                    item.onMouseOver();
                }
                else {
                    item.popUp = false;
                }
            });
        }
    }
    clickout(event) {
        if (this.closeOnClickOutside && !this.elemRef.nativeElement.contains(event.target) && this.opened) {
            this.opened = false;
        }
    }
    onKeydown(event) {
        const key = event.code || event.keyCode;
        switch (key) {
            case 'ArrowRight':
            case 39:
                if (!this.opened) {
                    this.focusIntoSubmenu(event.target);
                    this.expandAllSubmenus();
                    event.preventDefault();
                    event.stopPropagation();
                }
                break;
            case 'Enter':
            case 'NumpadEnter':
            case 13:
            case 'Space':
            case 32:
                if (event.target === this.elemRef.nativeElement.querySelector('i.arrow')) {
                    this.opened = !this.opened;
                }
                else {
                    this.clickMenuItem(this.items.find(item => item.labelWrapper.nativeElement === event.target));
                }
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'Escape':
            case 27:
                if (!this.opened) {
                    this.items.forEach(item => (item.popUp = false));
                    event.preventDefault();
                }
                else {
                    this.opened = false;
                }
                break;
            case 'Tab':
            case 9:
                const focusedItem = this.items.find(item => event.target === item.labelWrapper.nativeElement);
                if (focusedItem) {
                    focusedItem.popUp = false;
                }
                break;
        }
    }
    ngAfterContentInit() {
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
    }
    ngOnDestroy() {
        this.onDestroy$.next();
        this.onDestroy$.complete();
    }
    focusIntoSubmenu(target) {
        const focusedItem = this.items.find(item => target === item.labelWrapper.nativeElement);
        if (focusedItem && focusedItem.popUp) {
            focusedItem.setNextSubmenuItemAsFocused();
        }
    }
    clickMenuItem(menuItem) {
        if (menuItem) {
            menuItem.click(null);
            if (this.opened) {
                this.expandAllSubmenus();
            }
            else {
                menuItem.toggleSubmenuPopup();
            }
        }
    }
    expandAllSubmenus() {
        this.submenus.forEach(submenu => (submenu.opened = true));
    }
};
NavigationMenuComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ChangeDetectorRef },
    { type: NavigationService }
];
__decorate([
    ContentChildren(NavigationMenuSubmenuItemComponent, { descendants: true })
], NavigationMenuComponent.prototype, "submenuItems", void 0);
__decorate([
    ContentChildren(NavigationMenuSubmenuComponent, { descendants: true })
], NavigationMenuComponent.prototype, "submenus", void 0);
__decorate([
    ContentChildren(NavigationMenuItemComponent)
], NavigationMenuComponent.prototype, "items", void 0);
__decorate([
    HostBinding('attr.id'),
    Input()
], NavigationMenuComponent.prototype, "id", void 0);
__decorate([
    Input()
], NavigationMenuComponent.prototype, "opened", null);
__decorate([
    Input()
], NavigationMenuComponent.prototype, "closeOnClickOutside", void 0);
__decorate([
    Output()
], NavigationMenuComponent.prototype, "itemSelectedEvent", void 0);
__decorate([
    HostListener('focusin', ['$event'])
], NavigationMenuComponent.prototype, "onFocusIn", null);
__decorate([
    HostListener('document:click', ['$event'])
], NavigationMenuComponent.prototype, "clickout", null);
__decorate([
    HostListener('keydown', ['$event'])
], NavigationMenuComponent.prototype, "onKeydown", null);
NavigationMenuComponent = __decorate([
    Component({
        selector: 'bmw-navigation-menu',
        template: "<div class=\"navigation-menu-wrapper\" [ngClass]=\"opened ? 'opened' : ''\">\n  <i\n    [ngClass]=\"opened ? 'iwp-icon-gen_arrow_left' : 'iwp-icon-gen_arrow_right'\"\n    class=\"arrow\"\n    (click)=\"opened = !opened\"\n    tabindex=\"0\"\n  ></i>\n  <div class=\"navigation-content\">\n    <ng-content select=\"bmw-navigation-menu-item\"></ng-content>\n  </div>\n</div>\n",
        providers: [NavigationService],
        styles: [":host{display:inline-block;height:100%;position:relative;box-sizing:border-box}.navigation-menu-wrapper{display:inline-flex;position:relative;padding-top:var(--navigation-menu__default__padding-top);box-shadow:1px 0 0 0 var(--navigation-menu__default__border-right-color);height:100%;background-color:var(--navigation-menu__default__background-color);box-sizing:border-box}.navigation-menu-wrapper.opened{width:var(--navigation-menu__opened__width);z-index:var(--navigation-menu__z-index)}.navigation-menu-wrapper.opened .navigation-content{box-sizing:border-box;width:100%;overflow:hidden;overflow-y:auto}.navigation-menu-wrapper .arrow{font-size:var(--navigation-menu__icon__font-size);position:absolute;width:var(--navigation-menu__icon__font-size);cursor:pointer;padding:var(--navigation-menu__icon__padding);margin-top:var(--navigation-menu__icon__padding-top);top:0;right:var(--navigation-menu__icon__padding)}.navigation-menu-wrapper .arrow:focus{outline:solid 1px;outline-color:var(--color-bmw-highlight);outline-offset:-1px}::ng-deep .chevron{font-size:var(--navigation-menu__chevron__font-size);cursor:pointer}"]
    })
], NavigationMenuComponent);
export { NavigationMenuComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1tZW51LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BibXctZHMvY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbIm5hdmlnYXRpb24tbWVudS9uYXZpZ2F0aW9uLW1lbnUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQsT0FBTyxFQUNMLFNBQVMsRUFDVCxnQkFBZ0IsRUFDaEIsZUFBZSxFQUNmLFNBQVMsRUFDVCxTQUFTLEVBQ1QsTUFBTSxFQUNOLFlBQVksRUFDWixLQUFLLEVBQ0wsV0FBVyxFQUNYLFlBQVksRUFDWixVQUFVLEVBQ1YsaUJBQWlCLEVBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQzlGLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQy9FLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFRL0IsSUFBYSx1QkFBdUIsR0FBcEMsTUFBYSx1QkFBdUI7SUFzR2xDLFlBQW9CLE9BQW1CLEVBQVUsS0FBd0IsRUFBVSxXQUE4QjtRQUE3RixZQUFPLEdBQVAsT0FBTyxDQUFZO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBbUI7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBbUI7UUFyR3pHLGVBQVUsR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUMxQyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBcUJ4Qjs7V0FFRztRQUVILHdCQUFtQixHQUFHLEtBQUssQ0FBQztRQUc1QixzQkFBaUIsR0FBRyxJQUFJLFlBQVksRUFBb0UsQ0FBQztRQXlFdkcs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QUFFNUQ7SUFEQyxlQUFlLENBQUMsOEJBQThCLEVBQUUsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUM7eURBQ25CO0FBRXBEO0lBREMsZUFBZSxDQUFDLDJCQUEyQixDQUFDO3NEQUNDO0FBSTlDO0lBRkMsV0FBVyxDQUFDLFNBQVMsQ0FBQztJQUN0QixLQUFLLEVBQUU7bURBQ0c7QUFFWDtJQURDLEtBQUssRUFBRTtxREFJUDtBQVNEO0lBREMsS0FBSyxFQUFFO29FQUNvQjtBQUc1QjtJQURDLE1BQU0sRUFBRTtrRUFDZ0c7QUFHekc7SUFEQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7d0RBV25DO0FBR0Q7SUFEQyxZQUFZLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzt1REFLMUM7QUFHRDtJQURDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3REFnRG5DO0FBcEdVLHVCQUF1QjtJQU5uQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUscUJBQXFCO1FBQy9CLGtZQUErQztRQUUvQyxTQUFTLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQzs7S0FDL0IsQ0FBQztHQUNXLHVCQUF1QixDQXNKbkM7U0F0SlksdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTmF2aWdhdGlvblNlcnZpY2UgfSBmcm9tICcuL25hdmlnYXRpb24uc2VydmljZSc7XG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEFmdGVyQ29udGVudEluaXQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgUXVlcnlMaXN0LFxuICBPbkRlc3Ryb3ksXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgSG9zdEJpbmRpbmcsXG4gIEhvc3RMaXN0ZW5lcixcbiAgRWxlbWVudFJlZixcbiAgQ2hhbmdlRGV0ZWN0b3JSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uTWVudVN1Ym1lbnVJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi9uYXZpZ2F0aW9uLW1lbnUtc3VibWVudS1pdGVtLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uTWVudUl0ZW1Db21wb25lbnQgfSBmcm9tICcuL25hdmlnYXRpb24tbWVudS1pdGVtLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uTWVudVN1Ym1lbnVDb21wb25lbnQgfSBmcm9tICcuL25hdmlnYXRpb24tbWVudS1zdWJtZW51LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2Jtdy1uYXZpZ2F0aW9uLW1lbnUnLFxuICB0ZW1wbGF0ZVVybDogJy4vbmF2aWdhdGlvbi1tZW51LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbmF2aWdhdGlvbi1tZW51LmNvbXBvbmVudC5sZXNzJ10sXG4gIHByb3ZpZGVyczogW05hdmlnYXRpb25TZXJ2aWNlXVxufSlcbmV4cG9ydCBjbGFzcyBOYXZpZ2F0aW9uTWVudUNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyQ29udGVudEluaXQsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgb25EZXN0cm95JDogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0KCk7XG4gIHByaXZhdGUgX29wZW5lZCA9IGZhbHNlO1xuICBzZWxlY3RlZDogTmF2aWdhdGlvbk1lbnVJdGVtQ29tcG9uZW50O1xuICBAQ29udGVudENoaWxkcmVuKE5hdmlnYXRpb25NZW51U3VibWVudUl0ZW1Db21wb25lbnQsIHsgZGVzY2VuZGFudHM6IHRydWUgfSlcbiAgc3VibWVudUl0ZW1zOiBRdWVyeUxpc3Q8TmF2aWdhdGlvbk1lbnVTdWJtZW51SXRlbUNvbXBvbmVudD47XG4gIEBDb250ZW50Q2hpbGRyZW4oTmF2aWdhdGlvbk1lbnVTdWJtZW51Q29tcG9uZW50LCB7IGRlc2NlbmRhbnRzOiB0cnVlIH0pXG4gIHN1Ym1lbnVzOiBRdWVyeUxpc3Q8TmF2aWdhdGlvbk1lbnVTdWJtZW51Q29tcG9uZW50PjtcbiAgQENvbnRlbnRDaGlsZHJlbihOYXZpZ2F0aW9uTWVudUl0ZW1Db21wb25lbnQpXG4gIGl0ZW1zOiBRdWVyeUxpc3Q8TmF2aWdhdGlvbk1lbnVJdGVtQ29tcG9uZW50PjtcblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuaWQnKVxuICBASW5wdXQoKVxuICBpZDogc3RyaW5nO1xuICBASW5wdXQoKVxuICBzZXQgb3BlbmVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5fb3BlbmVkID0gdmFsdWU7XG4gICAgdGhpcy5fbmF2U2VydmljZS5tZW51T3BlbmVkLm5leHQodGhpcy5fb3BlbmVkKTtcbiAgfVxuICBnZXQgb3BlbmVkKCkge1xuICAgIHJldHVybiB0aGlzLl9vcGVuZWQ7XG4gIH1cblxuICAvKipcbiAgICogY2xvc2VzIG1lbnUgd2hlbiB1c2VyIGNsaWNrcyBvdXRzaWRlIChkZWZhdWx0ID0gZmFsc2UpXG4gICAqL1xuICBASW5wdXQoKVxuICBjbG9zZU9uQ2xpY2tPdXRzaWRlID0gZmFsc2U7XG5cbiAgQE91dHB1dCgpXG4gIGl0ZW1TZWxlY3RlZEV2ZW50ID0gbmV3IEV2ZW50RW1pdHRlcjxOYXZpZ2F0aW9uTWVudUl0ZW1Db21wb25lbnQgfCBOYXZpZ2F0aW9uTWVudVN1Ym1lbnVJdGVtQ29tcG9uZW50PigpO1xuXG4gIEBIb3N0TGlzdGVuZXIoJ2ZvY3VzaW4nLCBbJyRldmVudCddKVxuICBvbkZvY3VzSW4oZXZlbnQ6IEV2ZW50KSB7XG4gICAgaWYgKHRoaXMuaXRlbXMuc29tZShpdGVtID0+IGV2ZW50LnRhcmdldCA9PT0gaXRlbS5sYWJlbFdyYXBwZXIubmF0aXZlRWxlbWVudCkpIHtcbiAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gaXRlbS5sYWJlbFdyYXBwZXIubmF0aXZlRWxlbWVudCkge1xuICAgICAgICAgIGl0ZW0ub25Nb3VzZU92ZXIoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpdGVtLnBvcFVwID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmNsaWNrJywgWyckZXZlbnQnXSlcbiAgY2xpY2tvdXQoZXZlbnQpIHtcbiAgICBpZiAodGhpcy5jbG9zZU9uQ2xpY2tPdXRzaWRlICYmICF0aGlzLmVsZW1SZWYubmF0aXZlRWxlbWVudC5jb250YWlucyhldmVudC50YXJnZXQpICYmIHRoaXMub3BlbmVkKSB7XG4gICAgICB0aGlzLm9wZW5lZCA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxuICBvbktleWRvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBjb25zdCBrZXkgPSBldmVudC5jb2RlIHx8IGV2ZW50LmtleUNvZGU7XG5cbiAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgY2FzZSAnQXJyb3dSaWdodCc6XG4gICAgICBjYXNlIDM5OlxuICAgICAgICBpZiAoIXRoaXMub3BlbmVkKSB7XG4gICAgICAgICAgdGhpcy5mb2N1c0ludG9TdWJtZW51KGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgdGhpcy5leHBhbmRBbGxTdWJtZW51cygpO1xuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ0VudGVyJzpcbiAgICAgIGNhc2UgJ051bXBhZEVudGVyJzpcbiAgICAgIGNhc2UgMTM6XG4gICAgICBjYXNlICdTcGFjZSc6XG4gICAgICBjYXNlIDMyOlxuICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSB0aGlzLmVsZW1SZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdpLmFycm93JykpIHtcbiAgICAgICAgICB0aGlzLm9wZW5lZCA9ICF0aGlzLm9wZW5lZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmNsaWNrTWVudUl0ZW0odGhpcy5pdGVtcy5maW5kKGl0ZW0gPT4gaXRlbS5sYWJlbFdyYXBwZXIubmF0aXZlRWxlbWVudCA9PT0gZXZlbnQudGFyZ2V0KSk7XG4gICAgICAgIH1cblxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ0VzY2FwZSc6XG4gICAgICBjYXNlIDI3OlxuICAgICAgICBpZiAoIXRoaXMub3BlbmVkKSB7XG4gICAgICAgICAgdGhpcy5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4gKGl0ZW0ucG9wVXAgPSBmYWxzZSkpO1xuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnVGFiJzpcbiAgICAgIGNhc2UgOTpcbiAgICAgICAgY29uc3QgZm9jdXNlZEl0ZW0gPSB0aGlzLml0ZW1zLmZpbmQoaXRlbSA9PiBldmVudC50YXJnZXQgPT09IGl0ZW0ubGFiZWxXcmFwcGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICBpZiAoZm9jdXNlZEl0ZW0pIHtcbiAgICAgICAgICBmb2N1c2VkSXRlbS5wb3BVcCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbVJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsIHByaXZhdGUgX25hdlNlcnZpY2U6IE5hdmlnYXRpb25TZXJ2aWNlKSB7XG4gICAgdGhpcy5fbmF2U2VydmljZS5zZWxlY3Rpb25DaGFuZ2UucGlwZSh0YWtlVW50aWwodGhpcy5vbkRlc3Ryb3kkKSkuc3Vic2NyaWJlKGl0ZW0gPT4ge1xuICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBOYXZpZ2F0aW9uTWVudUl0ZW1Db21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5pdGVtU2VsZWN0ZWRFdmVudC5lbWl0KGl0ZW0pO1xuICAgICAgICBpdGVtLm9uTW91c2VPdXQobnVsbCk7XG4gICAgICAgIHRoaXMub3BlbmVkID0gZmFsc2U7XG4gICAgICB9IGVsc2UgaWYgKGl0ZW0gaW5zdGFuY2VvZiBOYXZpZ2F0aW9uTWVudVN1Ym1lbnVJdGVtQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuaXRlbVNlbGVjdGVkRXZlbnQuZW1pdChpdGVtKTtcbiAgICAgICAgdGhpcy5pdGVtcy5maW5kKG5hdkl0ZW0gPT4gbmF2SXRlbS5wb3BVcCk/Lm9uTW91c2VPdXQobnVsbCk7XG4gICAgICAgIHRoaXMub3BlbmVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgaWYgKCF0aGlzLmlkKSB7XG4gICAgICB0aGlzLmlkID0gTWF0aC5yYW5kb20oKVxuICAgICAgICAudG9TdHJpbmcoMzYpXG4gICAgICAgIC5zdWJzdHJpbmcoMik7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5vbkRlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLm9uRGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIGZvY3VzSW50b1N1Ym1lbnUodGFyZ2V0OiBFdmVudFRhcmdldCkge1xuICAgIGNvbnN0IGZvY3VzZWRJdGVtID0gdGhpcy5pdGVtcy5maW5kKGl0ZW0gPT4gdGFyZ2V0ID09PSBpdGVtLmxhYmVsV3JhcHBlci5uYXRpdmVFbGVtZW50KTtcbiAgICBpZiAoZm9jdXNlZEl0ZW0gJiYgZm9jdXNlZEl0ZW0ucG9wVXApIHtcbiAgICAgIGZvY3VzZWRJdGVtLnNldE5leHRTdWJtZW51SXRlbUFzRm9jdXNlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGNsaWNrTWVudUl0ZW0obWVudUl0ZW06IE5hdmlnYXRpb25NZW51SXRlbUNvbXBvbmVudCkge1xuICAgIGlmIChtZW51SXRlbSkge1xuICAgICAgbWVudUl0ZW0uY2xpY2sobnVsbCk7XG4gICAgICBpZiAodGhpcy5vcGVuZWQpIHtcbiAgICAgICAgdGhpcy5leHBhbmRBbGxTdWJtZW51cygpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWVudUl0ZW0udG9nZ2xlU3VibWVudVBvcHVwKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZXhwYW5kQWxsU3VibWVudXMoKSB7XG4gICAgdGhpcy5zdWJtZW51cy5mb3JFYWNoKHN1Ym1lbnUgPT4gKHN1Ym1lbnUub3BlbmVkID0gdHJ1ZSkpO1xuICB9XG59XG4iXX0=