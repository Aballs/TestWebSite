import { __decorate } from "tslib";
import { takeUntil } from 'rxjs/operators';
import { NavigationService } from './navigation.service';
import { Component, OnInit, Input, QueryList, ElementRef, HostBinding, HostListener, ContentChild, ContentChildren, OnDestroy, NgZone, ViewChild } from '@angular/core';
import { NavigationMenuSubmenuComponent } from './navigation-menu-submenu.component';
import { NavigationMenuSubmenuItemComponent } from './navigation-menu-submenu-item.component';
import { Subject } from 'rxjs';
let NavigationMenuItemComponent = class NavigationMenuItemComponent {
    constructor(_el, _navService, _zone) {
        this._el = _el;
        this._navService = _navService;
        this._zone = _zone;
        this._selected = false;
        this._disabled = false;
        this._destroyed$ = new Subject();
        this.offsetTop = 0;
        this.subMenuItemSelected = false;
        this.selectedEvent = new Subject();
        this.expandSubmenu = false;
        this.popUp = false;
    }
    set disabled(value) {
        this._disabled = value;
        if (value)
            this._selected = false;
    }
    get disabled() {
        return this._disabled;
    }
    set selected(value) {
        if (this.disabled || value === this._selected)
            return;
        this._selected = value;
    }
    get selected() {
        return this._selected;
    }
    onMouseOver() {
        if (this.disabled)
            return;
        this.popUp = true;
        this.updatePopupPosition();
    }
    onMouseOut(event) {
        if (event && this._el.nativeElement.contains(event.relatedTarget)) {
            return;
        }
        this.popUp = false;
    }
    onKeydown(event) {
        const key = event.code || event.keyCode;
        switch (key) {
            case 'ArrowDown':
            case 40:
                if (this.popUp) {
                    this.setNextSubmenuItemAsFocused(event.target);
                    event.stopPropagation();
                    event.preventDefault();
                }
                break;
            case 'ArrowUp':
            case 38:
                if (this.popUp) {
                    this.setPreviousSubmenuItemAsFocused(event.target);
                    event.stopPropagation();
                    event.preventDefault();
                }
                break;
            case 'ArrowLeft':
            case 37:
                if (this.popUp) {
                    this.labelWrapper.nativeElement.focus();
                    this.onMouseOver();
                    event.preventDefault();
                    event.stopPropagation();
                }
                break;
        }
    }
    ngOnInit() {
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
        this._navService.selectionChange.pipe(takeUntil(this._destroyed$)).subscribe(item => {
            if (item !== this) {
                this.selected = false;
            }
            this.subMenuItemSelected = !!this.submenuItems.find(i => i === item);
        });
        this._navService.menuOpened.pipe(takeUntil(this._destroyed$)).subscribe(open => {
            this.menuIsOpened = open;
        });
    }
    updatePopupPosition() {
        const rect = this._el.nativeElement.getBoundingClientRect();
        const parentRect = this._el.nativeElement.offsetParent.getBoundingClientRect();
        this.offsetTop = rect.top - parentRect.top;
    }
    ngOnDestroy() {
        this._destroyed$.next();
        this._destroyed$.complete();
    }
    click($event) {
        $event === null || $event === void 0 ? void 0 : $event.stopPropagation();
        if (this.disabled || this.selected)
            return;
        if (this.submenu) {
            this.expandSubmenu = !this.expandSubmenu;
        }
        else {
            this._selected = true;
            this.selectedEvent.next(this);
            this._navService.selectItem(this);
        }
    }
    toggleSubmenuPopup() {
        if (this.popUp) {
            this.onMouseOut(null);
        }
        else {
            this.onMouseOver();
        }
    }
    setPreviousSubmenuItemAsFocused(target) {
        if (this.submenuItems.length > 0 && this.submenuItems.some(item => !item.disabled)) {
            const submenuItemsArray = this.submenuItems.toArray();
            let focusedItemIndex = -1;
            if (target) {
                focusedItemIndex = submenuItemsArray.findIndex(item => item.submenuItemWrapper.nativeElement === target);
            }
            else {
                focusedItemIndex = submenuItemsArray.findIndex(item => item.submenuItemWrapper.nativeElement === document.activeElement);
            }
            if (focusedItemIndex !== -1 && focusedItemIndex !== 0) {
                focusedItemIndex = focusedItemIndex - 1;
            }
            else {
                focusedItemIndex = submenuItemsArray.length - 1;
            }
            if (submenuItemsArray[focusedItemIndex].disabled) {
                this.setNextSubmenuItemAsFocused(submenuItemsArray[focusedItemIndex].submenuItemWrapper.nativeElement);
            }
            else {
                submenuItemsArray[focusedItemIndex].submenuItemWrapper.nativeElement.focus();
            }
        }
    }
    setNextSubmenuItemAsFocused(target) {
        if (this.submenuItems.length > 0 && this.submenuItems.some(item => !item.disabled)) {
            const submenuItemsArray = this.submenuItems.toArray();
            let focusedItemIndex = -1;
            if (target) {
                focusedItemIndex = submenuItemsArray.findIndex(item => item.submenuItemWrapper.nativeElement === target);
            }
            else {
                focusedItemIndex = submenuItemsArray.findIndex(item => item.submenuItemWrapper.nativeElement === document.activeElement);
            }
            if (focusedItemIndex !== -1 && focusedItemIndex !== submenuItemsArray.length - 1) {
                focusedItemIndex = focusedItemIndex + 1;
            }
            else {
                focusedItemIndex = 0;
            }
            if (submenuItemsArray[focusedItemIndex].disabled) {
                this.setNextSubmenuItemAsFocused(submenuItemsArray[focusedItemIndex].submenuItemWrapper.nativeElement);
            }
            else {
                submenuItemsArray[focusedItemIndex].submenuItemWrapper.nativeElement.focus();
            }
        }
    }
};
NavigationMenuItemComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: NavigationService },
    { type: NgZone }
];
__decorate([
    Input()
], NavigationMenuItemComponent.prototype, "menuIsOpened", void 0);
__decorate([
    ContentChild(NavigationMenuSubmenuComponent)
], NavigationMenuItemComponent.prototype, "submenu", void 0);
__decorate([
    ContentChildren(NavigationMenuSubmenuItemComponent, { descendants: true })
], NavigationMenuItemComponent.prototype, "submenuItems", void 0);
__decorate([
    Input()
], NavigationMenuItemComponent.prototype, "icon", void 0);
__decorate([
    Input()
], NavigationMenuItemComponent.prototype, "label", void 0);
__decorate([
    Input()
], NavigationMenuItemComponent.prototype, "disabled", null);
__decorate([
    Input()
], NavigationMenuItemComponent.prototype, "selected", null);
__decorate([
    HostBinding('attr.id'),
    Input()
], NavigationMenuItemComponent.prototype, "id", void 0);
__decorate([
    ViewChild('labelWrapper')
], NavigationMenuItemComponent.prototype, "labelWrapper", void 0);
__decorate([
    HostListener('mouseover', [])
], NavigationMenuItemComponent.prototype, "onMouseOver", null);
__decorate([
    HostListener('mouseout', ['$event'])
], NavigationMenuItemComponent.prototype, "onMouseOut", null);
__decorate([
    HostListener('keydown', ['$event'])
], NavigationMenuItemComponent.prototype, "onKeydown", null);
NavigationMenuItemComponent = __decorate([
    Component({
        selector: 'bmw-navigation-menu-item',
        template: "<div\n  class=\"navigation-menu-item-wrapper bmw-component-text\"\n  [ngClass]=\"{\n    hover: popUp,\n    disabled: disabled,\n    selected: !submenu && selected,\n    submenu: submenu,\n    'submenu-selected': subMenuItemSelected,\n    'menu-closed': !menuIsOpened\n  }\"\n  [attr.aria-disabled]=\"disabled\"\n  (click)=\"click($event)\"\n>\n  <div #labelWrapper class=\"label-wrapper\" [tabindex]=\"disabled ? -1 : 0\">\n    <div class=\"menu-item-label\">\n      <i class=\"menu-item-icon\" [ngClass]=\"icon\"> </i>\n      <div class=\"menu-item-label-text\">\n        <span>{{ label }}</span>\n        <i\n          class=\"chevron\"\n          [ngClass]=\"expandSubmenu ? 'iwp-icon-gen_nav_arrow_up' : 'iwp-icon-gen_nav_arrow_down'\"\n          *ngIf=\"submenu\"\n        ></i>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"submenu-wrapper\" *ngIf=\"menuIsOpened && expandSubmenu\">\n    <div class=\"submenu-outlet\">\n      <ng-container *ngTemplateOutlet=\"tempOutlet\"></ng-container>\n    </div>\n  </div>\n\n  <div class=\"pop-up bmw-component-text\" *ngIf=\"!menuIsOpened && popUp\" [style.top.px]=\"offsetTop\">\n    <div class=\"item-label\" [class.has-submenu]=\"submenu\">\n      <span>{{ label }}</span>\n      <i class=\"chevron\" [ngClass]=\"'iwp-icon-gen_nav_arrow_up'\" *ngIf=\"submenu\"></i>\n    </div>\n    <div class=\"item-content\">\n      <ng-container *ngTemplateOutlet=\"tempOutlet\"></ng-container>\n    </div>\n  </div>\n</div>\n\n<ng-template #tempOutlet>\n  <ng-content></ng-content>\n</ng-template>\n",
        styles: ["::ng-deep .navigation-menu-wrapper .menu-item-label-text{display:none}::ng-deep .navigation-menu-wrapper.opened .menu-item-label-text{display:flex}::ng-deep .navigation-menu-wrapper.opened .pop-up{display:none}::ng-deep .pop-up .navigation-submenu-wrapper .submenu-item-wrapper,::ng-deep .pop-up .navigation-submenu-wrapper .submenu-label{padding-left:calc(1rem + 1rem);padding-left:calc(var(--navigation-menu__item__padding-left) + var(--navigation-menu__popup__submenu-item__padding-left))}::ng-deep .pop-up .navigation-submenu-wrapper.second-level .submenu-item-wrapper{padding-left:calc(var(--navigation-menu__item__padding-left) + var(--navigation-menu__popup__submenu-item__padding-left) + var(--navigation-menu__submenu-item__second-level__padding-left))}::ng-deep .pop-up .navigation-submenu-wrapper:focus{background-color:var(--navigation-menu__hover__background-color);outline:0}.menu-item-label{display:flex;align-items:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;padding:var(--navigation-menu__icon__padding)}.selected .menu-item-label{color:var(--navigation-menu__selected__color)}.menu-item-label .menu-item-label-text{padding-left:var(--navigation-menu__item__padding-left);align-items:center;justify-content:space-between;overflow:hidden;flex:1 0 0%;text-overflow:ellipsis}.menu-item-label .menu-item-label-text span{overflow:hidden;text-overflow:ellipsis}.disabled .menu-item-label{opacity:.5;cursor:no-drop}.disabled .menu-item-label *{cursor:no-drop}.navigation-menu-item-wrapper{color:var(--navigation-menu__default__color)}.navigation-menu-item-wrapper .menu-item-icon{font-size:var(--navigation-menu__icon__font-size);cursor:pointer}.navigation-menu-item-wrapper .label-wrapper:focus,.navigation-menu-item-wrapper .label-wrapper:hover,.navigation-menu-item-wrapper:not(.selected) .item-label:hover{background-color:var(--navigation-menu__hover__background-color);outline:0}.navigation-menu-item-wrapper .label-wrapper{padding:var(--navigation-menu__icon__padding)}.navigation-menu-item-wrapper.menu-closed.submenu-selected .label-wrapper{background-color:var(--navigation-menu__selected__background-color);color:var(--navigation-menu__selected__color)}.navigation-menu-item-wrapper.menu-closed.submenu-selected .label-wrapper:focus{outline:solid 1px;outline-color:var(--color-bmw-basic5);outline-offset:-3px}.navigation-menu-item-wrapper.selected{color:var(--navigation-menu__selected__color)}.navigation-menu-item-wrapper.selected .label-wrapper{background-color:var(--navigation-menu__selected__background-color)}.navigation-menu-item-wrapper.selected .pop-up{color:var(--navigation-menu__selected__color);background-color:var(--navigation-menu__selected__background-color)}.navigation-menu-item-wrapper.disabled .label-wrapper{opacity:.5}.opened-label{display:none}.pop-up{position:absolute;top:0;z-index:var(--navigation-menu__z-index___popup);left:100%;width:calc(var(--navigation-menu__opened__width) - var(--navigation-menu__icon__font-size) - 2 * var(--navigation-menu__icon__padding));border:1px solid var(--navigation-menu__default__border-right-color);background-color:var(--navigation-menu__item__background-color)}.pop-up .item-label{display:flex;align-items:center;justify-content:space-between;line-height:var(--navigation-menu__icon__font-size);padding:calc(var(--navigation-menu__icon__padding) * 2 - 1px);padding-left:var(--navigation-menu__item__padding-left);cursor:pointer}.pop-up .item-label.has-submenu,.pop-up .item-label.has-submenu .chevron{cursor:default}.pop-up .item-label span{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.pop-up .item-content{background-color:var(--navigation-menu__default__submenu__background-color)}:host{display:block}"]
    })
], NavigationMenuItemComponent);
export { NavigationMenuItemComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1tZW51LWl0ZW0uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGJtdy1kcy9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsibmF2aWdhdGlvbi1tZW51L25hdmlnYXRpb24tbWVudS1pdGVtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFDTCxTQUFTLEVBQ1QsTUFBTSxFQUNOLEtBQUssRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFdBQVcsRUFDWCxZQUFZLEVBQ1osWUFBWSxFQUNaLGVBQWUsRUFDZixTQUFTLEVBQ1QsTUFBTSxFQUNOLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNyRixPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUM5RixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBTy9CLElBQWEsMkJBQTJCLEdBQXhDLE1BQWEsMkJBQTJCO0lBNkZ0QyxZQUFvQixHQUFlLEVBQVUsV0FBOEIsRUFBVSxLQUFhO1FBQTlFLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBbUI7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFRO1FBNUYxRixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLGNBQVMsR0FBRyxLQUFLLENBQUM7UUFDbEIsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3BDLGNBQVMsR0FBRyxDQUFDLENBQUM7UUFFZCx3QkFBbUIsR0FBRyxLQUFLLENBQUM7UUFDNUIsa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBK0IsQ0FBQztRQUMzRCxrQkFBYSxH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QjtRQUNwQyxvaERBQW9EOztLQUVyRCxDQUFDO0dBQ1csMkJBQTJCLENBaU12QztTQWpNWSwyQkFBMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uU2VydmljZSB9IGZyb20gJy4vbmF2aWdhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgT25Jbml0LFxuICBJbnB1dCxcbiAgUXVlcnlMaXN0LFxuICBFbGVtZW50UmVmLFxuICBIb3N0QmluZGluZyxcbiAgSG9zdExpc3RlbmVyLFxuICBDb250ZW50Q2hpbGQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgT25EZXN0cm95LFxuICBOZ1pvbmUsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5hdmlnYXRpb25NZW51U3VibWVudUNvbXBvbmVudCB9IGZyb20gJy4vbmF2aWdhdGlvbi1tZW51LXN1Ym1lbnUuY29tcG9uZW50JztcbmltcG9ydCB7IE5hdmlnYXRpb25NZW51U3VibWVudUl0ZW1Db21wb25lbnQgfSBmcm9tICcuL25hdmlnYXRpb24tbWVudS1zdWJtZW51LWl0ZW0uY29tcG9uZW50JztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYm13LW5hdmlnYXRpb24tbWVudS1pdGVtJyxcbiAgdGVtcGxhdGVVcmw6ICcuL25hdmlnYXRpb24tbWVudS1pdGVtLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbmF2aWdhdGlvbi1tZW51LWl0ZW0uY29tcG9uZW50Lmxlc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBOYXZpZ2F0aW9uTWVudUl0ZW1Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgX3NlbGVjdGVkID0gZmFsc2U7XG4gIHByaXZhdGUgX2Rpc2FibGVkID0gZmFsc2U7XG4gIHByaXZhdGUgX2Rlc3Ryb3llZCQgPSBuZXcgU3ViamVjdCgpO1xuICBvZmZzZXRUb3AgPSAwO1xuXG4gIHN1Yk1lbnVJdGVtU2VsZWN0ZWQgPSBmYWxzZTtcbiAgc2VsZWN0ZWRFdmVudCA9IG5ldyBTdWJqZWN0PE5hdmlnYXRpb25NZW51SXRlbUNvbXBvbmVudD4oKTtcbiAgZXhwYW5kU3VibWVudSA9IGZhbHNlO1xuICBwb3BVcCA9IGZhbHNlO1xuICBASW5wdXQoKVxuICBtZW51SXNPcGVuZWQ6IGJvb2xlYW47XG4gIEBDb250ZW50Q2hpbGQoTmF2aWdhdGlvbk1lbnVTdWJtZW51Q29tcG9uZW50KVxuICBzdWJtZW51OiBOYXZpZ2F0aW9uTWVudVN1Ym1lbnVDb21wb25lbnQ7XG4gIEBDb250ZW50Q2hpbGRyZW4oTmF2aWdhdGlvbk1lbnVTdWJtZW51SXRlbUNvbXBvbmVudCwgeyBkZXNjZW5kYW50czogdHJ1ZSB9KVxuICBzdWJtZW51SXRlbXM6IFF1ZXJ5TGlzdDxOYXZpZ2F0aW9uTWVudVN1Ym1lbnVJdGVtQ29tcG9uZW50PjtcbiAgQElucHV0KClcbiAgaWNvbjogc3RyaW5nO1xuICBASW5wdXQoKVxuICBsYWJlbDogc3RyaW5nO1xuICBASW5wdXQoKVxuICBzZXQgZGlzYWJsZWQodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9kaXNhYmxlZCA9IHZhbHVlO1xuICAgIGlmICh2YWx1ZSkgdGhpcy5fc2VsZWN0ZWQgPSBmYWxzZTtcbiAgfVxuICBnZXQgZGlzYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2Rpc2FibGVkO1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCBzZWxlY3RlZCh2YWx1ZTogYm9vbGVhbikge1xuICAgIGlmICh0aGlzLmRpc2FibGVkIHx8IHZhbHVlID09PSB0aGlzLl9zZWxlY3RlZCkgcmV0dXJuO1xuXG4gICAgdGhpcy5fc2VsZWN0ZWQgPSB2YWx1ZTtcbiAgfVxuICBnZXQgc2VsZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkO1xuICB9XG4gIEBIb3N0QmluZGluZygnYXR0ci5pZCcpXG4gIEBJbnB1dCgpXG4gIGlkOiBzdHJpbmc7XG5cbiAgQFZpZXdDaGlsZCgnbGFiZWxXcmFwcGVyJylcbiAgbGFiZWxXcmFwcGVyOiBFbGVtZW50UmVmO1xuXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlb3ZlcicsIFtdKVxuICBvbk1vdXNlT3ZlcigpIHtcbiAgICBpZiAodGhpcy5kaXNhYmxlZCkgcmV0dXJuO1xuICAgIHRoaXMucG9wVXAgPSB0cnVlO1xuICAgIHRoaXMudXBkYXRlUG9wdXBQb3NpdGlvbigpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignbW91c2VvdXQnLCBbJyRldmVudCddKVxuICBvbk1vdXNlT3V0KGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgaWYgKGV2ZW50ICYmIHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZXZlbnQucmVsYXRlZFRhcmdldCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5wb3BVcCA9IGZhbHNlO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIG9uS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGNvbnN0IGtleSA9IGV2ZW50LmNvZGUgfHwgZXZlbnQua2V5Q29kZTtcblxuICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICBjYXNlICdBcnJvd0Rvd24nOlxuICAgICAgY2FzZSA0MDpcbiAgICAgICAgaWYgKHRoaXMucG9wVXApIHtcbiAgICAgICAgICB0aGlzLnNldE5leHRTdWJtZW51SXRlbUFzRm9jdXNlZChldmVudC50YXJnZXQpO1xuICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdBcnJvd1VwJzpcbiAgICAgIGNhc2UgMzg6XG4gICAgICAgIGlmICh0aGlzLnBvcFVwKSB7XG4gICAgICAgICAgdGhpcy5zZXRQcmV2aW91c1N1Ym1lbnVJdGVtQXNGb2N1c2VkKGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnQXJyb3dMZWZ0JzpcbiAgICAgIGNhc2UgMzc6XG4gICAgICAgIGlmICh0aGlzLnBvcFVwKSB7XG4gICAgICAgICAgdGhpcy5sYWJlbFdyYXBwZXIubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgICAgIHRoaXMub25Nb3VzZU92ZXIoKTtcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2VsOiBFbGVtZW50UmVmLCBwcml2YXRlIF9uYXZTZXJ2aWNlOiBOYXZpZ2F0aW9uU2VydmljZSwgcHJpdmF0ZSBfem9uZTogTmdab25lKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5pZCkge1xuICAgICAgdGhpcy5pZCA9IE1hdGgucmFuZG9tKClcbiAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAuc3Vic3RyaW5nKDIpO1xuICAgIH1cblxuICAgIHRoaXMuX25hdlNlcnZpY2Uuc2VsZWN0aW9uQ2hhbmdlLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpKS5zdWJzY3JpYmUoaXRlbSA9PiB7XG4gICAgICBpZiAoaXRlbSAhPT0gdGhpcykge1xuICAgICAgICB0aGlzLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICB0aGlzLnN1Yk1lbnVJdGVtU2VsZWN0ZWQgPSAhIXRoaXMuc3VibWVudUl0ZW1zLmZpbmQoaSA9PiBpID09PSBpdGVtKTtcbiAgICB9KTtcblxuICAgIHRoaXMuX25hdlNlcnZpY2UubWVudU9wZW5lZC5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKSkuc3Vic2NyaWJlKG9wZW4gPT4ge1xuICAgICAgdGhpcy5tZW51SXNPcGVuZWQgPSBvcGVuO1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlUG9wdXBQb3NpdGlvbigpIHtcbiAgICBjb25zdCByZWN0ID0gdGhpcy5fZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBwYXJlbnRSZWN0ID0gdGhpcy5fZWwubmF0aXZlRWxlbWVudC5vZmZzZXRQYXJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgdGhpcy5vZmZzZXRUb3AgPSByZWN0LnRvcCAtIHBhcmVudFJlY3QudG9wO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fZGVzdHJveWVkJC5uZXh0KCk7XG4gICAgdGhpcy5fZGVzdHJveWVkJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgY2xpY2soJGV2ZW50KSB7XG4gICAgJGV2ZW50Py5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICBpZiAodGhpcy5kaXNhYmxlZCB8fCB0aGlzLnNlbGVjdGVkKSByZXR1cm47XG4gICAgaWYgKHRoaXMuc3VibWVudSkge1xuICAgICAgdGhpcy5leHBhbmRTdWJtZW51ID0gIXRoaXMuZXhwYW5kU3VibWVudTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5zZWxlY3RlZEV2ZW50Lm5leHQodGhpcyk7XG4gICAgICB0aGlzLl9uYXZTZXJ2aWNlLnNlbGVjdEl0ZW0odGhpcyk7XG4gICAgfVxuICB9XG5cbiAgdG9nZ2xlU3VibWVudVBvcHVwKCkge1xuICAgIGlmICh0aGlzLnBvcFVwKSB7XG4gICAgICB0aGlzLm9uTW91c2VPdXQobnVsbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMub25Nb3VzZU92ZXIoKTtcbiAgICB9XG4gIH1cblxuICBzZXRQcmV2aW91c1N1Ym1lbnVJdGVtQXNGb2N1c2VkKHRhcmdldD86IEV2ZW50VGFyZ2V0KSB7XG4gICAgaWYgKHRoaXMuc3VibWVudUl0ZW1zLmxlbmd0aCA+IDAgJiYgdGhpcy5zdWJtZW51SXRlbXMuc29tZShpdGVtID0+ICFpdGVtLmRpc2FibGVkKSkge1xuICAgICAgY29uc3Qgc3VibWVudUl0ZW1zQXJyYXkgPSB0aGlzLnN1Ym1lbnVJdGVtcy50b0FycmF5KCk7XG4gICAgICBsZXQgZm9jdXNlZEl0ZW1JbmRleCA9IC0xO1xuICAgICAgaWYgKHRhcmdldCkge1xuICAgICAgICBmb2N1c2VkSXRlbUluZGV4ID0gc3VibWVudUl0ZW1zQXJyYXkuZmluZEluZGV4KGl0ZW0gPT4gaXRlbS5zdWJtZW51SXRlbVdyYXBwZXIubmF0aXZlRWxlbWVudCA9PT0gdGFyZ2V0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvY3VzZWRJdGVtSW5kZXggPSBzdWJtZW51SXRlbXNBcnJheS5maW5kSW5kZXgoXG4gICAgICAgICAgaXRlbSA9PiBpdGVtLnN1Ym1lbnVJdGVtV3JhcHBlci5uYXRpdmVFbGVtZW50ID09PSAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudClcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChmb2N1c2VkSXRlbUluZGV4ICE9PSAtMSAmJiBmb2N1c2VkSXRlbUluZGV4ICE9PSAwKSB7XG4gICAgICAgIGZvY3VzZWRJdGVtSW5kZXggPSBmb2N1c2VkSXRlbUluZGV4IC0gMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvY3VzZWRJdGVtSW5kZXggPSBzdWJtZW51SXRlbXNBcnJheS5sZW5ndGggLSAxO1xuICAgICAgfVxuXG4gICAgICBpZiAoc3VibWVudUl0ZW1zQXJyYXlbZm9jdXNlZEl0ZW1JbmRleF0uZGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5zZXROZXh0U3VibWVudUl0ZW1Bc0ZvY3VzZWQoc3VibWVudUl0ZW1zQXJyYXlbZm9jdXNlZEl0ZW1JbmRleF0uc3VibWVudUl0ZW1XcmFwcGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3VibWVudUl0ZW1zQXJyYXlbZm9jdXNlZEl0ZW1JbmRleF0uc3VibWVudUl0ZW1XcmFwcGVyLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXROZXh0U3VibWVudUl0ZW1Bc0ZvY3VzZWQodGFyZ2V0PzogRXZlbnRUYXJnZXQpIHtcbiAgICBpZiAodGhpcy5zdWJtZW51SXRlbXMubGVuZ3RoID4gMCAmJiB0aGlzLnN1Ym1lbnVJdGVtcy5zb21lKGl0ZW0gPT4gIWl0ZW0uZGlzYWJsZWQpKSB7XG4gICAgICBjb25zdCBzdWJtZW51SXRlbXNBcnJheSA9IHRoaXMuc3VibWVudUl0ZW1zLnRvQXJyYXkoKTtcbiAgICAgIGxldCBmb2N1c2VkSXRlbUluZGV4ID0gLTE7XG4gICAgICBpZiAodGFyZ2V0KSB7XG4gICAgICAgIGZvY3VzZWRJdGVtSW5kZXggPSBzdWJtZW51SXRlbXNBcnJheS5maW5kSW5kZXgoaXRlbSA9PiBpdGVtLnN1Ym1lbnVJdGVtV3JhcHBlci5uYXRpdmVFbGVtZW50ID09PSB0YXJnZXQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9jdXNlZEl0ZW1JbmRleCA9IHN1Ym1lbnVJdGVtc0FycmF5LmZpbmRJbmRleChcbiAgICAgICAgICBpdGVtID0+IGl0ZW0uc3VibWVudUl0ZW1XcmFwcGVyLm5hdGl2ZUVsZW1lbnQgPT09IChkb2N1bWVudC5hY3RpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50KVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGZvY3VzZWRJdGVtSW5kZXggIT09IC0xICYmIGZvY3VzZWRJdGVtSW5kZXggIT09IHN1Ym1lbnVJdGVtc0FycmF5Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgZm9jdXNlZEl0ZW1JbmRleCA9IGZvY3VzZWRJdGVtSW5kZXggKyAxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9jdXNlZEl0ZW1JbmRleCA9IDA7XG4gICAgICB9XG4gICAgICBpZiAoc3VibWVudUl0ZW1zQXJyYXlbZm9jdXNlZEl0ZW1JbmRleF0uZGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5zZXROZXh0U3VibWVudUl0ZW1Bc0ZvY3VzZWQoc3VibWVudUl0ZW1zQXJyYXlbZm9jdXNlZEl0ZW1JbmRleF0uc3VibWVudUl0ZW1XcmFwcGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3VibWVudUl0ZW1zQXJyYXlbZm9jdXNlZEl0ZW1JbmRleF0uc3VibWVudUl0ZW1XcmFwcGVyLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==