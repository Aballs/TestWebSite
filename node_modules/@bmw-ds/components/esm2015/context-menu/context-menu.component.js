import { __decorate, __param } from "tslib";
import { AfterContentInit, Component, ContentChild, ContentChildren, EventEmitter, forwardRef, HostBinding, Input, OnDestroy, OnInit, Optional, Output, QueryList, HostListener, ElementRef, ChangeDetectorRef, ViewChild } from '@angular/core';
import { Subject } from 'rxjs';
import { startWith, takeUntil } from 'rxjs/operators';
import { ContextMenuEventProviderService } from './context-menu-event-provider.service';
// Note that ContextMenuItemComponent and ContextMenuComponent are defined in the same file in order to avoid circular dependencies
let ContextMenuItemComponent = class ContextMenuItemComponent {
    constructor(elementRef, eventProviderService) {
        this.elementRef = elementRef;
        this.eventProviderService = eventProviderService;
        // emit the whole component, because this is only supposed to be used by within our own components, i.e.
        // between the item and the context-menu. the top-level context-menu will emit a more concise event for the user.
        this.selected = new EventEmitter();
        this.showSelected = false;
        this.itemClick = (event) => {
            if (this.eventProviderService) {
                this.eventProviderService.broadcastItemSelected(this);
            }
            this.selected.emit(this);
            if (this.subMenu) {
                this.subMenu.opened = true;
            }
            event === null || event === void 0 ? void 0 : event.stopPropagation();
        };
    }
    ngOnInit() {
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
    }
    ngAfterContentInit() {
        if (this.subMenu) {
            this.subMenu.isRootMenu = false;
            this.subMenu.closeEvent.subscribe(() => {
                this.wrapper.nativeElement.focus();
                this.unselectSubs();
            });
        }
    }
    unselectSubs() {
        this.isSelected = false;
        if (this.subMenu) {
            this.subMenu.toggle(false);
            this.subMenu.unselectSubs();
        }
    }
    ngOnDestroy() {
        var _a;
        (_a = this.subMenu) === null || _a === void 0 ? void 0 : _a.closeEvent.unsubscribe();
    }
};
ContextMenuItemComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ContextMenuEventProviderService, decorators: [{ type: Optional }] }
];
__decorate([
    Input()
], ContextMenuItemComponent.prototype, "disabled", void 0);
__decorate([
    Input()
], ContextMenuItemComponent.prototype, "icon", void 0);
__decorate([
    Input()
], ContextMenuItemComponent.prototype, "labelText", void 0);
__decorate([
    ViewChild('itemWrapper')
], ContextMenuItemComponent.prototype, "wrapper", void 0);
__decorate([
    Output()
], ContextMenuItemComponent.prototype, "selected", void 0);
__decorate([
    ContentChild(forwardRef(() => ContextMenuComponent))
], ContextMenuItemComponent.prototype, "subMenu", void 0);
__decorate([
    HostBinding('attr.id'),
    Input()
], ContextMenuItemComponent.prototype, "id", void 0);
ContextMenuItemComponent = __decorate([
    Component({
        selector: 'bmw-context-menu-item',
        template: "<div\n  #itemWrapper\n  class=\"wrapper\"\n  [class.disabled]=\"disabled\"\n  [class.selected]=\"showSelected && isSelected\"\n  [attr.aria-selected]=\"isSelected\"\n  [attr.aria-disabled]=\"disabled\"\n  tabindex=\"0\"\n>\n  <i *ngIf=\"icon\" [ngClass]=\"[icon, 'icon-left']\"></i>\n  <i *ngIf=\"subMenu\" class=\"iwp-icon-gen_arrow_right hasChild\"></i>\n  <div [class.disabled]=\"disabled\" [class.icon-left]=\"icon\" class=\"bmw-component-text\" (click)=\"itemClick($event)\">\n    {{ labelText }}\n  </div>\n  <div class=\"content-container\">\n    <ng-content></ng-content>\n  </div>\n</div>\n",
        styles: ["div.wrapper{max-height:calc(2 * var(--context-menu__default__padding) + 2 * var(--context-menu__default__line-height));position:relative;border:none;box-sizing:border-box;cursor:pointer;color:var(--context-menu__default__color);background-color:var(--context-menu__default__background-color);white-space:nowrap}div.wrapper:hover{background-color:var(--context-menu__default__hover__background-color)}div.wrapper:focus{background-color:var(--context-menu__default__hover__background-color);outline:solid 1px;outline-color:var(--color-bmw-highlight);z-index:calc(var(--context-menu__default__z-index) + 1)}div.wrapper.selected{background-color:var(--context-menu__default__selected__background-color);color:var(--context-menu__default__selected__color)}div.wrapper.selected:focus{outline:solid 1px;outline-color:var(--color-bmw-basic5);outline-offset:-3px;z-index:calc(var(--context-menu__default__z-index) + 1)}div.wrapper.disabled{background-color:var(--context-menu__default__disabled__background-color);color:var(--context-menu__default__disabled__color);pointer-events:none}div.wrapper div.bmw-component-text{width:100%;display:block;box-sizing:border-box;position:relative;overflow:hidden;padding:var(--context-menu__default__padding);color:inherit}:host[hasChild] div.wrapper div.bmw-component-text{padding-right:calc(var(--context-menu__default__padding) + var(--context-menu__default__font-size) + var(--context-menu__arrow__padding-right))}div.wrapper div.bmw-component-text.icon-left{padding-left:calc(var(--context-menu__default__padding) + var(--context-menu__default__font-size) + var(--context-menu__icon__padding-right))}div.wrapper i{height:var(--context-menu__default__font-size);width:var(--context-menu__default__font-size);top:calc(50% - var(--context-menu__default__font-size)/ 2);position:absolute;font-size:var(--context-menu__default__font-size)}div.wrapper i.icon-left{left:var(--context-menu__default__padding)}div.wrapper i.hasChild{right:var(--context-menu__arrow__padding-right)}div.wrapper i.hasChild+.bmw-component-text{padding-right:calc(var(--context-menu__default__padding) + var(--context-menu__default__font-size) + var(--context-menu__icon__padding-right))}@media all and (-ms-high-contrast:none),(-ms-high-contrast:active){:host[hasChild] div.wrapper div.bmw-component-text{padding-right:30px}div.wrapper div.bmw-component-text.icon-left{padding-left:30px}div.wrapper i.hasChild+.bmw-component-text{padding-right:30px}}div.wrapper .content-container{position:absolute;left:100%;top:-1px}:host[disabled]{cursor:no-drop}"]
    }),
    __param(1, Optional())
], ContextMenuItemComponent);
export { ContextMenuItemComponent };
// TODO idea for the future: optional close on click outside (i.e. add this as a convenience feature if menu-button is not used)
let ContextMenuComponent = class ContextMenuComponent {
    constructor(cdRef, elementRef) {
        this.cdRef = cdRef;
        this.elementRef = elementRef;
        this.closeOnClickOutside = true;
        this.closeOnSelected = true;
        // this is emitted in ngOnDestroy
        this._destroy = new Subject();
        /**
         * keeps the previously selected item highlited when reopening the menu (default = false)
         */
        this.keepItemSelected = false;
        /**
         * preserves the opened state of the menu after closing (default = false)
         */
        this.preserveState = false;
        this.isRootMenu = true;
        this.closeEvent = new EventEmitter();
    }
    set opened(state) {
        this.toggle(state);
    }
    get opened() {
        return this._opened;
    }
    onKeydown(event) {
        const key = event.code || event.keyCode;
        switch (key) {
            case 'ArrowDown':
            case 40:
                this.setNextItemAsFocused(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'ArrowUp':
            case 38:
                this.setPreviousItemAsFocused(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'ArrowLeft':
            case 37:
                this.closeSubmenu(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'ArrowRight':
            case 39:
                this.openSubmenu(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'Enter':
            case 'NumpadEnter':
            case 13:
            case 'Space':
            case 32:
                this.activateItem(event.target);
                event.preventDefault();
                event.stopPropagation();
                break;
            case 'Escape':
            case 27:
                if (this._opened) {
                    this.toggle(false);
                }
                event.preventDefault();
                break;
            case 'Tab':
            case 9:
                if (this._opened && this.closeOnClickOutside) {
                    this.toggle(false);
                }
                break;
        }
    }
    ngOnInit() {
        if (!this.id) {
            this.id = Math.random()
                .toString(36)
                .substring(2);
        }
    }
    ngAfterContentInit() {
        this.childContextMenuItems.changes
            .pipe(
        // tslint:disable-next-line:deprecation
        startWith(null), takeUntil(this._destroy))
            .subscribe(() => {
            this._register();
        });
        if (this.closeOnSelected) {
            this.childContextMenuItems.map((child) => {
                if (!child.subMenu) {
                    child.selected.pipe(takeUntil(this._destroy)).subscribe(() => {
                        this.toggle(!this.isRootMenu && this.preserveState);
                    });
                }
            });
        }
    }
    _register() {
        this.childContextMenuItems.forEach(item => {
            item.showSelected = this.keepItemSelected;
            item.selected.pipe(takeUntil(this._destroy)).subscribe(selectedItem => {
                this._select(selectedItem);
            });
        });
    }
    ngOnDestroy() {
        this._destroy.next();
        this._destroy.complete();
        document.removeEventListener('mouseup', this.clickOutsideCallback);
        document.removeEventListener('touchend', this.clickOutsideCallback);
    }
    _select(selectedItem) {
        this.childContextMenuItems.forEach(item => {
            if (item !== selectedItem)
                item.unselectSubs();
        });
        selectedItem.isSelected = true;
    }
    activateItem(target) {
        const focusedItem = this.childContextMenuItems.find(item => target === item.wrapper.nativeElement);
        if (focusedItem) {
            focusedItem.itemClick();
        }
    }
    closeSubmenu(target) {
        var _a;
        if (!this.isRootMenu) {
            const focusedItem = this.childContextMenuItems.find(item => target === item.wrapper.nativeElement);
            if (focusedItem && !((_a = focusedItem.subMenu) === null || _a === void 0 ? void 0 : _a.opened)) {
                target.blur();
                this.toggle(false);
            }
        }
    }
    openSubmenu(target) {
        const focusedItem = this.childContextMenuItems.find(item => target === item.wrapper.nativeElement);
        if (focusedItem && focusedItem.subMenu) {
            focusedItem.itemClick();
            target.blur();
            focusedItem.subMenu.setNextItemAsFocused();
        }
    }
    setPreviousItemAsFocused(target) {
        if (this._opened &&
            this.childContextMenuItems.length > 0 &&
            this.childContextMenuItems.filter(item => !item.disabled).length > 0) {
            const itemsArray = this.childContextMenuItems.toArray();
            let targetItemIndex = itemsArray.findIndex(item => target === item.wrapper.nativeElement);
            if (targetItemIndex !== -1) {
                itemsArray[targetItemIndex].wrapper.nativeElement.blur();
            }
            if (targetItemIndex > 0) {
                targetItemIndex = targetItemIndex - 1;
            }
            else {
                targetItemIndex = itemsArray.length - 1;
            }
            if (itemsArray[targetItemIndex].disabled) {
                this.setPreviousItemAsFocused(itemsArray[targetItemIndex].wrapper.nativeElement);
            }
            else {
                itemsArray[targetItemIndex].wrapper.nativeElement.focus();
            }
        }
    }
    setNextItemAsFocused(target) {
        if (this._opened &&
            this.childContextMenuItems.length > 0 &&
            this.childContextMenuItems.filter(item => !item.disabled).length > 0) {
            const itemsArray = this.childContextMenuItems.toArray();
            let targetItemIndex = itemsArray.findIndex(item => target === item.wrapper.nativeElement);
            if (targetItemIndex !== -1) {
                itemsArray[targetItemIndex].wrapper.nativeElement.blur();
            }
            if (targetItemIndex !== -1 && targetItemIndex !== itemsArray.length - 1) {
                targetItemIndex = targetItemIndex + 1;
            }
            else {
                targetItemIndex = 0;
            }
            if (itemsArray[targetItemIndex].disabled) {
                this.setNextItemAsFocused(itemsArray[targetItemIndex].wrapper.nativeElement);
            }
            else {
                this.cdRef.detectChanges();
                itemsArray[targetItemIndex].wrapper.nativeElement.focus();
            }
        }
    }
    unselectSubs() {
        this.childContextMenuItems.forEach(item => {
            item.unselectSubs();
        });
    }
    toggle(state) {
        let focusFirstItem = false;
        let emitCloseEvent = false;
        const initialOpenedState = this._opened;
        if (typeof state !== 'undefined') {
            focusFirstItem = !this._opened && state;
            emitCloseEvent = this._opened && !state;
            this._opened = state;
        }
        else {
            this._opened = !this._opened;
            focusFirstItem = this._opened;
            emitCloseEvent = !this._opened;
        }
        if (this.opened !== initialOpenedState) {
            if (this.opened && this.closeOnClickOutside) {
                setTimeout(() => {
                    /**
                     * .toggle public use will probably be triggered by a user click.
                     * Since the event will not be passed down, we can't use .preventDefault
                     * Thus, the new listener added below will catch the event immediately
                     * and prevent the context-menu from opening.
                     * Alternative would be to timestamp this call and verify on .onClickOutside
                     * but setTimeout(0) is a universally known hack
                     */
                    this.clickOutsideCallback = this.onClickOutside.bind(this);
                    document.addEventListener('mouseup', this.clickOutsideCallback);
                    document.addEventListener('touchend', this.clickOutsideCallback);
                }, 0);
            }
            else {
                document.removeEventListener('mouseup', this.clickOutsideCallback);
                document.removeEventListener('touchend', this.clickOutsideCallback);
            }
        }
        if (this.childContextMenuItems && focusFirstItem) {
            document.activeElement.blur();
            this.setNextItemAsFocused();
        }
        if (emitCloseEvent) {
            this.closeEvent.emit();
        }
    }
    onClickOutside({ target }) {
        var _a;
        const grandParent = this.elementRef.nativeElement.parentElement.parentElement;
        const parentIsWrapper = grandParent.localName === 'bmw-split-button' || grandParent.localName === 'bmw-menu-button';
        const elementToCheck = parentIsWrapper
            ? this.elementRef.nativeElement.parentElement
            : this.elementRef.nativeElement;
        if (!elementToCheck.contains(target) && !((_a = target.shadowRoot) === null || _a === void 0 ? void 0 : _a.querySelector('bmw-context-menu-item'))) {
            this.opened = this.preserveState;
            document.removeEventListener('mouseup', this.clickOutsideCallback);
            document.removeEventListener('touchend', this.clickOutsideCallback);
        }
    }
};
ContextMenuComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: ElementRef }
];
__decorate([
    ContentChildren(ContextMenuItemComponent)
], ContextMenuComponent.prototype, "childContextMenuItems", void 0);
__decorate([
    Input()
], ContextMenuComponent.prototype, "closeOnClickOutside", void 0);
__decorate([
    Input()
], ContextMenuComponent.prototype, "closeOnSelected", void 0);
__decorate([
    Input('opened')
], ContextMenuComponent.prototype, "opened", null);
__decorate([
    HostBinding('attr.id'),
    Input()
], ContextMenuComponent.prototype, "id", void 0);
__decorate([
    Input()
], ContextMenuComponent.prototype, "keepItemSelected", void 0);
__decorate([
    Input()
], ContextMenuComponent.prototype, "preserveState", void 0);
__decorate([
    Output()
], ContextMenuComponent.prototype, "closeEvent", void 0);
__decorate([
    HostListener('keydown', ['$event'])
], ContextMenuComponent.prototype, "onKeydown", null);
ContextMenuComponent = __decorate([
    Component({
        selector: 'bmw-context-menu',
        template: "<div class=\"bmw-context-menu\" [class.open]=\"opened\">\n  <ng-content></ng-content>\n</div>\n",
        styles: ["div{min-width:100px;box-sizing:border-box;border:solid 1px var(--context-menu__default_border-color);display:none;position:absolute;z-index:var(--context-menu__default__z-index)}div.open{display:block}div:focus{outline-style:none}"]
    })
], ContextMenuComponent);
export { ContextMenuComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BibXctZHMvY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvbnRleHQtbWVudS9jb250ZXh0LW1lbnUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFDVCxZQUFZLEVBQ1osZUFBZSxFQUNmLFlBQVksRUFDWixVQUFVLEVBQ1YsV0FBVyxFQUNYLEtBQUssRUFDTCxTQUFTLEVBQ1QsTUFBTSxFQUNOLFFBQVEsRUFDUixNQUFNLEVBQ04sU0FBUyxFQUNULFlBQVksRUFDWixVQUFVLEVBQ1YsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFFeEYsbUlBQW1JO0FBT25JLElBQWEsd0JBQXdCLEdBQXJDLE1BQWEsd0JBQXdCO0lBeUJuQyxZQUNTLFVBQXNCLEVBQ1Qsb0JBQXFEO1FBRGxFLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDVCx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQWlDO1FBZjNFLHdHQUF3RztRQUN4RyxpSEFBaUg7UUFFakgsYUFBUSxHQUEyQyxJQUFJLFlBQVksRUFBNEIsQ0FBQztRQVFoRyxpQkFBWSxHQUFHLEtBQUssQ0FBQztRQXlCckIsY0FBUyxHQUFHLENBQUMsS0FBa0IsRUFBRSxFQUFFO1lBQ2pDLElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO2dCQUM3QixJQUFJLENBQUMsb0JBQW9CLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDdkQ7WUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUks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RSxRQUFRLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1NBQ3JFO0lBQ0gsQ0FBQztDQUNGLENBQUE7O1lBdFE0QixpQkFBaUI7WUFBcUIsVUFBVTs7QUF0QzNFO0lBREMsZUFBZSxDQUFDLHdCQUF3QixDQUFDO21FQUNpQjtBQUkzRDtJQURDLEtBQUssRUFBRTtpRUFDbUI7QUFJM0I7SUFEQyxLQUFLLEVBQUU7NkRBQ2U7QUFHdkI7SUFEQyxLQUFLLENBQUMsUUFBUSxDQUFDO2tEQUdmO0FBT0Q7SUFGQyxXQUFXLENBQUMsU0FBUyxDQUFDO0lBQ3RCLEtBQUssRUFBRTtnREFDRztBQU9YO0lBREMsS0FBSyxFQUFFOzhEQUNpQjtBQUloQjtJQUFSLEtBQUssRUFBRTsyREFBdUI7QUFLL0I7SUFEQyxNQUFNLEVBQUU7d0RBQ3VEO0FBS2hFO0lBREMsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3FEQXlEbkM7QUFuR1Usb0JBQW9CO0lBTGhDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxrQkFBa0I7UUFDNUIsMkdBQTRDOztLQUU3QyxDQUFDO0dBQ1csb0JBQW9CLENBOFNoQztTQTlTWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBFdmVudEVtaXR0ZXIsXG4gIGZvcndhcmRSZWYsXG4gIEhvc3RCaW5kaW5nLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBPdXRwdXQsXG4gIFF1ZXJ5TGlzdCxcbiAgSG9zdExpc3RlbmVyLFxuICBFbGVtZW50UmVmLFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc3RhcnRXaXRoLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb250ZXh0TWVudUV2ZW50UHJvdmlkZXJTZXJ2aWNlIH0gZnJvbSAnLi9jb250ZXh0LW1lbnUtZXZlbnQtcHJvdmlkZXIuc2VydmljZSc7XG5cbi8vIE5vdGUgdGhhdCBDb250ZXh0TWVudUl0ZW1Db21wb25lbnQgYW5kIENvbnRleHRNZW51Q29tcG9uZW50IGFyZSBkZWZpbmVkIGluIHRoZSBzYW1lIGZpbGUgaW4gb3JkZXIgdG8gYXZvaWQgY2lyY3VsYXIgZGVwZW5kZW5jaWVzXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2Jtdy1jb250ZXh0LW1lbnUtaXRlbScsXG4gIHRlbXBsYXRlVXJsOiAnLi9jb250ZXh0LW1lbnUtaXRlbS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2NvbnRleHQtbWVudS1pdGVtLmNvbXBvbmVudC5sZXNzJ11cbn0pXG5leHBvcnQgY2xhc3MgQ29udGV4dE1lbnVJdGVtQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyQ29udGVudEluaXQge1xuICBpc1NlbGVjdGVkOiBib29sZWFuO1xuICBASW5wdXQoKVxuICBkaXNhYmxlZDogYm9vbGVhbjtcbiAgQElucHV0KClcbiAgaWNvbjogc3RyaW5nO1xuICBASW5wdXQoKVxuICBsYWJlbFRleHQ6IHN0cmluZztcblxuICBAVmlld0NoaWxkKCdpdGVtV3JhcHBlcicpXG4gIHdyYXBwZXI6IEVsZW1lbnRSZWY7XG5cbiAgLy8gZW1pdCB0aGUgd2hvbGUgY29tcG9uZW50LCBiZWNhdXNlIHRoaXMgaXMgb25seSBzdXBwb3NlZCB0byBiZSB1c2VkIGJ5IHdpdGhpbiBvdXIgb3duIGNvbXBvbmVudHMsIGkuZS5cbiAgLy8gYmV0d2VlbiB0aGUgaXRlbSBhbmQgdGhlIGNvbnRleHQtbWVudS4gdGhlIHRvcC1sZXZlbCBjb250ZXh0LW1lbnUgd2lsbCBlbWl0IGEgbW9yZSBjb25jaXNlIGV2ZW50IGZvciB0aGUgdXNlci5cbiAgQE91dHB1dCgpXG4gIHNlbGVjdGVkOiBFdmVudEVtaXR0ZXI8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50PiA9IG5ldyBFdmVudEVtaXR0ZXI8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50PigpO1xuICBAQ29udGVudENoaWxkKGZvcndhcmRSZWYoKCkgPT4gQ29udGV4dE1lbnVDb21wb25lbnQpKVxuICBzdWJNZW51OiBDb250ZXh0TWVudUNvbXBvbmVudDtcblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuaWQnKVxuICBASW5wdXQoKVxuICBpZDogc3RyaW5nO1xuXG4gIHNob3dTZWxlY3RlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZXZlbnRQcm92aWRlclNlcnZpY2U6IENvbnRleHRNZW51RXZlbnRQcm92aWRlclNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5pZCkge1xuICAgICAgdGhpcy5pZCA9IE1hdGgucmFuZG9tKClcbiAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAuc3Vic3RyaW5nKDIpO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICBpZiAodGhpcy5zdWJNZW51KSB7XG4gICAgICB0aGlzLnN1Yk1lbnUuaXNSb290TWVudSA9IGZhbHNlO1xuICAgICAgdGhpcy5zdWJNZW51LmNsb3NlRXZlbnQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdGhpcy53cmFwcGVyLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgICAgdGhpcy51bnNlbGVjdFN1YnMoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGl0ZW1DbGljayA9IChldmVudD86IE1vdXNlRXZlbnQpID0+IHtcbiAgICBpZiAodGhpcy5ldmVudFByb3ZpZGVyU2VydmljZSkge1xuICAgICAgdGhpcy5ldmVudFByb3ZpZGVyU2VydmljZS5icm9hZGNhc3RJdGVtU2VsZWN0ZWQodGhpcyk7XG4gICAgfVxuICAgIHRoaXMuc2VsZWN0ZWQuZW1pdCh0aGlzKTtcbiAgICBpZiAodGhpcy5zdWJNZW51KSB7XG4gICAgICB0aGlzLnN1Yk1lbnUub3BlbmVkID0gdHJ1ZTtcbiAgICB9XG4gICAgZXZlbnQ/LnN0b3BQcm9wYWdhdGlvbigpO1xuICB9O1xuXG4gIHVuc2VsZWN0U3VicygpIHtcbiAgICB0aGlzLmlzU2VsZWN0ZWQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5zdWJNZW51KSB7XG4gICAgICB0aGlzLnN1Yk1lbnUudG9nZ2xlKGZhbHNlKTtcbiAgICAgIHRoaXMuc3ViTWVudS51bnNlbGVjdFN1YnMoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnN1Yk1lbnU/LmNsb3NlRXZlbnQudW5zdWJzY3JpYmUoKTtcbiAgfVxufVxuXG4vLyBUT0RPIGlkZWEgZm9yIHRoZSBmdXR1cmU6IG9wdGlvbmFsIGNsb3NlIG9uIGNsaWNrIG91dHNpZGUgKGkuZS4gYWRkIHRoaXMgYXMgYSBjb252ZW5pZW5jZSBmZWF0dXJlIGlmIG1lbnUtYnV0dG9uIGlzIG5vdCB1c2VkKVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdibXctY29udGV4dC1tZW51JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2NvbnRleHQtbWVudS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2NvbnRleHQtbWVudS5jb21wb25lbnQubGVzcyddXG59KVxuZXhwb3J0IGNsYXNzIENvbnRleHRNZW51Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyQ29udGVudEluaXQge1xuICBAQ29udGVudENoaWxkcmVuKENvbnRleHRNZW51SXRlbUNvbXBvbmVudClcbiAgY2hpbGRDb250ZXh0TWVudUl0ZW1zOiBRdWVyeUxpc3Q8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50PjtcblxuICBwcml2YXRlIF9vcGVuZWQ6IGJvb2xlYW47XG4gIEBJbnB1dCgpXG4gIGNsb3NlT25DbGlja091dHNpZGUgPSB0cnVlO1xuICBjbGlja091dHNpZGVDYWxsYmFjazogKHRoaXM6IERvY3VtZW50LCBldjogTW91c2VFdmVudCkgPT4gYW55O1xuXG4gIEBJbnB1dCgpXG4gIGNsb3NlT25TZWxlY3RlZCA9IHRydWU7XG5cbiAgQElucHV0KCdvcGVuZWQnKVxuICBzZXQgb3BlbmVkKHN0YXRlOiBib29sZWFuKSB7XG4gICAgdGhpcy50b2dnbGUoc3RhdGUpO1xuICB9XG4gIGdldCBvcGVuZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX29wZW5lZDtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnYXR0ci5pZCcpXG4gIEBJbnB1dCgpXG4gIGlkOiBzdHJpbmc7XG4gIC8vIHRoaXMgaXMgZW1pdHRlZCBpbiBuZ09uRGVzdHJveVxuICBwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgLyoqXG4gICAqIGtlZXBzIHRoZSBwcmV2aW91c2x5IHNlbGVjdGVkIGl0ZW0gaGlnaGxpdGVkIHdoZW4gcmVvcGVuaW5nIHRoZSBtZW51IChkZWZhdWx0ID0gZmFsc2UpXG4gICAqL1xuICBASW5wdXQoKVxuICBrZWVwSXRlbVNlbGVjdGVkID0gZmFsc2U7XG4gIC8qKlxuICAgKiBwcmVzZXJ2ZXMgdGhlIG9wZW5lZCBzdGF0ZSBvZiB0aGUgbWVudSBhZnRlciBjbG9zaW5nIChkZWZhdWx0ID0gZmFsc2UpXG4gICAqL1xuICBASW5wdXQoKSBwcmVzZXJ2ZVN0YXRlID0gZmFsc2U7XG5cbiAgaXNSb290TWVudSA9IHRydWU7XG5cbiAgQE91dHB1dCgpXG4gIGNsb3NlRXZlbnQ6IEV2ZW50RW1pdHRlcjxib29sZWFuPiA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZiwgcHVibGljIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHt9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIG9uS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGNvbnN0IGtleSA9IGV2ZW50LmNvZGUgfHwgZXZlbnQua2V5Q29kZTtcbiAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgY2FzZSAnQXJyb3dEb3duJzpcbiAgICAgIGNhc2UgNDA6XG4gICAgICAgIHRoaXMuc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQoZXZlbnQudGFyZ2V0KTtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdBcnJvd1VwJzpcbiAgICAgIGNhc2UgMzg6XG4gICAgICAgIHRoaXMuc2V0UHJldmlvdXNJdGVtQXNGb2N1c2VkKGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnQXJyb3dMZWZ0JzpcbiAgICAgIGNhc2UgMzc6XG4gICAgICAgIHRoaXMuY2xvc2VTdWJtZW51KGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnQXJyb3dSaWdodCc6XG4gICAgICBjYXNlIDM5OlxuICAgICAgICB0aGlzLm9wZW5TdWJtZW51KGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnRW50ZXInOlxuICAgICAgY2FzZSAnTnVtcGFkRW50ZXInOlxuICAgICAgY2FzZSAxMzpcbiAgICAgIGNhc2UgJ1NwYWNlJzpcbiAgICAgIGNhc2UgMzI6XG4gICAgICAgIHRoaXMuYWN0aXZhdGVJdGVtKGV2ZW50LnRhcmdldCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnRXNjYXBlJzpcbiAgICAgIGNhc2UgMjc6XG4gICAgICAgIGlmICh0aGlzLl9vcGVuZWQpIHtcbiAgICAgICAgICB0aGlzLnRvZ2dsZShmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ1RhYic6XG4gICAgICBjYXNlIDk6XG4gICAgICAgIGlmICh0aGlzLl9vcGVuZWQgJiYgdGhpcy5jbG9zZU9uQ2xpY2tPdXRzaWRlKSB7XG4gICAgICAgICAgdGhpcy50b2dnbGUoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5pZCkge1xuICAgICAgdGhpcy5pZCA9IE1hdGgucmFuZG9tKClcbiAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAuc3Vic3RyaW5nKDIpO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICB0aGlzLmNoaWxkQ29udGV4dE1lbnVJdGVtcy5jaGFuZ2VzXG4gICAgICAucGlwZShcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmRlcHJlY2F0aW9uXG4gICAgICAgIHN0YXJ0V2l0aCg8Q29udGV4dE1lbnVJdGVtQ29tcG9uZW50Pm51bGwpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLl9yZWdpc3RlcigpO1xuICAgICAgfSk7XG5cbiAgICBpZiAodGhpcy5jbG9zZU9uU2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLm1hcCgoY2hpbGQ6IENvbnRleHRNZW51SXRlbUNvbXBvbmVudCkgPT4ge1xuICAgICAgICBpZiAoIWNoaWxkLnN1Yk1lbnUpIHtcbiAgICAgICAgICBjaGlsZC5zZWxlY3RlZC5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95KSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlKCF0aGlzLmlzUm9vdE1lbnUgJiYgdGhpcy5wcmVzZXJ2ZVN0YXRlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgX3JlZ2lzdGVyKCkge1xuICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpdGVtLnNob3dTZWxlY3RlZCA9IHRoaXMua2VlcEl0ZW1TZWxlY3RlZDtcblxuICAgICAgaXRlbS5zZWxlY3RlZC5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95KSkuc3Vic2NyaWJlKHNlbGVjdGVkSXRlbSA9PiB7XG4gICAgICAgIHRoaXMuX3NlbGVjdChzZWxlY3RlZEl0ZW0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl9kZXN0cm95Lm5leHQoKTtcbiAgICB0aGlzLl9kZXN0cm95LmNvbXBsZXRlKCk7XG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuY2xpY2tPdXRzaWRlQ2FsbGJhY2spO1xuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gIH1cblxuICBfc2VsZWN0KHNlbGVjdGVkSXRlbSkge1xuICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpZiAoaXRlbSAhPT0gc2VsZWN0ZWRJdGVtKSBpdGVtLnVuc2VsZWN0U3VicygpO1xuICAgIH0pO1xuXG4gICAgc2VsZWN0ZWRJdGVtLmlzU2VsZWN0ZWQgPSB0cnVlO1xuICB9XG5cbiAgYWN0aXZhdGVJdGVtKHRhcmdldDogRXZlbnRUYXJnZXQpIHtcbiAgICBjb25zdCBmb2N1c2VkSXRlbSA9IHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZpbmQoaXRlbSA9PiB0YXJnZXQgPT09IGl0ZW0ud3JhcHBlci5uYXRpdmVFbGVtZW50KTtcbiAgICBpZiAoZm9jdXNlZEl0ZW0pIHtcbiAgICAgIGZvY3VzZWRJdGVtLml0ZW1DbGljaygpO1xuICAgIH1cbiAgfVxuXG4gIGNsb3NlU3VibWVudSh0YXJnZXQ6IEV2ZW50VGFyZ2V0KSB7XG4gICAgaWYgKCF0aGlzLmlzUm9vdE1lbnUpIHtcbiAgICAgIGNvbnN0IGZvY3VzZWRJdGVtID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMuZmluZChpdGVtID0+IHRhcmdldCA9PT0gaXRlbS53cmFwcGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgaWYgKGZvY3VzZWRJdGVtICYmICFmb2N1c2VkSXRlbS5zdWJNZW51Py5vcGVuZWQpIHtcbiAgICAgICAgKHRhcmdldCBhcyBIVE1MRWxlbWVudCkuYmx1cigpO1xuICAgICAgICB0aGlzLnRvZ2dsZShmYWxzZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb3BlblN1Ym1lbnUodGFyZ2V0OiBFdmVudFRhcmdldCkge1xuICAgIGNvbnN0IGZvY3VzZWRJdGVtID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMuZmluZChpdGVtID0+IHRhcmdldCA9PT0gaXRlbS53cmFwcGVyLm5hdGl2ZUVsZW1lbnQpO1xuICAgIGlmIChmb2N1c2VkSXRlbSAmJiBmb2N1c2VkSXRlbS5zdWJNZW51KSB7XG4gICAgICBmb2N1c2VkSXRlbS5pdGVtQ2xpY2soKTtcbiAgICAgICh0YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmJsdXIoKTtcbiAgICAgIGZvY3VzZWRJdGVtLnN1Yk1lbnUuc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQoKTtcbiAgICB9XG4gIH1cblxuICBzZXRQcmV2aW91c0l0ZW1Bc0ZvY3VzZWQodGFyZ2V0PzogRXZlbnRUYXJnZXQpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLl9vcGVuZWQgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmxlbmd0aCA+IDAgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZpbHRlcihpdGVtID0+ICFpdGVtLmRpc2FibGVkKS5sZW5ndGggPiAwXG4gICAgKSB7XG4gICAgICBjb25zdCBpdGVtc0FycmF5ID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMudG9BcnJheSgpO1xuICAgICAgbGV0IHRhcmdldEl0ZW1JbmRleDogbnVtYmVyID0gaXRlbXNBcnJheS5maW5kSW5kZXgoaXRlbSA9PiB0YXJnZXQgPT09IGl0ZW0ud3JhcHBlci5uYXRpdmVFbGVtZW50KTtcblxuICAgICAgaWYgKHRhcmdldEl0ZW1JbmRleCAhPT0gLTEpIHtcbiAgICAgICAgaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudC5ibHVyKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0YXJnZXRJdGVtSW5kZXggPiAwKSB7XG4gICAgICAgIHRhcmdldEl0ZW1JbmRleCA9IHRhcmdldEl0ZW1JbmRleCAtIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0YXJnZXRJdGVtSW5kZXggPSBpdGVtc0FycmF5Lmxlbmd0aCAtIDE7XG4gICAgICB9XG5cbiAgICAgIGlmIChpdGVtc0FycmF5W3RhcmdldEl0ZW1JbmRleF0uZGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5zZXRQcmV2aW91c0l0ZW1Bc0ZvY3VzZWQoaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpdGVtc0FycmF5W3RhcmdldEl0ZW1JbmRleF0ud3JhcHBlci5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQodGFyZ2V0PzogRXZlbnRUYXJnZXQpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLl9vcGVuZWQgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmxlbmd0aCA+IDAgJiZcbiAgICAgIHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zLmZpbHRlcihpdGVtID0+ICFpdGVtLmRpc2FibGVkKS5sZW5ndGggPiAwXG4gICAgKSB7XG4gICAgICBjb25zdCBpdGVtc0FycmF5ID0gdGhpcy5jaGlsZENvbnRleHRNZW51SXRlbXMudG9BcnJheSgpO1xuICAgICAgbGV0IHRhcmdldEl0ZW1JbmRleDogbnVtYmVyID0gaXRlbXNBcnJheS5maW5kSW5kZXgoaXRlbSA9PiB0YXJnZXQgPT09IGl0ZW0ud3JhcHBlci5uYXRpdmVFbGVtZW50KTtcblxuICAgICAgaWYgKHRhcmdldEl0ZW1JbmRleCAhPT0gLTEpIHtcbiAgICAgICAgaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudC5ibHVyKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0YXJnZXRJdGVtSW5kZXggIT09IC0xICYmIHRhcmdldEl0ZW1JbmRleCAhPT0gaXRlbXNBcnJheS5sZW5ndGggLSAxKSB7XG4gICAgICAgIHRhcmdldEl0ZW1JbmRleCA9IHRhcmdldEl0ZW1JbmRleCArIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0YXJnZXRJdGVtSW5kZXggPSAwO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLmRpc2FibGVkKSB7XG4gICAgICAgIHRoaXMuc2V0TmV4dEl0ZW1Bc0ZvY3VzZWQoaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNkUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgaXRlbXNBcnJheVt0YXJnZXRJdGVtSW5kZXhdLndyYXBwZXIubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHVuc2VsZWN0U3VicygpIHtcbiAgICB0aGlzLmNoaWxkQ29udGV4dE1lbnVJdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbS51bnNlbGVjdFN1YnMoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHRvZ2dsZShzdGF0ZT86IGJvb2xlYW4pIHtcbiAgICBsZXQgZm9jdXNGaXJzdEl0ZW0gPSBmYWxzZTtcbiAgICBsZXQgZW1pdENsb3NlRXZlbnQgPSBmYWxzZTtcbiAgICBjb25zdCBpbml0aWFsT3BlbmVkU3RhdGUgPSB0aGlzLl9vcGVuZWQ7XG5cbiAgICBpZiAodHlwZW9mIHN0YXRlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgZm9jdXNGaXJzdEl0ZW0gPSAhdGhpcy5fb3BlbmVkICYmIHN0YXRlO1xuICAgICAgZW1pdENsb3NlRXZlbnQgPSB0aGlzLl9vcGVuZWQgJiYgIXN0YXRlO1xuICAgICAgdGhpcy5fb3BlbmVkID0gc3RhdGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX29wZW5lZCA9ICF0aGlzLl9vcGVuZWQ7XG4gICAgICBmb2N1c0ZpcnN0SXRlbSA9IHRoaXMuX29wZW5lZDtcbiAgICAgIGVtaXRDbG9zZUV2ZW50ID0gIXRoaXMuX29wZW5lZDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcGVuZWQgIT09IGluaXRpYWxPcGVuZWRTdGF0ZSkge1xuICAgICAgaWYgKHRoaXMub3BlbmVkICYmIHRoaXMuY2xvc2VPbkNsaWNrT3V0c2lkZSkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiAudG9nZ2xlIHB1YmxpYyB1c2Ugd2lsbCBwcm9iYWJseSBiZSB0cmlnZ2VyZWQgYnkgYSB1c2VyIGNsaWNrLlxuICAgICAgICAgICAqIFNpbmNlIHRoZSBldmVudCB3aWxsIG5vdCBiZSBwYXNzZWQgZG93biwgd2UgY2FuJ3QgdXNlIC5wcmV2ZW50RGVmYXVsdFxuICAgICAgICAgICAqIFRodXMsIHRoZSBuZXcgbGlzdGVuZXIgYWRkZWQgYmVsb3cgd2lsbCBjYXRjaCB0aGUgZXZlbnQgaW1tZWRpYXRlbHlcbiAgICAgICAgICAgKiBhbmQgcHJldmVudCB0aGUgY29udGV4dC1tZW51IGZyb20gb3BlbmluZy5cbiAgICAgICAgICAgKiBBbHRlcm5hdGl2ZSB3b3VsZCBiZSB0byB0aW1lc3RhbXAgdGhpcyBjYWxsIGFuZCB2ZXJpZnkgb24gLm9uQ2xpY2tPdXRzaWRlXG4gICAgICAgICAgICogYnV0IHNldFRpbWVvdXQoMCkgaXMgYSB1bml2ZXJzYWxseSBrbm93biBoYWNrXG4gICAgICAgICAgICovXG4gICAgICAgICAgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayA9IHRoaXMub25DbGlja091dHNpZGUuYmluZCh0aGlzKTtcbiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLmNsaWNrT3V0c2lkZUNhbGxiYWNrKTtcbiAgICAgICAgfSwgMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5jbGlja091dHNpZGVDYWxsYmFjayk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY2hpbGRDb250ZXh0TWVudUl0ZW1zICYmIGZvY3VzRmlyc3RJdGVtKSB7XG4gICAgICAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudCkuYmx1cigpO1xuICAgICAgdGhpcy5zZXROZXh0SXRlbUFzRm9jdXNlZCgpO1xuICAgIH1cblxuICAgIGlmIChlbWl0Q2xvc2VFdmVudCkge1xuICAgICAgdGhpcy5jbG9zZUV2ZW50LmVtaXQoKTtcbiAgICB9XG4gIH1cblxuICBvbkNsaWNrT3V0c2lkZSh7IHRhcmdldCB9KSB7XG4gICAgY29uc3QgZ3JhbmRQYXJlbnQgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgY29uc3QgcGFyZW50SXNXcmFwcGVyID0gZ3JhbmRQYXJlbnQubG9jYWxOYW1lID09PSAnYm13LXNwbGl0LWJ1dHRvbicgfHwgZ3JhbmRQYXJlbnQubG9jYWxOYW1lID09PSAnYm13LW1lbnUtYnV0dG9uJztcbiAgICBjb25zdCBlbGVtZW50VG9DaGVjayA9IHBhcmVudElzV3JhcHBlclxuICAgICAgPyB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50XG4gICAgICA6IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuXG4gICAgaWYgKCFlbGVtZW50VG9DaGVjay5jb250YWlucyh0YXJnZXQpICYmICF0YXJnZXQuc2hhZG93Um9vdD8ucXVlcnlTZWxlY3RvcignYm13LWNvbnRleHQtbWVudS1pdGVtJykpIHtcbiAgICAgIHRoaXMub3BlbmVkID0gdGhpcy5wcmVzZXJ2ZVN0YXRlO1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuY2xpY2tPdXRzaWRlQ2FsbGJhY2spO1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLmNsaWNrT3V0c2lkZUNhbGxiYWNrKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==